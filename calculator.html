<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">ARISE Score 预后评估 - HeartValve 专家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .tab-button.active {
            @apply bg-white text-slate-950 border-slate-300 shadow-sm;
        }
        .tab-button {
            @apply py-2 px-4 text-sm font-semibold text-slate-600 bg-slate-50 hover:bg-slate-200 border border-transparent rounded-t-lg transition-colors;
        }
        .tab-content {
            @apply p-6 border border-t-0 border-slate-300 rounded-b-lg bg-white shadow-sm;
        }
        input[type="number"].main-form-input, select.main-form-input {
             @apply flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50;
        }
        input[type="number"].slider-value-input { /* For number inputs linked with sliders */
            @apply flex h-10 w-24 text-center rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2;
        }
        input[type="range"] {
            @apply w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700;
        }
        input[type="range"]::-webkit-slider-thumb {
            @apply appearance-none w-5 h-5 bg-blue-600 rounded-full cursor-pointer hover:bg-blue-700 active:bg-blue-800 shadow;
        }
        input[type="range"]::-moz-range-thumb {
            @apply w-5 h-5 bg-blue-600 rounded-full cursor-pointer border-0 hover:bg-blue-700 active:bg-blue-800 shadow;
        }

        .nomogram-placeholder { @apply border border-dashed border-slate-300 p-4 mb-4 text-center text-slate-500 bg-slate-50 rounded; }
        .nomogram-axis { @apply mb-1 text-sm; }
        .nomogram-label { @apply text-slate-700;}
        .nomogram-value { @apply font-semibold text-blue-700;}
        .points-line-container { @apply relative h-4 bg-slate-200 rounded mt-1 mb-4 w-full; }
        .points-line-marker {
            @apply absolute top-1/2 h-5 w-auto px-1 bg-red-500 rounded text-white text-xs flex items-center justify-center transform -translate-y-1/2 shadow;
            min-width: 20px;
        }
        .points-line-marker::after { @apply content-[''] absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-red-500; }

        .results-table th, .results-table td { @apply border border-slate-300 px-3 py-2 text-sm; }
        .results-table th { @apply bg-slate-100 font-semibold text-slate-700 text-center; }
        .results-table td { @apply text-slate-800 text-center; }
        .results-table td:first-child { @apply text-left font-medium; }

        .nav-link-active { @apply text-blue-600 font-semibold border-b-2 border-blue-600; }
        .error-message { color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; /* Reserve space for error message */ }
        .input-error-border { border-color: #EF4444 !important; }

        .modal { transition: opacity 0.25s ease; z-index: 100; }
        .modal-active-body-scroll-lock { overflow: hidden; }
        .modal-content { max-height: 85vh; overflow-y: auto; }
        .chart-container { position: relative; height:400px; width:100%; }
        .loader {
            border: 4px solid #E5E7EB; 
            border-top: 4px solid #3B82F6; 
            border-radius: 50%;
            width: 20px; /* Slightly smaller loader */
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; 
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white text-gray-800 dark:bg-slate-900 dark:text-slate-200">

    <nav class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50 border-b border-slate-200 dark:border-slate-700">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-700 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">HeartValve 专家</a>
            <div class="flex items-center space-x-1 md:space-x-2">
                <a href="index.html" data-lang-key="navHome" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">首页</a>
                <a href="calculator.html" data-lang-key="navCalculator" class="nav-link-active px-3 py-2 rounded-md text-sm">ARISE Score 工具</a>
                <a href="disease-info.html" data-lang-key="navDiseaseInfo" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">疾病知识</a>
                <a href="surgical-options.html" data-lang-key="navSurgicalOptions" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">手术方案</a>
                <a href="expert-views.html" data-lang-key="navExpertViews" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">专家视角</a>
                <a href="about.html" data-lang-key="navAbout" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">关于我们</a>
                 <select id="languageSelector" class="ml-2 p-2 border border-slate-300 dark:border-slate-600 bg-white dark:bg-slate-700 text-slate-700 dark:text-slate-200 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors">
                    <option value="zh" data-lang-key="langChinese">中文</option>
                    <option value="en" data-lang-key="langEnglish">English</option>
                </select>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="pb-6 xl:pb-8 2xl:pb-10 space-y-2 text-center">
            <h1 class="font-semibold text-[22px] md:text-2xl 2xl:text-3xl text-gray-800 dark:text-slate-100" data-lang-key="pageH1">ARISE (Aortic Regurgitation/Insufficiency Survival Estimation) Score</h1>
            <h2 class="text-slate-600 dark:text-slate-400 text-sm md:text-base 2xl:text-lg" data-lang-key="pageH2">用于评估中重度至重度慢性主动脉瓣反流患者在3个月内接受或不接受主动脉瓣修复/置换术的生存率。</h2>
        </div>

        <div class="mb-8">
            <div class="flex border-b border-slate-300 dark:border-slate-700">
                <button id="tab-who" class="tab-button active" onclick="showTab('who')" data-lang-key="tabWho">适用人群 (Who)</button>
                <button id="tab-how" class="tab-button" onclick="showTab('how')" data-lang-key="tabHow">如何使用 (How)</button>
                <button id="tab-why" class="tab-button" onclick="showTab('why')" data-lang-key="tabWhy">为何使用 (Why)</button>
            </div>
            <div id="content-who" class="tab-content dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300" data-lang-key="contentWho">适用于患有 **中重度至重度慢性主动脉瓣反流 (AR)** 的患者。</div>
            <div id="content-how" class="tab-content hidden dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300" data-lang-key="contentHow">通过该工具**估算和比较**在接受或不接受主动脉瓣修复/置换术情况下，患者1年、3年和5年的生存率。生存率根据低、中、高三个风险等级进行分层。虽然我们的列线图提供了生存率估算，但在共同决策过程中，必须综合考虑基线生存轨迹、净手术获益以及指南建议。</div>
            <div id="content-why" class="tab-content hidden dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300" data-lang-key="contentWhy">此工具专为日常实践中的**个体化风险评估**而设计，帮助医生清晰地沟通手术的获益与风险，从而加强医患关系。</div>
        </div>
        
        <div class="lg:grid lg:grid-cols-12 lg:gap-8">
            <section class="lg:col-span-5 space-y-6">
                <div class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-950 dark:text-slate-50 shadow-lg">
                    <form id="ariseForm" class="p-6 space-y-5">
                        <div>
                            <label for="age" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelAge">年龄 (Age)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeAge">(10-100 岁)</span>
                            </label>
                            <div class="flex items-center mt-1.5 space-x-3">
                                <input type="range" id="age_slider" name="age_slider" min="10" max="100" value="20" step="1">
                                <input type="number" id="age" name="age" min="10" max="100" value="20" step="1" class="slider-value-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                            </div>
                            <div class="error-message mt-1" id="ageError"></div>
                        </div>
                        <div>
                            <label for="sex" class="font-medium text-md block text-slate-700 dark:text-slate-300" data-lang-key="labelSex">性别 (Sex)</label>
                            <select id="sex" name="sex" class="mt-1.5 main-form-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                                <option value="male" data-lang-key="sexMale">男性 (Male)</option>
                                <option value="female" data-lang-key="sexFemale">女性 (Female)</option>
                            </select>
                            <div class="error-message mt-1" id="sexError"></div>
                        </div>
                        <div>
                            <label for="cci" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelCCI">CCI评分</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeCCI">(0-9 分)</span>
                            </label>
                            <div class="flex items-center mt-1.5 space-x-3">
                                <input type="range" id="cci_slider" name="cci_slider" min="0" max="9" value="0" step="1">
                                <input type="number" id="cci" name="cci" min="0" max="9" value="0" step="1" class="slider-value-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                                <button type="button" id="openCciModalButton" class="px-3 py-1.5 bg-sky-500 hover:bg-sky-600 text-white text-xs rounded-md whitespace-nowrap transition-colors" data-lang-key="calculateCciButtonKey">计算CCI</button>
                            </div>
                             <div class="error-message mt-1" id="cciError"></div>
                        </div>
                        <div>
                            <label for="nyha" class="font-medium text-md block text-slate-700 dark:text-slate-300" data-lang-key="labelNYHA">NYHA 心功能分级</label>
                            <select id="nyha" name="nyha" class="mt-1.5 main-form-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                                <option value="1" data-lang-key="nyhaI">NYHA I</option>
                                <option value="2" data-lang-key="nyhaII">NYHA II</option>
                                <option value="3" data-lang-key="nyhaIII">NYHA III</option>
                                <option value="4" data-lang-key="nyhaIV">NYHA IV</option>
                            </select>
                            <div class="error-message mt-1" id="nyhaError"></div>
                        </div>
                        <div>
                            <label for="aodi" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelAoDi">主动脉根部内径指数 (AoDi)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeAoDi">(15-70 mm/m²)</span>
                            </label>
                            <div class="flex items-center mt-1.5 space-x-3">
                                <input type="range" id="aodi_slider" name="aodi_slider" min="15" max="70" value="15" step="1">
                                <input type="number" id="aodi" name="aodi" min="15" max="70" value="15" step="1" class="slider-value-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                            </div>
                            <div class="error-message mt-1" id="aodiError"></div>
                        </div>
                        <div>
                            <label for="lvef" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelLVEF">左室射血分数 (LVEF)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeLVEF">(20-80 %)</span>
                            </label>
                            <div class="flex items-center mt-1.5 space-x-3">
                                <input type="range" id="lvef_slider" name="lvef_slider" min="20" max="80" value="20" step="1">
                                <input type="number" id="lvef" name="lvef" min="20" max="80" value="20" step="1" class="slider-value-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                            </div>
                             <div class="error-message mt-1" id="lvefError"></div>
                        </div>
                        <div>
                            <label for="lvesdi" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelLVESDi">左室收缩末期内径指数 (LVESDi)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeLVESDi">(10-50 mm/m²)</span>
                            </label>
                            <div class="flex items-center mt-1.5 space-x-3">
                                <input type="range" id="lvesdi_slider" name="lvesdi_slider" min="10" max="50" value="10" step="1">
                                <input type="number" id="lvesdi" name="lvesdi" min="10" max="50" value="10" step="1" class="slider-value-input dark:bg-slate-700 dark:border-slate-600 dark:text-slate-200">
                            </div>
                            <div class="error-message mt-1" id="lvesdiError"></div>
                             <button type="button" id="toggleLvesdiEstimatorButton" class="mt-2.5 text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                                <span data-lang-key="toggleLvesdiEstimatorButtonKey">可选：通过LVDd等估算LVESDi</span>
                                <i id="lvesdiEstimatorIcon" class="fas fa-chevron-down ml-1 transform transition-transform text-xs"></i>
                            </button>
                            <div id="lvesdiEstimatorSection" class="hidden mt-3 p-3 border border-slate-200 dark:border-slate-700 rounded-md bg-slate-50 dark:bg-slate-800/60 space-y-3">
                                <p class="text-xs text-slate-500 dark:text-slate-400" data-lang-key="lvesdiEstimatorInfo">输入LVDd、身高和体重估算LVESDi。LVEF将从上方主表单获取。</p>
                                <div>
                                    <label for="estimatorLvdd" class="block text-xs font-medium text-slate-600 dark:text-slate-300" data-lang-key="labelLVDD">LVDd (mm) <span class="text-slate-400 text-xs" data-lang-key="rangeEstLVDD">(20-100)</span></label>
                                    <input type="number" id="estimatorLvdd" step="1" min="20" max="100" placeholder="例如: 50" class="mt-1 block w-full px-2 py-1.5 text-sm bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <div class="error-message text-xs" id="estimatorLvddError"></div>
                                </div>
                                <div>
                                    <label for="estimatorHeight" class="block text-xs font-medium text-slate-600 dark:text-slate-300" data-lang-key="labelHeight">身高 (cm) <span class="text-slate-400 text-xs" data-lang-key="rangeEstHeight">(100-250)</span></label>
                                    <input type="number" id="estimatorHeight" step="1" min="100" max="250" placeholder="例如: 170" class="mt-1 block w-full px-2 py-1.5 text-sm bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <div class="error-message text-xs" id="estimatorHeightError"></div>
                                </div>
                                <div>
                                    <label for="estimatorWeight" class="block text-xs font-medium text-slate-600 dark:text-slate-300" data-lang-key="labelWeight">体重 (kg) <span class="text-slate-400 text-xs" data-lang-key="rangeEstWeight">(20-250)</span></label>
                                    <input type="number" id="estimatorWeight" step="0.1" min="20" max="250" placeholder="例如: 70" class="mt-1 block w-full px-2 py-1.5 text-sm bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                                    <div class="error-message text-xs" id="estimatorWeightError"></div>
                                </div>
                                <button type="button" id="calculateLvesdiButton" class="w-full px-3 py-1.5 bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded-md transition-colors" data-lang-key="estimateLvesdiButtonKey">估算LVESDi并填充</button>
                                <div id="lvesdiEstimationResult" class="text-xs mt-1 text-slate-600 dark:text-slate-300"></div>
                            </div>
                        </div>

                        <div class="flex justify-between gap-3 pt-5 md:col-span-2">
                            <button type="button" id="resetButton" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-200 h-10 px-4 py-2 rounded-md text-sm font-medium transition-colors" data-lang-key="resetButtonKey">重置 (Reset)</button>
                            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white h-10 px-6 py-2 rounded-md text-base font-medium transition-colors flex items-center justify-center" data-lang-key="submitButtonKey">
                                <i class="fas fa-calculator mr-2"></i>提交 (Submit)
                                <div id="calculationLoader" class="loader ml-2"></div>
                            </button>
                        </div>
                        <div id="validationError" class="text-red-500 text-sm mt-2 md:col-span-2"></div>
                    </form>
                </div>
            </section>

            <section class="lg:col-span-7 space-y-6 mt-8 lg:mt-0">
                <div class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-950 dark:text-slate-50 shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-slate-200" data-lang-key="nomogramTitle">预后列线图与点数</h3>
                    <div class="nomogram-placeholder">
                        <p data-lang-key="nomogramPlaceholder">列线图 (Nomogram) 图形区域</p>
                        <p class="text-xs mt-2" data-lang-key="nomogramInfo">(官网的动态SVG列线图需要专门文件和代码。下方为数值点数展示和简易标尺。)</p>
                    </div>
                    <div id="nomogram-points-display" class="space-y-2 text-sm mb-6">
                        <div class="font-semibold text-slate-800 dark:text-slate-200" data-lang-key="variablePointsTitle">各变量点数:</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsAge">年龄 (Age, year):</span> <span id="nomogram_age_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsSex">性别 (Sex):</span> <span id="nomogram_sex_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsCCI">CCI:</span> <span id="nomogram_cci_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsNYHA">NYHA 分级 (NYHA, class):</span> <span id="nomogram_nyha_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsAoDi">AoDi (mm/m²):</span> <span id="nomogram_aodi_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsLVEF">LVEF (%):</span> <span id="nomogram_lvef_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label dark:text-slate-300" data-lang-key="pointsLVESDi">LVESDi (mm/m²):</span> <span id="nomogram_lvesdi_points" class="nomogram-value dark:text-blue-400">0</span> points</div>
                        <hr class="my-3 border-slate-300 dark:border-slate-600">
                        <div class="nomogram-axis font-bold"><span class="nomogram-label dark:text-slate-200" data-lang-key="pointsTotalNoAVS">总点数 (3月内未行AVS):</span> <span id="nomogram_total_points_no" class="nomogram-value dark:text-blue-400">0</span></div>
                        <div class="points-line-container dark:bg-slate-700"><div id="marker_no_avs" class="points-line-marker" style="left: 0%;">0</div></div>
                        <div class="nomogram-axis font-bold"><span class="nomogram-label dark:text-slate-200" data-lang-key="pointsTotalYesAVS">总点数 (3月内已行AVS):</span> <span id="nomogram_total_points_yes" class="nomogram-value dark:text-blue-400">0</span></div>
                        <div class="points-line-container dark:bg-slate-700"><div id="marker_yes_avs" class="points-line-marker" style="left: 0%;">0</div></div>
                        <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" data-lang-key="pointsScaleInfo">点数标尺估算范围: 0 到 150</p>
                    </div>

                    <h3 class="text-xl font-semibold mb-3 text-gray-700 dark:text-slate-200" data-lang-key="survivalTitle">生存率估算与风险分级</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full results-table text-left">
                            <thead class="bg-slate-50 dark:bg-slate-700">
                                <tr>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderParameter">参数</th>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderNoAVS">3月内未行AVS</th>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderYesAVS">3月内已行AVS</th>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderBenefit">AVS生存获益</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="bg-white dark:bg-slate-800">
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRowTotalPoints">总点数 (取整)</td>
                                    <td id="totalPoints_no" class="dark:text-slate-300">--</td> <td id="totalPoints_yes" class="dark:text-slate-300">--</td> <td class="dark:text-slate-300"></td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRow1YrSurvival">1年生存率</td>
                                    <td id="survival_1y_no" class="dark:text-slate-300">--</td> <td id="survival_1y_yes" class="dark:text-slate-300">--</td> <td id="benefit_1y" class="dark:text-slate-300">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRow3YrSurvival">3年生存率</td>
                                    <td id="survival_3y_no" class="dark:text-slate-300">--</td> <td id="survival_3y_yes" class="dark:text-slate-300">--</td> <td id="benefit_3y" class="dark:text-slate-300">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRow5YrSurvival">5年生存率</td>
                                    <td id="survival_5y_no" class="dark:text-slate-300">--</td> <td id="survival_5y_yes" class="dark:text-slate-300">--</td> <td id="benefit_5y" class="dark:text-slate-300">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRowRiskGroup">风险分组</td>
                                    <td id="riskGroup_no" class="dark:text-slate-300">--</td> <td id="riskGroup_yes" class="dark:text-slate-300">--</td> <td class="dark:text-slate-300"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                     <p class="text-xs text-center mt-4 text-slate-500 dark:text-slate-400" data-lang-key="accuracyDisclaimer">
                        * 当前计算基于原始研究中的列线图及其风险评分系统，旨在辅助理解。实际临床决策需综合更多因素。
                    </p>
                </div>

                <div class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-950 dark:text-slate-50 shadow-lg p-6 mt-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-slate-200" data-lang-key="survivalCurveTitle">生存率曲线 (估算)</h3>
                    <div class="chart-container">
                        <canvas id="survivalCurveChart"></canvas>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-slate-800 dark:bg-black text-gray-300 dark:text-slate-400 py-8 text-center mt-12">
        <div class="container mx-auto px-6">
            <p>&copy; <span id="currentYear"></span> HeartValve 专家. <span data-lang-key="footerRights">版权所有.</span></p>
            <p class="text-sm mt-2" data-lang-key="footerDisclaimer">本网站信息仅供参考，不能替代专业医疗建议、诊断或治疗。</p>
        </div>
    </footer>
    
    <div id="cciModal" class="modal fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-xl">
            <div class="flex justify-between items-center p-5 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100" data-lang-key="cciModalTitle">Charlson合并症指数 (CCI) 计算器</h2>
                <button id="closeCciModalButton" class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="cciConditionsContainer" class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm max-h-[60vh] overflow-y-auto">
                </div>
            <div class="p-5 border-t border-slate-200 dark:border-slate-700">
                <p class="text-md font-semibold text-slate-700 dark:text-slate-200">
                    <span data-lang-key="cciModalTotalScore">CCI 总分 (不含年龄):</span> 
                    <span id="cciScoreDisplay" class="text-blue-600 dark:text-blue-400 font-bold text-lg">0</span>
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" data-lang-key="cciModalNote">ARISE Score已单独包含年龄因素，此处CCI不重复计算年龄加分。</p>
            </div>
            <div class="p-5 flex justify-end space-x-3 bg-slate-50 dark:bg-slate-800/50 rounded-b-lg">
                <button type="button" id="cancelCciButton" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 rounded-md text-sm transition-colors" data-lang-key="cciModalCancel">取消</button>
                <button type="button" id="applyCciButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-semibold transition-colors" data-lang-key="cciModalApply">应用此CCI分数</button>
            </div>
        </div>
    </div>

<script>
// =============================================================================
// ARISE Score Calculator - Based on User Provided HTML & Core JS Logic (Turn 24)
// Enhancements: CCI Calculator, LVESDi Estimator, Chart.js, Language Toggle,
//               No default auto-calc, default Chinese, improved input sync, integer LVESDi from estimator.
// Date: 2025-06-03
// =============================================================================
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('ariseForm');
    const resetButton = document.getElementById('resetButton');
    const validationErrorDiv = document.getElementById('validationError');
    const languageSelector = document.getElementById('languageSelector');
    const calculationLoader = document.getElementById('calculationLoader');
    const currentYearSpan = document.getElementById('currentYear');
    if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();


    // Translations object (Expanded)
    const translations = {
        zh: {
            navHome: "首页", navCalculator: "ARISE Score 工具", navDiseaseInfo: "疾病知识", navSurgicalOptions: "手术方案", navExpertViews: "专家视角", navAbout: "关于我们",
            pageH1: "ARISE (Aortic Regurgitation/Insufficiency Survival Estimation) Score",
            pageH2: "用于评估中重度至重度慢性主动脉瓣反流患者在3个月内接受或不接受主动脉瓣修复/置换术的生存率。",
            tabWho: "适用人群 (Who)", tabHow: "如何使用 (How)", tabWhy: "为何使用 (Why)",
            contentWho: "适用于患有 **中重度至重度慢性主动脉瓣反流 (AR)** 的患者。",
            contentHow: "通过该工具**估算和比较**在接受或不接受主动脉瓣修复/置换术情况下，患者1年、3年和5年的生存率。生存率根据低、中、高三个风险等级进行分层。虽然我们的列线图提供了生存率估算，但在共同决策过程中，必须综合考虑基线生存轨迹、净手术获益以及指南建议。",
            contentWhy: "此工具专为日常实践中的**个体化风险评估**而设计，帮助医生清晰地沟通手术的获益与风险，从而加强医患关系。",
            labelAge: "年龄 (Age)", rangeAge: "(10-100 岁)",
            labelSex: "性别 (Sex)", sexMale: "男性 (Male)", sexFemale: "女性 (Female)",
            labelCCI: "CCI评分", rangeCCI: "(0-9 分)", calculateCciButtonKey: "计算CCI",
            labelNYHA: "NYHA 心功能分级", nyhaI: "NYHA I", nyhaII: "NYHA II", nyhaIII: "NYHA III", nyhaIV: "NYHA IV",
            labelAoDi: "主动脉根部内径指数 (AoDi)", rangeAoDi: "(15-70 mm/m²)",
            labelLVEF: "左室射血分数 (LVEF)", rangeLVEF: "(20-80 %)",
            labelLVESDi: "左室收缩末期内径指数 (LVESDi)", rangeLVESDi: "(10-50 mm/m²)",
            toggleLvesdiEstimatorButtonKey: "可选：通过LVDd等估算LVESDi",
            lvesdiEstimatorInfo: "输入LVDd、身高和体重估算LVESDi。LVEF将从上方主表单获取。",
            labelLVDD: "LVDd (mm)", rangeEstLVDD: "(20-100)",
            labelHeight: "身高 (cm)", rangeEstHeight: "(100-250)",
            labelWeight: "体重 (kg)", rangeEstWeight: "(20-250)",
            estimateLvesdiButtonKey: "估算LVESDi并填充",
            lvesdiNotCalculated: "LVESDi 未计算或所需输入无效。",
            lvesdiCalculated: "估算 LVESDi: {value} mm/m² (BSA: {bsa} m²)。已填充至主表单。",
            nomogramTitle: "预后列线图与点数",
            nomogramPlaceholder: "列线图 (Nomogram) 图形区域",
            nomogramInfo: "(官网的动态SVG列线图需要专门文件和代码。下方为数值点数展示和简易标尺。)",
            variablePointsTitle: "各变量点数:",
            pointsAge: "年龄 (Age, year):", pointsSex: "性别 (Sex):", pointsCCI: "CCI:", pointsNYHA: "NYHA 分级 (NYHA, class):",
            pointsAoDi: "AoDi (mm/m²):", pointsLVEF: "LVEF (%):", pointsLVESDi: "LVESDi (mm/m²):",
            pointsTotalNoAVS: "总点数 (3月内未行AVS):", pointsTotalYesAVS: "总点数 (3月内已行AVS):",
            pointsScaleInfo: "点数标尺估算范围: 0 到 150",
            survivalTitle: "生存率估算与风险分级",
            tableHeaderParameter: "参数", tableHeaderNoAVS: "3月内未行AVS", tableHeaderYesAVS: "3月内已行AVS", tableHeaderBenefit: "AVS生存获益",
            tableRowTotalPoints: "总点数 (取整)", tableRow1YrSurvival: "1年生存率", tableRow3YrSurvival: "3年生存率", tableRow5YrSurvival: "5年生存率", tableRowRiskGroup: "风险分组",
            accuracyDisclaimer: "* 当前计算基于原始研究中的列线图及其风险评分系统，旨在辅助理解。实际临床决策需综合更多因素。",
            survivalCurveTitle: "生存率曲线 (估算)",
            resetButtonKey: "重置 (Reset)", submitButtonKey: "提交 (Submit)",
            errorRequired: "此字段为必填项。", errorInteger: "请输入一个有效的整数。", errorNumber: "请输入一个有效的数字。",
            errorRange: "{label}必须是 {min} 到 {max} 之间的整数。",
            errorSelect: "{label}是必选项。",
            errorLVEFForEstimator: "请输入有效的主表单LVEF值 (20-80%) 以估算LVESDi。",
            footerRights: "版权所有.", footerDisclaimer: "本网站信息仅供参考，不能替代专业医疗建议、诊断或治疗。",
            langEnglish: "English", langChinese: "中文", pageTitle: "ARISE Score 预后评估 - HeartValve 专家",
            selectOption: "请选择", 
            cciModalTitle: "Charlson合并症指数 (CCI) 计算器",
            cciModalTotalScore: "CCI 总分 (不含年龄):",
            cciModalNote: "ARISE Score已单独包含年龄因素，此处CCI不重复计算年龄加分。",
            cciModalCancel: "取消",
            cciModalApply: "应用此CCI分数",
            mi: "心肌梗死", chf: "充血性心力衰竭", pvd: "外周血管疾病", cvd: "脑血管疾病", dementia: "痴呆",
            cpd: "慢性肺病", ctd: "结缔组织病", pud: "消化性溃疡病", mld: "轻度肝病", diabetes_no_ed: "糖尿病 (无终末器官损害)",
            hemiplegia: "偏瘫或截瘫", renal_mod_sev: "中度或重度肾病", diabetes_ed: "糖尿病 (伴终末器官损害)",
            tumor_no_meta: "任何肿瘤 (无转移)", leukemia: "白血病", lymphoma: "淋巴瘤", liver_mod_sev: "中度或重度肝病",
            tumor_meta: "转移性实体瘤", aids: "艾滋病 (AIDS)",
            riskLow: "低风险 (Low)", riskMedium: "中等风险 (Intermediate)", riskHigh: "高风险 (High)",
            chartSurvivalNoAVS: "生存率 (未行AVS)", chartSurvivalYesAVS: "生存率 (已行AVS)",
            chartLabelTimeYears: "时间 (年)", chartLabelSurvivalRate: "生存率 (%)", chartLabelBaseline: "基线"
        },
        en: {
            navHome: "Home", navCalculator: "ARISE Score Tool", navDiseaseInfo: "Disease Info", navSurgicalOptions: "Surgical Options", navExpertViews: "Expert Views", navAbout: "About Us",
            pageH1: "ARISE (Aortic Regurgitation/Insufficiency Survival Estimation) Score",
            pageH2: "For estimating survival in patients with moderate-to-severe or severe chronic aortic regurgitation with or without aortic valve surgery within 3 months.",
            tabWho: "Who", tabHow: "How", tabWhy: "Why",
            contentWho: "Applicable to patients with **moderate-to-severe or severe chronic aortic regurgitation (AR)**.",
            contentHow: "Use this tool to **estimate and compare** 1-year, 3-year, and 5-year survival rates with or without aortic valve repair/replacement. Survival rates are stratified into low, intermediate, and high-risk groups. While our nomogram provides survival estimates, baseline survival trajectory, net surgical benefit, and guideline recommendations must be considered in shared decision-making.",
            contentWhy: "This tool is designed for **individualized risk assessment** in daily practice, helping physicians clearly communicate the benefits and risks of surgery, thereby strengthening the doctor-patient relationship.",
            labelAge: "Age", rangeAge: "(10-100 years)",
            labelSex: "Sex", sexMale: "Male", sexFemale: "Female",
            labelCCI: "CCI Score", rangeCCI: "(0-9 points)", calculateCciButtonKey: "Calculate CCI",
            labelNYHA: "NYHA Class", nyhaI: "NYHA I", nyhaII: "NYHA II", nyhaIII: "NYHA III", nyhaIV: "NYHA IV",
            labelAoDi: "AoDi", rangeAoDi: "(15-70 mm/m²)",
            labelLVEF: "LVEF", rangeLVEF: "(20-80 %)",
            labelLVESDi: "LVESDi", rangeLVESDi: "(10-50 mm/m²)",
            toggleLvesdiEstimatorButtonKey: "Optional: Estimate LVESDi via LVDd, etc.",
            lvesdiEstimatorInfo: "Enter LVDd, height, and weight to estimate LVESDi. LVEF will be taken from the main form above.",
            labelLVDD: "LVDd (mm)", rangeEstLVDD: "(20-100)",
            labelHeight: "Height (cm)", rangeEstHeight: "(100-250)",
            labelWeight: "Weight (kg)", rangeEstWeight: "(20-250)",
            estimateLvesdiButtonKey: "Estimate & Fill LVESDi",
            lvesdiNotCalculated: "LVESDi not calculated or inputs invalid.",
            lvesdiCalculated: "Est. LVESDi: {value} mm/m² (BSA: {bsa} m²). Populated to main form.",
            nomogramTitle: "Prognostic Nomogram & Points",
            nomogramPlaceholder: "Nomogram Graphic Area",
            nomogramInfo: "(The official dynamic SVG nomogram requires specific files and JavaScript. Below is a numerical points display and simplified scale.)",
            variablePointsTitle: "Points per Variable:",
            pointsAge: "Age (year):", pointsSex: "Sex:", pointsCCI: "CCI:", pointsNYHA: "NYHA (class):",
            pointsAoDi: "AoDi (mm/m²):", pointsLVEF: "LVEF (%):", pointsLVESDi: "LVESDi (mm/m²):",
            pointsTotalNoAVS: "Total Points (No AVS within 3 mo):", pointsTotalYesAVS: "Total Points (AVS within 3 mo):",
            pointsScaleInfo: "Points scale estimated range: 0 to 150",
            survivalTitle: "Survival Estimation & Risk Group",
            tableHeaderParameter: "Parameter", tableHeaderNoAVS: "No AVS within 3 mo", tableHeaderYesAVS: "AVS within 3 mo", tableHeaderBenefit: "AVS Survival Benefit",
            tableRowTotalPoints: "Total Points (rounded)", tableRow1YrSurvival: "1-Year Survival", tableRow3YrSurvival: "3-Year Survival", tableRow5YrSurvival: "5-Year Survival", tableRowRiskGroup: "Risk Group",
            accuracyDisclaimer: "* Current calculation is based on the nomogram and risk scoring system from the original research and is intended for informational purposes. Clinical decisions require comprehensive assessment.",
            survivalCurveTitle: "Survival Curve (Estimated)",
            resetButtonKey: "Reset", submitButtonKey: "Submit",
            errorRequired: "This field is required.", errorInteger: "Please enter a valid integer.", errorNumber: "Please enter a valid number.",
            errorRange: "{label} must be an integer between {min} and {max}.",
            errorSelect: "{label} is required.",
            errorLVEFForEstimator: "Please enter a valid LVEF (20-80%) from main form to estimate LVESDi.",
            footerRights: "All rights reserved.", footerDisclaimer: "This website information is for reference only and cannot replace professional medical advice, diagnosis, or treatment.",
            langEnglish: "English", langChinese: "中文", pageTitle: "ARISE Score Prognostic Tool - HeartValve Expert",
            selectOption: "Please select",
            cciModalTitle: "Charlson Comorbidity Index (CCI) Calculator",
            cciModalTotalScore: "CCI Total Score (excluding age):",
            cciModalNote: "ARISE Score already includes age as a factor; CCI here does not add points for age again.",
            cciModalCancel: "Cancel",
            cciModalApply: "Apply this CCI Score",
            mi: "Myocardial Infarction", chf: "Congestive Heart Failure", pvd: "Peripheral Vascular Disease", cvd: "Cerebrovascular Disease", dementia: "Dementia",
            cpd: "Chronic Pulmonary Disease", ctd: "Connective Tissue Disease", pud: "Peptic Ulcer Disease", mld: "Mild Liver Disease", diabetes_no_ed: "Diabetes (no end-organ damage)",
            hemiplegia: "Hemiplegia or Paraplegia", renal_mod_sev: "Moderate or Severe Renal Disease", diabetes_ed: "Diabetes (with end-organ damage)",
            tumor_no_meta: "Any Tumor (no metastases)", leukemia: "Leukemia", lymphoma: "Lymphoma", liver_mod_sev: "Moderate or Severe Liver Disease",
            tumor_meta: "Metastatic Solid Tumor", aids: "AIDS",
            riskLow: "Low Risk", riskMedium: "Intermediate Risk", riskHigh: "High Risk",
            chartSurvivalNoAVS: "Survival (No AVS)", chartSurvivalYesAVS: "Survival (AVS)",
            chartLabelTimeYears: "Time (Years)", chartLabelSurvivalRate: "Survival Rate (%)", chartLabelBaseline: "Baseline"
        }
    };
    let currentLanguage = 'zh'; 
    let chartInstance = null;

    const inputsConfig = [ // From user's HTML
        { id: 'age',    sliderId: 'age_slider',    min: 10, max: 100, defaultVal: 20, step: 1 },
        { id: 'cci',    sliderId: 'cci_slider',    min: 0,  max: 9,   defaultVal: 0,  step: 1 }, // Default CCI 0
        { id: 'aodi',   sliderId: 'aodi_slider',   min: 15, max: 70,  defaultVal: 15, step: 1 },
        { id: 'lvef',   sliderId: 'lvef_slider',   min: 20, max: 80,  defaultVal: 20, step: 1 },
        { id: 'lvesdi', sliderId: 'lvesdi_slider', min: 10, max: 50,  defaultVal: 10, step: 1 }
    ];

    // Improved Slider and Number Input Synchronization
    inputsConfig.forEach(inputConf => {
        const numberInput = document.getElementById(inputConf.id);
        const sliderInput = document.getElementById(inputConf.sliderId);
        if (numberInput && sliderInput) {
            sliderInput.step = inputConf.step;
            numberInput.step = inputConf.step;
            // Set initial values from config if not pre-filling from specific clinical profile
            // numberInput.value = inputConf.defaultVal; // Removed: No pre-fill
            // sliderInput.value = inputConf.defaultVal; // Removed: No pre-fill

            sliderInput.addEventListener('input', () => {
                numberInput.value = sliderInput.value;
                validateSingleField(inputConf.id, numberInput.value, inputConf.min, inputConf.max, true, true); // Validate on slider change
            });
            // Change event for number input to update slider after user finishes typing
            numberInput.addEventListener('change', () => {
                let value = parseInt(numberInput.value);
                if (isNaN(value)) value = inputConf.min; // Or some other default if NaN
                value = Math.max(inputConf.min, Math.min(inputConf.max, value));
                numberInput.value = value;
                sliderInput.value = value;
                validateSingleField(inputConf.id, value, inputConf.min, inputConf.max, true, true); // Validate on number change
            });
             // Also validate on blur to catch final input
            numberInput.addEventListener('blur', () => {
                validateSingleField(inputConf.id, numberInput.value, inputConf.min, inputConf.max, true, true);
            });
        }
    });
    
    // Simplified single field validation helper for immediate feedback
    function validateSingleField(id, valueStr, min, max, isRequired = true, isInteger = true) {
        const inputElement = document.getElementById(id);
        const errorElement = document.getElementById(id + 'Error');
        if (!inputElement || !errorElement) return true;

        errorElement.textContent = '';
        inputElement.classList.remove('input-error-border');
        const label = translations[currentLanguage][`label${id.charAt(0).toUpperCase() + id.slice(1)}`] || id;

        if (isRequired && valueStr.trim() === '') {
            errorElement.textContent = translations[currentLanguage].errorRequired;
            inputElement.classList.add('input-error-border');
            return false;
        }
        if (valueStr.trim() === '' && !isRequired) return true;

        const valueNum = parseFloat(valueStr);
        if (isNaN(valueNum)) {
            errorElement.textContent = translations[currentLanguage].errorNumber;
            inputElement.classList.add('input-error-border');
            return false;
        }
        if (isInteger && !Number.isInteger(valueNum)) {
             errorElement.textContent = translations[currentLanguage].errorInteger;
             inputElement.classList.add('input-error-border');
             return false;
        }
        if ((min !== undefined && valueNum < min) || (max !== undefined && valueNum > max)) {
            errorElement.textContent = (translations[currentLanguage].errorRange || "{label} must be between {min} and {max}.")
                .replace('{label}', label).replace('{min}', min).replace('{max}', max);
            inputElement.classList.add('input-error-border');
            return false;
        }
        return true;
    }


    // Tab switching (from user's provided code)
    window.showTab = function(tabName) {
        ['who', 'how', 'why'].forEach(contentId => {
            const contentEl = document.getElementById('content-' + contentId);
            const tabButton = document.getElementById('tab-' + contentId);
            if(contentEl) contentEl.classList.add('hidden');
            if(tabButton) {
                tabButton.classList.remove('active', 'bg-white', 'text-slate-950', 'border-slate-300', 'dark:bg-slate-700', 'dark:text-white');
                tabButton.classList.add('bg-slate-50', 'text-slate-600', 'border-transparent', 'dark:bg-slate-800', 'dark:text-slate-400');
            }
        });
        const activeContentEl = document.getElementById('content-' + tabName);
        const activeTabButton = document.getElementById('tab-' + tabName);
        if(activeContentEl) activeContentEl.classList.remove('hidden');
        if(activeTabButton) {
            activeTabButton.classList.add('active', 'bg-white', 'text-slate-950', 'border-slate-300', 'dark:bg-slate-700', 'dark:text-white');
            activeTabButton.classList.remove('bg-slate-50', 'text-slate-600', 'border-transparent', 'dark:bg-slate-800', 'dark:text-slate-400');
        }
    }

    // --- START: User's Core ARISE Calculation Logic (UNCHANGED - from Turn 24) ---
    const RISK_THRESHOLDS = { Low: 0, Intermediate: 85, High: 107 }; // User's constants
    function calculateFactorPoints_ARISE(factors) { // User's function
        const { age, sex, cci, nyha, aodi, lvef, lvesdi } = factors;
        return {
            age: -11.111111 + 1.111111 * parseInt(age),
            sex: "female" === sex ? 5.092295 : 0,
            cci: 0 + 3.49046 * parseInt(cci),
            nyha: -3.541039 + 3.541039 * parseInt(nyha), // nyha is "1","2","3","4"
            aodi: -7.241847 + 0.48279 * parseInt(aodi),
            lvef: 21.697412 - 0.271218 * parseInt(lvef),
            lvesdi: -4.527494 + 0.452749 * parseInt(lvesdi)
        };
    }
    function calculateRawTotalPoints_ARISE(factorPoints) { // User's function
        let sumOfFactorPoints = Object.values(factorPoints).reduce((sum, points) => sum + (points != null ? points : 0), 0);
        if (sumOfFactorPoints < 1e-6 && sumOfFactorPoints > -1e-6) sumOfFactorPoints = 0;
        const avsOffset = 11.042254; // User's constant
        return [sumOfFactorPoints + avsOffset, sumOfFactorPoints]; // [No AVS, Yes AVS]
    }
    function calculateSurvivalProbabilities_ARISE(rawTotalPointsMatrix) { // User's function
        const [rawTotalPointsNoAVS, rawTotalPointsYesAVS] = rawTotalPointsMatrix;
        const getProbs = (totalPoints) => {
            const linearPredictor = (totalPoints - 93.903984) / 18.131663; // User's constants
            const expLP = Math.exp(linearPredictor);
            return { // User's constants for survival
                oneYear: Math.pow(0.977952, expLP),
                threeYear: Math.pow(0.9343029, expLP),
                fiveYear: Math.pow(0.8886656, expLP)
            };
        };
        return { noAVS: getProbs(rawTotalPointsNoAVS), yesAVS: getProbs(rawTotalPointsYesAVS) };
    }
    function calculateRiskGroups_ARISE(truncatedTotalPointsMatrix) { // User's function
        const [truncatedTotalPointsNoAVS, truncatedTotalPointsYesAVS] = truncatedTotalPointsMatrix;
        const getGroup = (points) => {
            if (points < RISK_THRESHOLDS.Intermediate) return translations[currentLanguage].riskLow;
            if (points < RISK_THRESHOLDS.High) return translations[currentLanguage].riskMedium;
            return translations[currentLanguage].riskHigh;
        };
        return { noAVS: getGroup(truncatedTotalPointsNoAVS), yesAVS: getGroup(truncatedTotalPointsYesAVS) };
    }
    function getAriseScoreCalculatorResults_Main(factors) { // User's function
        const factorPoints = calculateFactorPoints_ARISE(factors);
        const rawTotalPointsMatrix = calculateRawTotalPoints_ARISE(factorPoints);
        const truncatedTotalPointsMatrix = rawTotalPointsMatrix.map(points => Math.trunc(points));
        const survivalProbabilities = calculateSurvivalProbabilities_ARISE(rawTotalPointsMatrix);
        const riskGroups = calculateRiskGroups_ARISE(truncatedTotalPointsMatrix);
        return {
            factorPoints: factorPoints,
            rawTotalPoints: { noAVS: rawTotalPointsMatrix[0], yesAVS: rawTotalPointsMatrix[1] },
            totalPoints: { noAVS: truncatedTotalPointsMatrix[0], yesAVS: truncatedTotalPointsMatrix[1] },
            survivalProbabilities: survivalProbabilities,
            riskGroups: riskGroups
        };
    }
    // --- END: User's Core ARISE Calculation Logic ---

    // Main form validation schema (from user's code, adapted)
    const mainFormSchema = {
        age:    { min: 10, max: 100, labelKey: "labelAge", isInteger: true },
        sex:    { enum: ["male", "female"], labelKey: "labelSex", isRequired: true },
        cci:    { min: 0,  max: 9,   labelKey: "labelCCI", isInteger: true },
        nyha:   { enum: ["1", "2", "3", "4"], labelKey: "labelNYHA", isRequired: true },
        aodi:   { min: 15, max: 70,  labelKey: "labelAoDi", isInteger: true }, // Made integer as per user's HTML slider step
        lvef:   { min: 20, max: 80,  labelKey: "labelLVEF", isInteger: true },
        lvesdi: { min: 10, max: 50,  labelKey: "labelLVESDi", isInteger: true } // Made integer
    };
    
    function validateMainAriseForm() {
        let isValid = true;
        if(validationErrorDiv) validationErrorDiv.innerHTML = ''; // Clear global errors
        let errorMessagesArray = [];

        for (const key in mainFormSchema) {
            const inputElement = document.getElementById(key);
            if (!inputElement) continue;
            const value = inputElement.value;
            const rule = mainFormSchema[key];
            const validationResult = validateSingleField(key, value, rule.min, rule.max, rule.isRequired !== false, rule.isInteger, rule.enum, rule.labelKey);
            if (!validationResult) { // validateSingleField now just returns true/false
                isValid = false;
                // Error message is displayed by validateSingleField itself
            }
        }
        return isValid;
    }
    
    if(form) form.addEventListener('submit', function (event) {
        event.preventDefault();
        if(calculationLoader) calculationLoader.style.display = 'inline-block';
        
        if (!validateMainAriseForm()) {
            if(calculationLoader) calculationLoader.style.display = 'none';
            return;
        }
        
        const processedInputs = { // Ensure these match the exact keys and types for user's functions
            age:    parseInt(document.getElementById('age').value),
            sex:    document.getElementById('sex').value,
            cci:    parseInt(document.getElementById('cci').value),
            nyha:   document.getElementById('nyha').value, // This is "1", "2", "3", "4"
            aodi:   parseInt(document.getElementById('aodi').value),
            lvef:   parseInt(document.getElementById('lvef').value),
            lvesdi: parseInt(document.getElementById('lvesdi').value)
        };

        setTimeout(() => {
            const results = getAriseScoreCalculatorResults_Main(processedInputs);
            updateNomogramPointsDisplay(results.factorPoints, results.totalPoints);
            updateResultsTable(results.totalPoints, results.survivalProbabilities, results.riskGroups);
            updateChart(results.totalPoints, results.survivalProbabilities);
            if(calculationLoader) calculationLoader.style.display = 'none';
        }, 300);
    });

    // Update Nomogram display (from user's code, adapted)
    function updateNomogramPointsDisplay(perVarScores, totalPts) { // totalPts is {noAVS, yesAVS}
        if(document.getElementById('nomogram_age_points')) document.getElementById('nomogram_age_points').textContent = perVarScores.age.toFixed(1);
        if(document.getElementById('nomogram_sex_points')) document.getElementById('nomogram_sex_points').textContent = perVarScores.sex.toFixed(1);
        if(document.getElementById('nomogram_cci_points')) document.getElementById('nomogram_cci_points').textContent = perVarScores.cci.toFixed(1);
        if(document.getElementById('nomogram_nyha_points')) document.getElementById('nomogram_nyha_points').textContent = perVarScores.nyha.toFixed(1);
        if(document.getElementById('nomogram_aodi_points')) document.getElementById('nomogram_aodi_points').textContent = perVarScores.aodi.toFixed(1);
        if(document.getElementById('nomogram_lvef_points')) document.getElementById('nomogram_lvef_points').textContent = perVarScores.lvef.toFixed(1);
        if(document.getElementById('nomogram_lvesdi_points')) document.getElementById('nomogram_lvesdi_points').textContent = perVarScores.lvesdi.toFixed(1);
        
        if(document.getElementById('nomogram_total_points_no')) document.getElementById('nomogram_total_points_no').textContent = totalPts.noAVS;
        if(document.getElementById('nomogram_total_points_yes')) document.getElementById('nomogram_total_points_yes').textContent = totalPts.yesAVS;
        
        const NOMOGRAM_TOTAL_POINTS_MAX_SCALE = 150; // From user's HTML
        const markerNoAvs = document.getElementById('marker_no_avs');
        const markerYesAvs = document.getElementById('marker_yes_avs');
        
        if (markerNoAvs) {
            let percentNoAvs = (totalPts.noAVS / NOMOGRAM_TOTAL_POINTS_MAX_SCALE) * 100;
            percentNoAvs = Math.min(100, Math.max(0, percentNoAvs)); 
            markerNoAvs.style.left = `calc(${percentNoAvs}% - ${markerNoAvs.offsetWidth / 2}px)`; 
            markerNoAvs.textContent = totalPts.noAVS;
        }
        if (markerYesAvs) {
            let percentYesAvs = (totalPts.yesAVS / NOMOGRAM_TOTAL_POINTS_MAX_SCALE) * 100;
            percentYesAvs = Math.min(100, Math.max(0, percentYesAvs));
            markerYesAvs.style.left = `calc(${percentYesAvs}% - ${markerYesAvs.offsetWidth / 2}px)`;
            markerYesAvs.textContent = totalPts.yesAVS;
        }
    }

    // Update results table (from user's code, adapted)
    function updateResultsTable(totalPts, survivalProbs, riskGroups) { // totalPts, survivalProbs, riskGroups are {noAVS, yesAVS}
        if(document.getElementById('totalPoints_no')) document.getElementById('totalPoints_no').textContent = totalPts.noAVS;
        if(document.getElementById('totalPoints_yes')) document.getElementById('totalPoints_yes').textContent = totalPts.yesAVS;

        if(document.getElementById('survival_1y_no')) document.getElementById('survival_1y_no').textContent = (survivalProbs.noAVS.oneYear * 100).toFixed(1) + '%';
        if(document.getElementById('survival_1y_yes')) document.getElementById('survival_1y_yes').textContent = (survivalProbs.yesAVS.oneYear * 100).toFixed(1) + '%';
        if(document.getElementById('benefit_1y')) document.getElementById('benefit_1y').textContent = ((survivalProbs.yesAVS.oneYear - survivalProbs.noAVS.oneYear) * 100).toFixed(1) + '%';
        
        if(document.getElementById('survival_3y_no')) document.getElementById('survival_3y_no').textContent = (survivalProbs.noAVS.threeYear * 100).toFixed(1) + '%';
        if(document.getElementById('survival_3y_yes')) document.getElementById('survival_3y_yes').textContent = (survivalProbs.yesAVS.threeYear * 100).toFixed(1) + '%';
        if(document.getElementById('benefit_3y')) document.getElementById('benefit_3y').textContent = ((survivalProbs.yesAVS.threeYear - survivalProbs.noAVS.threeYear) * 100).toFixed(1) + '%';

        if(document.getElementById('survival_5y_no')) document.getElementById('survival_5y_no').textContent = (survivalProbs.noAVS.fiveYear * 100).toFixed(1) + '%';
        if(document.getElementById('survival_5y_yes')) document.getElementById('survival_5y_yes').textContent = (survivalProbs.yesAVS.fiveYear * 100).toFixed(1) + '%';
        if(document.getElementById('benefit_5y')) document.getElementById('benefit_5y').textContent = ((survivalProbs.yesAVS.fiveYear - survivalProbs.noAVS.fiveYear) * 100).toFixed(1) + '%';

        if(document.getElementById('riskGroup_no')) document.getElementById('riskGroup_no').textContent = riskGroups.noAVS;
        if(document.getElementById('riskGroup_yes')) document.getElementById('riskGroup_yes').textContent = riskGroups.yesAVS;
    }
    
    // Clear results (from user's code, adapted)
    function clearResultsAndNomogramPoints() {
        const nomogramPointIds = ['nomogram_age_points', 'nomogram_sex_points', 'nomogram_cci_points', 'nomogram_nyha_points', 'nomogram_aodi_points', 'nomogram_lvef_points', 'nomogram_lvesdi_points', 'nomogram_total_points_no', 'nomogram_total_points_yes'];
        nomogramPointIds.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = '0'; });
        const tableResultIds = ['totalPoints_no', 'totalPoints_yes', 'survival_1y_no', 'survival_1y_yes', 'benefit_1y', 'survival_3y_no', 'survival_3y_yes', 'benefit_3y', 'survival_5y_no', 'survival_5y_yes', 'benefit_5y', 'riskGroup_no', 'riskGroup_yes'];
        tableResultIds.forEach(id => { if(document.getElementById(id)) document.getElementById(id).textContent = '--'; });
        const markerNoAvs = document.getElementById('marker_no_avs');
        const markerYesAvs = document.getElementById('marker_yes_avs');
        if(markerNoAvs) { markerNoAvs.style.left = `0%`; markerNoAvs.textContent = '0';}
        if(markerYesAvs) { markerYesAvs.style.left = `0%`; markerYesAvs.textContent = '0';}
        if(chartInstance) { // Clear chart data
            chartInstance.data.datasets[0].data = [100, null, null, null];
            chartInstance.data.datasets[1].data = [100, null, null, null];
            chartInstance.update();
        } else {
            initChart(); // Initialize chart if it wasn't already
        }
    }
    
    // Reset form (from user's code, adapted for no auto-calc)
    if(resetButton) resetButton.addEventListener('click', function() {
        if(form) form.reset(); // Resets to HTML default values
        inputsConfig.forEach(conf => { // Explicitly set to HTML default values for sliders and number inputs
            const numInput = document.getElementById(conf.id);
            const sliderInput = document.getElementById(conf.sliderId);
            if (numInput) numInput.value = numInput.defaultValue || conf.defaultVal || ''; // Use HTML default or configured default
            if (sliderInput) sliderInput.value = sliderInput.defaultValue || conf.defaultVal || '';
        });
        // Reset select elements
        if(document.getElementById('sex')) document.getElementById('sex').value = "male"; // Or its HTML default
        if(document.getElementById('nyha')) document.getElementById('nyha').value = "1";   // Or its HTML default
        
        if(validationErrorDiv) validationErrorDiv.textContent = '';
        clearResultsAndNomogramPoints();
        // Remove auto-calculation on reset
    });

    // Language Switcher and Initial Language Setting
    function updateAllText() {
        document.documentElement.lang = currentLanguage;
        document.querySelectorAll('[data-lang-key]').forEach(el => {
            const key = el.getAttribute('data-lang-key');
            const translation = translations[currentLanguage]?.[key];
            if (translation) {
                if (el.tagName === 'INPUT' && (el.type === 'submit' || el.type === 'button')) el.value = translation;
                else if (el.tagName === 'TITLE') document.title = translation;
                else el.innerHTML = translation; // Use innerHTML for elements that might contain icons like <i>
            }
        });
        if (chartInstance) { // Update chart labels and titles
            chartInstance.data.labels = [
                translations[currentLanguage].chartLabelBaseline,
                `1 ${translations[currentLanguage].chartLabelTimeYears}`,
                `3 ${translations[currentLanguage].chartLabelTimeYears}`,
                `5 ${translations[currentLanguage].chartLabelTimeYears}`
            ];
            chartInstance.data.datasets[0].label = translations[currentLanguage].chartSurvivalNoAVS;
            chartInstance.data.datasets[1].label = translations[currentLanguage].chartSurvivalYesAVS;
            chartInstance.options.scales.y.title.text = translations[currentLanguage].chartLabelSurvivalRate;
            chartInstance.options.scales.x.title.text = translations[currentLanguage].chartLabelTimeYears;
            chartInstance.update('none'); // 'none' for no animation
        }
        if (document.getElementById('cciModal')) {
            populateCciConditions(); 
            const cciModalTitle = document.querySelector('#cciModal [data-lang-key="cciModalTitle"]');
            if(cciModalTitle) cciModalTitle.textContent = translations[currentLanguage].cciModalTitle;
            const cciModalScore = document.querySelector('#cciModal [data-lang-key="cciModalTotalScore"]');
            if(cciModalScore) cciModalScore.textContent = translations[currentLanguage].cciModalTotalScore;
            const cciModalNote = document.querySelector('#cciModal [data-lang-key="cciModalNote"]');
            if(cciModalNote) cciModalNote.textContent = translations[currentLanguage].cciModalNote;
            const cciModalCancel = document.querySelector('#cciModal [data-lang-key="cciModalCancel"]');
            if(cciModalCancel) cciModalCancel.textContent = translations[currentLanguage].cciModalCancel;
            const cciModalApply = document.querySelector('#cciModal [data-lang-key="cciModalApply"]');
            if(cciModalApply) cciModalApply.textContent = translations[currentLanguage].cciModalApply;
        }
    }

    if(languageSelector) languageSelector.addEventListener('change', (e) => {
        currentLanguage = e.target.value;
        localStorage.setItem('ariseCalculatorLanguage', currentLanguage);
        updateAllText();
    });

    // --- CCI Calculator Logic ---
    const cciModal = document.getElementById('cciModal');
    const openCciModalButton = document.getElementById('openCciModalButton');
    const closeCciModalButton = document.getElementById('closeCciModalButton');
    const cancelCciButton = document.getElementById('cancelCciButton');
    const applyCciButton = document.getElementById('applyCciButton');
    const cciConditionsContainer = document.getElementById('cciConditionsContainer');
    const cciScoreDisplay = document.getElementById('cciScoreDisplay');
    const mainCciInput = document.getElementById('cci');
    const mainCciSlider = document.getElementById('cci_slider');

    // Standard Charlson points (excluding age, as ARISE model handles age separately)
    const cciConditionPoints = {
        mi: 1, chf: 1, pvd: 1, cvd: 1, dementia: 1, cpd: 1, ctd: 1, pud: 1, mld: 1, diabetes_no_ed: 1,
        hemiplegia: 2, renal_mod_sev: 2, diabetes_ed: 2, tumor_no_meta: 2, leukemia: 2, lymphoma: 2,
        liver_mod_sev: 3, tumor_meta: 6, aids: 6
    };

    function populateCciConditions() {
        if (!cciConditionsContainer) return;
        cciConditionsContainer.innerHTML = ''; 
        Object.keys(cciConditionPoints).forEach(key => {
            const conditionName = translations[currentLanguage]?.[key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const points = cciConditionPoints[key];
            const label = document.createElement('label');
            label.className = 'flex items-center space-x-3 p-2.5 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer transition-colors duration-150';
            label.innerHTML = `
                <input type="checkbox" name="cci_condition" value="${points}" data-condition-key="${key}" class="form-checkbox h-4 w-4 text-blue-600 border-slate-300 dark:border-slate-500 rounded bg-white dark:bg-slate-600 focus:ring-blue-500 focus:ring-offset-0 dark:focus:ring-offset-slate-800">
                <span class="text-slate-700 dark:text-slate-300">${conditionName} <span class="text-xs text-slate-500 dark:text-slate-400">(+${points})</span></span>
            `;
            cciConditionsContainer.appendChild(label);
        });
        cciConditionsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
            checkbox.addEventListener('change', updateCciScoreDisplayFromModal);
        });
    }

    function updateCciScoreDisplayFromModal() {
        if (!cciScoreDisplay || !cciConditionsContainer) return;
        let totalCciPoints = 0;
        cciConditionsContainer.querySelectorAll('input[type="checkbox"][name="cci_condition"]:checked').forEach(checkbox => {
            totalCciPoints += parseInt(checkbox.value);
        });
        cciScoreDisplay.textContent = totalCciPoints;
    }

    if(openCciModalButton) openCciModalButton.addEventListener('click', () => { if(cciModal) { cciModal.classList.remove('hidden'); document.body.classList.add('modal-active-body-scroll-lock'); updateCciScoreDisplayFromModal(); }});
    if(closeCciModalButton) closeCciModalButton.addEventListener('click', () => { if(cciModal) { cciModal.classList.add('hidden'); document.body.classList.remove('modal-active-body-scroll-lock'); }});
    if(cancelCciButton) cancelCciButton.addEventListener('click', () => { if(cciModal) { cciModal.classList.add('hidden'); document.body.classList.remove('modal-active-body-scroll-lock'); }});
    if(applyCciButton) applyCciButton.addEventListener('click', () => {
        if(mainCciInput && cciScoreDisplay && mainCciSlider) {
            let newCciValue = parseInt(cciScoreDisplay.textContent);
            const cciMax = parseInt(mainCciInput.max);
            const cciMin = parseInt(mainCciInput.min);
            
            if (newCciValue > cciMax) { // If calculated CCI exceeds main form's CCI input max (e.g. 9)
                 alert((translations[currentLanguage].errorRange || "CCI must be between {min} and {max}.")
                    .replace('{label}', translations[currentLanguage].labelCCI || "CCI")
                    .replace('{min}', cciMin)
                    .replace('{max}', cciMax) + 
                    (currentLanguage === 'zh' ? `\n计算器计算的CCI总分为 ${newCciValue}，将使用主输入框允许的最大值 ${cciMax}。原始ARISE列线图CCI上限为9。` : `\nCalculated CCI score is ${newCciValue}, will use max allowed value ${cciMax} for the input field. Original ARISE nomogram CCI max is 9.` )
                 );
                newCciValue = cciMax; // Cap at main input's max
            }
            mainCciInput.value = newCciValue;
            mainCciSlider.value = newCciValue; // Sync slider
        }
        if(cciModal) { cciModal.classList.add('hidden'); document.body.classList.remove('modal-active-body-scroll-lock');}
        validateSingleField('cci', mainCciInput.value, mainFormSchema.cci.min, mainFormSchema.cci.max, true, true);
    });

    // --- LVESDi Estimator Logic ---
    const toggleLvesdiEstimatorButton = document.getElementById('toggleLvesdiEstimatorButton');
    const lvesdiEstimatorSection = document.getElementById('lvesdiEstimatorSection');
    const lvesdiEstimatorIcon = document.getElementById('lvesdiEstimatorIcon');
    const calculateLvesdiButton = document.getElementById('calculateLvesdiButton');
    const lvesdiEstimationResultEl = document.getElementById('lvesdiEstimationResult');
    const mainLvesdiInput = document.getElementById('lvesdi');
    const mainLvesdiSlider = document.getElementById('lvesdi_slider');

    if(toggleLvesdiEstimatorButton) toggleLvesdiEstimatorButton.addEventListener('click', () => {
        if(lvesdiEstimatorSection) lvesdiEstimatorSection.classList.toggle('hidden');
        if(lvesdiEstimatorIcon) {
            lvesdiEstimatorIcon.classList.toggle('fa-chevron-down');
            lvesdiEstimatorIcon.classList.toggle('fa-chevron-up');
        }
    });
    
    const estimatorSchema = {
        estimatorLvdd: { min: 20, max: 100, labelKey: "labelLVDD", isInteger: true }, // LVDd typically integer
        estimatorHeight: { min: 100, max: 250, labelKey: "labelHeight", isInteger: true },
        estimatorWeight: { min: 20, max: 250, labelKey: "labelWeight", isInteger: false, step: 0.1 } // Weight can be decimal
    };

    if(calculateLvesdiButton) calculateLvesdiButton.addEventListener('click', () => {
        if(lvesdiEstimationResultEl) {
            lvesdiEstimationResultEl.textContent = '';
            lvesdiEstimationResultEl.classList.remove('text-red-500');
        }
        let estimatorValid = true;
        
        const lvddValRes = validateSingleField('estimatorLvdd', document.getElementById('estimatorLvdd').value, estimatorSchema.estimatorLvdd.min, estimatorSchema.estimatorLvdd.max, true, estimatorSchema.estimatorLvdd.isInteger);
        const heightValRes = validateSingleField('estimatorHeight', document.getElementById('estimatorHeight').value, estimatorSchema.estimatorHeight.min, estimatorSchema.estimatorHeight.max, true, estimatorSchema.estimatorHeight.isInteger);
        const weightValRes = validateSingleField('estimatorWeight', document.getElementById('estimatorWeight').value, estimatorSchema.estimatorWeight.min, estimatorSchema.estimatorWeight.max, true, estimatorSchema.estimatorWeight.isInteger);
        
        const mainLvefInputEl = document.getElementById('lvef');
        const mainLvefSchema = mainFormSchema.lvef;
        const lvefValidation = validateSingleField('lvef', mainLvefInputEl.value, mainLvefSchema.min, mainLvefSchema.max, true, mainLvefSchema.isInteger);

        if (!lvddValRes || !heightValRes || !weightValRes || !lvefValidation) { // Simpler check if any failed
            estimatorValid = false;
        }
         if (!lvefValidation) { // Specific error for LVEF if it's the one failing from main form
            const lvefErrorElement = document.getElementById('lvefError'); // Main LVEF error field
            if (lvefErrorElement && lvesdiEstimationResultEl) {
                lvesdiEstimationResultEl.textContent = translations[currentLanguage].errorLVEFForEstimator;
                lvesdiEstimationResultEl.classList.add('text-red-500');
            }
        }

        if (!estimatorValid) {
            if(lvesdiEstimationResultEl && !lvesdiEstimationResultEl.textContent) { // If no specific LVEF error shown
                 lvesdiEstimationResultEl.textContent = translations[currentLanguage].lvesdiNotCalculated;
                 lvesdiEstimationResultEl.classList.add('text-red-500');
            }
            return;
        }

        const lvef = parseInt(mainLvefInputEl.value);
        const lvdd_mm = parseInt(document.getElementById('estimatorLvdd').value);
        const height_cm = parseInt(document.getElementById('estimatorHeight').value);
        const weight_kg = parseFloat(document.getElementById('estimatorWeight').value);

        const bsa_m2 = 0.007184 * Math.pow(height_cm, 0.725) * Math.pow(weight_kg, 0.425);
        const lvesd_mm_cubed = Math.pow(lvdd_mm, 3) * (1 - (lvef / 100));
        const lvesd_mm = Math.cbrt(lvesd_mm_cubed);
        let lvesdi_estimated = lvesd_mm / bsa_m2;

        if (!isNaN(lvesdi_estimated) && isFinite(lvesdi_estimated)) {
            // LVESDi in main form is integer, so round the estimation
            const finalLvesdiToFill = Math.round(lvesdi_estimated); 
            
            const mainLvesdiMin = parseInt(mainLvesdiInput.min);
            const mainLvesdiMax = parseInt(mainLvesdiInput.max);
            let clampedLvesdi = finalLvesdiToFill;

            if (finalLvesdiToFill < mainLvesdiMin) {
                clampedLvesdi = mainLvesdiMin;
                 alert((translations[currentLanguage].errorRange || "{label} must be an integer between {min} and {max}.")
                    .replace('{label}', translations[currentLanguage].labelLVESDi || "LVESDi")
                    .replace('{min}', mainLvesdiMin)
                    .replace('{max}', mainLvesdiMax) + 
                    (currentLanguage === 'zh' ? `\n估算结果为 ${finalLvesdiToFill} (原始值 ${lvesdi_estimated.toFixed(1)})，将使用允许的最小值 ${mainLvesdiMin}。` : `\nEstimation result is ${finalLvesdiToFill} (raw ${lvesdi_estimated.toFixed(1)}), will use min allowed value ${mainLvesdiMin}.` )
                 );
            } else if (finalLvesdiToFill > mainLvesdiMax) {
                clampedLvesdi = mainLvesdiMax;
                alert((translations[currentLanguage].errorRange || "{label} must be an integer between {min} and {max}.")
                    .replace('{label}', translations[currentLanguage].labelLVESDi || "LVESDi")
                    .replace('{min}', mainLvesdiMin)
                    .replace('{max}', mainLvesdiMax) + 
                    (currentLanguage === 'zh' ? `\n估算结果为 ${finalLvesdiToFill} (原始值 ${lvesdi_estimated.toFixed(1)})，将使用允许的最大值 ${mainLvesdiMax}。` : `\nEstimation result is ${finalLvesdiToFill} (raw ${lvesdi_estimated.toFixed(1)}), will use max allowed value ${mainLvesdiMax}.` )
                 );
            }
            
            mainLvesdiInput.value = clampedLvesdi;
            if(mainLvesdiSlider) mainLvesdiSlider.value = clampedLvesdi;

            if(lvesdiEstimationResultEl) lvesdiEstimationResultEl.textContent = (translations[currentLanguage].lvesdiCalculated)
                .replace('{value}', clampedLvesdi)
                .replace('{bsa}', bsa_m2.toFixed(2));
            
            validateSingleField('lvesdi', mainLvesdiInput.value, mainFormSchema.lvesdi.min, mainFormSchema.lvesdi.max, true, mainFormSchema.lvesdi.isInteger);
        } else {
            if(lvesdiEstimationResultEl) {
                lvesdiEstimationResultEl.textContent = translations[currentLanguage].lvesdiNotCalculated;
                lvesdiEstimationResultEl.classList.add('text-red-500');
            }
        }
    });

    // Chart.js Integration
    function initChart() {
        const ctx = document.getElementById('survivalCurveChart');
        if (!ctx) return;
        const data = {
            labels: [ /* Populated by updateAllText */ ],
            datasets: [
                { label: /* Populated */ '', data: [100, null, null, null], borderColor: 'rgb(239, 68, 68)', backgroundColor: 'rgba(239, 68, 68, 0.1)', tension: 0.2, fill: true, pointRadius: 5, pointHoverRadius: 7, pointBackgroundColor: 'rgb(239, 68, 68)'},
                { label: /* Populated */ '', data: [100, null, null, null], borderColor: 'rgb(59, 130, 246)', backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.2, fill: true, pointRadius: 5, pointHoverRadius: 7, pointBackgroundColor: 'rgb(59, 130, 246)'}
            ]
        };
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx.getContext('2d'), {
            type: 'line', data: data,
             options: {
                responsive: true, maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true, max: 100,
                        title: { display: true, text: (translations[currentLanguage]?.chartLabelSurvivalRate || 'Survival Rate (%)'), color: document.body.classList.contains('dark') ? '#94A3B8' : '#4B5563', font: {size: 12} },
                        grid: { color: document.body.classList.contains('dark') ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.05)' },
                        ticks: { color: document.body.classList.contains('dark') ? '#CBD5E1' : '#6B7280', stepSize: 20, callback: value => value + '%' }
                    },
                    x: {
                        title: { display: true, text: (translations[currentLanguage]?.chartLabelTimeYears || 'Time (Years)'), color: document.body.classList.contains('dark') ? '#94A3B8' : '#4B5563', font: {size: 12} },
                        grid: { display: false },
                        ticks: { color: document.body.classList.contains('dark') ? '#CBD5E1' : '#6B7280' }
                    }
                },
                plugins: {
                    legend: { position: 'bottom', labels: { color: document.body.classList.contains('dark') ? '#E2E8F0' : '#374151', font: {size: 11}, usePointStyle: true, padding: 15 } },
                    tooltip: {
                        mode: 'index', intersect: false, titleFont: {size: 13}, bodyFont: {size: 11},
                        callbacks: { label: context => `${context.dataset.label || ''}: ${context.parsed.y.toFixed(1)}%` }
                    }
                },
                elements: { line: { borderWidth: 2 }, point: { hitRadius: 10 } }
            }
        });
    }

    function updateChart(totalPoints, survivalProbs) { // totalPoints is {noAVS, yesAVS}, survivalProbs is {noAVS: {oneYear,...}, yesAVS: {oneYear,...}}
        if (!chartInstance || !survivalProbs || !survivalProbs.noAVS || !survivalProbs.yesAVS) return;
        
        const lang = currentLanguage; // Capture current language for consistent labels
        chartInstance.data.labels = [
            translations[lang].chartLabelBaseline,
            `1 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`, // "1 年" or "1 Year"
            `3 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`,
            `5 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`
        ];
        chartInstance.data.datasets[0].label = translations[lang].chartSurvivalNoAVS;
        chartInstance.data.datasets[0].data = [ 100, survivalProbs.noAVS.oneYear * 100, survivalProbs.noAVS.threeYear * 100, survivalProbs.noAVS.fiveYear * 100 ];
        
        chartInstance.data.datasets[1].label = translations[lang].chartSurvivalYesAVS;
        chartInstance.data.datasets[1].data = [ 100, survivalProbs.yesAVS.oneYear * 100, survivalProbs.yesAVS.threeYear * 100, survivalProbs.yesAVS.fiveYear * 100 ];
        
        chartInstance.options.scales.y.title.text = translations[lang].chartLabelSurvivalRate;
        chartInstance.options.scales.x.title.text = translations[lang].chartLabelTimeYears;
        chartInstance.update();
    }
    
    // Initial setup on DOMContentLoaded
    function initializeApp() {
        // Set year in footer
        const currentYearSpan = document.getElementById('currentYear');
        if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();

        // Language setup: default to Chinese if no preference
        const savedLang = localStorage.getItem('ariseCalculatorLanguage');
        if (savedLang && translations[savedLang]) {
            currentLanguage = savedLang;
        } else {
            currentLanguage = 'zh'; // Default to Chinese
        }
        if(languageSelector) languageSelector.value = currentLanguage;
        
        populateCciConditions(); // Needs to be done before first updateAllText if modal elements use data-lang-key
        showTab('who'); // Set default tab
        updateAllText(); // Apply language to all elements
        
        // Clear results and set up empty chart, NO auto-calculation or default value filling beyond HTML defaults
        inputsConfig.forEach(conf => { // Set inputs to their HTML 'value' or min if slider
            const numInput = document.getElementById(conf.id);
            const sliderInput = document.getElementById(conf.sliderId);
            if(numInput && sliderInput){
                numInput.value = numInput.defaultValue || conf.defaultVal; // Keep HTML default
                sliderInput.value = numInput.defaultValue || conf.defaultVal;
            }
        });
        // Reset select elements to their first option or HTML default
        if(document.getElementById('sex')) document.getElementById('sex').value = document.getElementById('sex').options[0].value;
        if(document.getElementById('nyha')) document.getElementById('nyha').value = document.getElementById('nyha').options[0].value;

        clearResultsAndNomogramPoints(); // This will also init an empty chart
    }

    initializeApp();
});
</script>
</body>
</html>