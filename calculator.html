<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ARISE Score 预后评估工具 - HeartValve 专家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .tab-button.active {
            @apply bg-white text-slate-950 border-slate-300 shadow-sm;
        }
        .tab-button {
            @apply py-2 px-4 text-sm font-semibold text-slate-600 bg-slate-100 hover:bg-slate-200 border border-transparent rounded-t-lg;
        }
        .tab-content {
            @apply p-6 border border-slate-300 rounded-b-lg rounded-tr-lg bg-white shadow-sm;
        }
        input[type="number"] {
            @apply flex h-10 w-24 text-center rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2;
        }
        select {
             @apply flex h-10 w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2;
        }
        input[type="range"] {
            @apply w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer dark:bg-slate-700;
        }
        input[type="range"]::-webkit-slider-thumb {
            @apply appearance-none w-5 h-5 bg-blue-600 rounded-full cursor-pointer hover:bg-blue-700 active:bg-blue-800;
        }
        input[type="range"]::-moz-range-thumb {
            @apply w-5 h-5 bg-blue-600 rounded-full cursor-pointer border-0 hover:bg-blue-700 active:bg-blue-800;
        }

        .nomogram-placeholder {
            @apply border border-dashed border-slate-300 p-4 mb-4 text-center text-slate-500 bg-slate-50 rounded;
        }
        .nomogram-axis { @apply mb-1 text-sm; }
        .nomogram-label { @apply text-slate-700;}
        .nomogram-value { @apply font-semibold text-blue-700;}
        .points-line-container {
            @apply relative h-4 bg-slate-200 rounded mt-1 mb-4 w-full;
        }
        .points-line-marker {
            @apply absolute top-1/2 h-5 w-auto px-1 bg-red-500 rounded text-white text-xs flex items-center justify-center transform -translate-y-1/2 shadow;
            min-width: 20px;
        }
        .points-line-marker::after {
            @apply content-[''] absolute -bottom-1 left-1/2 transform -translate-x-1/2 w-0 h-0 border-l-[6px] border-l-transparent border-r-[6px] border-r-transparent border-t-[6px] border-t-red-500;
        }

        .results-table th, .results-table td { @apply border border-slate-300 px-3 py-2 text-sm; }
        .results-table th { @apply bg-slate-100 font-semibold text-slate-700 text-center; }
        .results-table td { @apply text-slate-800 text-center; }
        .results-table td:first-child { @apply text-left font-medium; }

        .nav-link-active {
            @apply text-blue-600 font-semibold;
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800">

    <nav class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-700">HeartValve 专家</a>
            <div>
                <a href="index.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">首页</a>
                <a href="calculator.html" class="nav-link-active px-3 py-2 rounded-md text-sm">ARISE Score 工具</a>
                <a href="disease-info.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">疾病知识</a>
                <a href="surgical-options.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">手术方案</a>
                <a href="expert-views.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">专家视角</a>
                <a href="about.html" class="text-gray-700 hover:text-blue-600 px-3 py-2 rounded-md text-sm font-medium">关于我们</a>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="pb-6 xl:pb-8 2xl:pb-10 space-y-1">
            <h1 class="font-semibold text-[22px] md:text-2xl 2xl:text-3xl text-gray-700">ARISE (Aortic Regurgitation/Insufficiency Survival Estimation) Score</h1>
            <h2 class="text-slate-500 text-sm md:text-base 2xl:text-lg">用于评估中重度至重度慢性主动脉瓣反流患者在3个月内接受或不接受主动脉瓣修复/置换术的生存率。</h2>
        </div>

        <div class="lg:grid lg:grid-cols-12 lg:gap-6 xl:gap-8">
            <section class="lg:col-span-5 space-y-6">
                <div class="mb-4">
                    <div class="flex border-b border-slate-300">
                        <button id="tab-who" class="tab-button active" onclick="showTab('who')">适用人群 (Who)</button>
                        <button id="tab-how" class="tab-button" onclick="showTab('how')">如何使用 (How)</button>
                        <button id="tab-why" class="tab-button" onclick="showTab('why')">为何使用 (Why)</button>
                    </div>
                    <div id="content-who" class="tab-content">适用于患有 **中重度至重度慢性主动脉瓣反流 (AR)** 的患者。</div>
                    <div id="content-how" class="tab-content hidden">通过该工具**估算和比较**在接受或不接受主动脉瓣修复/置换术情况下，患者1年、3年和5年的生存率。生存率根据低、中、高三个风险等级进行分层。虽然我们的列线图提供了生存率估算，但在共同决策过程中，必须综合考虑基线生存轨迹、净手术获益以及指南建议。</div>
                    <div id="content-why" class="tab-content hidden">此工具专为日常实践中的**个体化风险评估**而设计，帮助医生清晰地沟通手术的获益与风险，从而加强医患关系。</div>
                </div>

                <div class="rounded-lg border border-slate-300 bg-white text-slate-950 shadow-lg">
                    <form id="ariseForm" class="p-6 space-y-5">
                        <div>
                            <label for="age" class="font-medium text-md flex items-center">年龄 (Age) <span class="text-slate-500 text-xs ml-1">(10-100 岁)</span></label>
                            <div class="flex items-center mt-1 space-x-3">
                                <input type="range" id="age_slider" name="age_slider" min="10" max="100" value="20" step="1">
                                <input type="number" id="age" name="age" min="10" max="100" value="20" step="1">
                            </div>
                        </div>
                        <div>
                            <label for="sex" class="font-medium text-md block">性别 (Sex)</label>
                            <select id="sex" name="sex" class="mt-1">
                                <option value="male">男性 (Male)</option>
                                <option value="female">女性 (Female)</option>
                            </select>
                        </div>
                        <div>
                            <label for="cci" class="font-medium text-md flex items-center">CCI评分 <span class="text-slate-500 text-xs ml-1">(0-9 分)</span></label>
                            <div class="flex items-center mt-1 space-x-3">
                                <input type="range" id="cci_slider" name="cci_slider" min="0" max="9" value="0" step="1">
                                <input type="number" id="cci" name="cci" min="0" max="9" value="0" step="1">
                            </div>
                        </div>
                        <div>
                            <label for="nyha" class="font-medium text-md block">NYHA 心功能分级</label>
                            <select id="nyha" name="nyha" class="mt-1">
                                <option value="1">NYHA I</option>
                                <option value="2">NYHA II</option>
                                <option value="3">NYHA III</option>
                                <option value="4">NYHA IV</option>
                            </select>
                        </div>
                        <div>
                            <label for="aodi" class="font-medium text-md flex items-center">主动脉根部内径指数 (AoDi) <span class="text-slate-500 text-xs ml-1">(15-70 mm/m²)</span></label>
                            <div class="flex items-center mt-1 space-x-3">
                                <input type="range" id="aodi_slider" name="aodi_slider" min="15" max="70" value="25" step="0.1">
                                <input type="number" id="aodi" name="aodi" min="15" max="70" value="25" step="0.1">
                            </div>
                        </div>
                        <div>
                            <label for="lvef" class="font-medium text-md flex items-center">左室射血分数 (LVEF) <span class="text-slate-500 text-xs ml-1">(20-80 %)</span></label>
                            <div class="flex items-center mt-1 space-x-3">
                                <input type="range" id="lvef_slider" name="lvef_slider" min="20" max="80" value="60" step="0.1">
                                <input type="number" id="lvef" name="lvef" min="20" max="80" value="60" step="0.1">
                            </div>
                        </div>
                        <div>
                            <label for="lvesdi" class="font-medium text-md flex items-center">左室收缩末期内径指数 (LVESDi) <span class="text-slate-500 text-xs ml-1">(10-50 mm/m²)</span></label>
                            <div class="flex items-center mt-1 space-x-3">
                                <input type="range" id="lvesdi_slider" name="lvesdi_slider" min="10" max="50" value="20" step="0.1">
                                <input type="number" id="lvesdi" name="lvesdi" min="10" max="50" value="20" step="0.1">
                            </div>
                        </div>

                        <div class="flex justify-between gap-3 pt-4">
                            <button type="button" id="resetButton" class="bg-slate-200 hover:bg-slate-300 text-slate-800 h-10 px-4 py-2 rounded-md text-sm font-medium">重置 (Reset)</button>
                            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white h-10 px-6 py-2 rounded-md text-base font-medium">提交 (Submit)</button>
                        </div>
                        <div id="validationError" class="text-red-500 text-sm mt-2"></div>
                    </form>
                </div>
            </section>

            <section class="lg:col-span-7 space-y-6 mt-8 lg:mt-0">
                <div class="rounded-lg border border-slate-300 bg-white text-slate-950 shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">预后列线图与点数 (Prognostic Nomogram & Points)</h3>
                    <div class="nomogram-placeholder">
                        <p>列线图 (Nomogram) 图形区域</p>
                        <p class="text-xs mt-2">(官网的动态SVG列线图需要 `nomogram-template.min.svg` 文件和专门的JavaScript绘图代码。下方仅为数值点数展示和简易标尺。)</p>
                    </div>
                    <div id="nomogram-points-display" class="space-y-2 text-sm mb-6">
                        <div class="font-semibold text-slate-800">各变量点数:</div>
                        <div class="nomogram-axis"><span class="nomogram-label">年龄 (Age, year):</span> <span id="nomogram_age_points" class="nomogram-value">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label">性别 (Sex):</span> <span id="nomogram_sex_points" class="nomogram-value">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label">CCI:</span> <span id="nomogram_cci_points" class="nomogram-value">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label">NYHA 分级 (NYHA, class):</span> <span id="nomogram_nyha_points" class="nomogram-value">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label">AoDi (mm/m²):</span> <span id="nomogram_aodi_points" class="nomogram-value">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label">LVEF (%):</span> <span id="nomogram_lvef_points" class="nomogram-value">0</span> points</div>
                        <div class="nomogram-axis"><span class="nomogram-label">LVESDi (mm/m²):</span> <span id="nomogram_lvesdi_points" class="nomogram-value">0</span> points</div>
                        <hr class="my-3 border-slate-300">
                        <div class="nomogram-axis font-bold"><span class="nomogram-label">总点数 (3月内未行AVS):</span> <span id="nomogram_total_points_no" class="nomogram-value">0</span></div>
                        <div class="points-line-container">
                             <div id="marker_no_avs" class="points-line-marker" style="left: 0%;">0</div>
                        </div>
                        <div class="nomogram-axis font-bold"><span class="nomogram-label">总点数 (3月内已行AVS):</span> <span id="nomogram_total_points_yes" class="nomogram-value">0</span></div>
                        <div class="points-line-container">
                             <div id="marker_yes_avs" class="points-line-marker" style="left: 0%;">0</div>
                        </div>
                        <p class="text-xs text-slate-500 mt-1">点数标尺估算范围: 0 到 150</p>
                    </div>

                    <h3 class="text-xl font-semibold mb-3 text-gray-700">生存率估算与风险分级 (Survival Estimation & Risk Group)</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full results-table text-left">
                            <thead>
                                <tr>
                                    <th class="whitespace-nowrap">参数</th>
                                    <th class="whitespace-nowrap">3月内未行AVS</th>
                                    <th class="whitespace-nowrap">3月内已行AVS</th>
                                    <th class="whitespace-nowrap">AVS生存获益</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody">
                                <tr>
                                    <td class="font-medium">总点数 (取整)</td>
                                    <td id="totalPoints_no">--</td>
                                    <td id="totalPoints_yes">--</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td class="font-medium">1年生存率</td>
                                    <td id="survival_1y_no">--</td>
                                    <td id="survival_1y_yes">--</td>
                                    <td id="benefit_1y">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">3年生存率</td>
                                    <td id="survival_3y_no">--</td>
                                    <td id="survival_3y_yes">--</td>
                                    <td id="benefit_3y">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">5年生存率</td>
                                    <td id="survival_5y_no">--</td>
                                    <td id="survival_5y_yes">--</td>
                                    <td id="benefit_5y">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium">风险分组</td>
                                    <td id="riskGroup_no">--</td>
                                    <td id="riskGroup_yes">--</td>
                                    <td></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 text-gray-300 py-8 text-center mt-12">
        <div class="container mx-auto px-6">
            <p>&copy; 2025 HeartValve 专家. 版权所有.</p>
            <p class="text-sm mt-2">本网站信息仅供参考，不能替代专业医疗建议、诊断或治疗。</p>
        </div>
    </footer>

<script>
// =============================================================================
// ARISE Score Calculator - Full Calculation Logic
// Version: 2025-06-02 (Based on confirmed logic from arise-score.vercel.app)
// =============================================================================
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('ariseForm');
    const resetButton = document.getElementById('resetButton');
    const validationErrorDiv = document.getElementById('validationError');

    const inputsConfig = [
        { id: 'age',    sliderId: 'age_slider',    min: 10, max: 100, default: 20, step: 1 },
        { id: 'cci',    sliderId: 'cci_slider',    min: 0,  max: 9,   default: 1,  step: 1 }, // Default CCI set to 1 for example
        { id: 'aodi',   sliderId: 'aodi_slider',   min: 15, max: 70,  default: 25, step: 0.1 },
        { id: 'lvef',   sliderId: 'lvef_slider',   min: 20, max: 80,  default: 60, step: 0.1 },
        { id: 'lvesdi', sliderId: 'lvesdi_slider', min: 10, max: 50,  default: 20, step: 0.1 }
    ];

    function setDefaultFormValues() {
        inputsConfig.forEach(conf => {
            document.getElementById(conf.id).value = conf.default;
            if (document.getElementById(conf.sliderId)) {
                document.getElementById(conf.sliderId).value = conf.default;
            }
        });
        document.getElementById('sex').value = "male";
        document.getElementById('nyha').value = "1";
        // Trigger a calculation with default values if desired
        // form.dispatchEvent(new Event('submit', { cancelable: true }));
    }

    inputsConfig.forEach(inputConf => {
        const numberInput = document.getElementById(inputConf.id);
        const sliderInput = document.getElementById(inputConf.sliderId);
        if (numberInput && sliderInput) {
            sliderInput.step = inputConf.step;
            numberInput.step = inputConf.step;
            sliderInput.addEventListener('input', () => {
                const precision = inputConf.step.toString().includes('.') ? inputConf.step.toString().split('.')[1].length : 0;
                numberInput.value = parseFloat(sliderInput.value).toFixed(precision);
            });
            numberInput.addEventListener('input', () => {
                let value = parseFloat(numberInput.value);
                if (isNaN(value)) value = inputConf.default;
                value = Math.max(inputConf.min, Math.min(inputConf.max, value));
                const precision = inputConf.step.toString().includes('.') ? inputConf.step.toString().split('.')[1].length : 0;
                numberInput.value = value.toFixed(precision);
                sliderInput.value = value;
            });
        }
    });

    window.showTab = function(tabName) {
        const contents = ['who', 'how', 'why'];
        contents.forEach(content => {
            document.getElementById('content-' + content).classList.add('hidden');
            const tabButton = document.getElementById('tab-' + content);
            tabButton.classList.remove('active', 'bg-white', 'text-slate-950', 'border-slate-300', 'shadow-sm');
            tabButton.classList.add('bg-slate-100', 'text-slate-600', 'border-transparent');
        });
        document.getElementById('content-' + tabName).classList.remove('hidden');
        const activeTabButton = document.getElementById('tab-' + tabName);
        activeTabButton.classList.add('active', 'bg-white', 'text-slate-950', 'border-slate-300', 'shadow-sm');
        activeTabButton.classList.remove('bg-slate-100', 'text-slate-600', 'border-transparent');
    }
    showTab('who'); // Initialize with the 'who' tab visible

    const schema = {
        age:    { min: 10, max: 100, message: "年龄必须在 10 到 100 岁之间。" },
        sex:    { enum: ["male", "female"], message: "性别必须选择“男性”或“女性”。" },
        cci:    { min: 0,  max: 9,   message: "CCI 评分必须在 0 到 9 分之间。" },
        nyha:   { enum: ["1", "2", "3", "4"], message: "NYHA 心功能分级必须是 I, II, III, 或 IV 级。" },
        aodi:   { min: 15, max: 70,  message: "AoDi 必须在 15 到 70 mm/m² 之间。" },
        lvef:   { min: 20, max: 80,  message: "LVEF 必须在 20 到 80 % 之间。" },
        lvesdi: { min: 10, max: 50,  message: "LVESDi 必须在 10 到 50 mm/m² 之间。" }
    };

    function validateInput(name, value, label) {
        const rule = schema[name];
        if (!rule) return null;
        const numValue = (name !== 'sex' && name !== 'nyha') ? parseFloat(value) : value;

        if (value === '' || ( (typeof rule.min !== 'undefined' || typeof rule.max !== 'undefined') && isNaN(numValue) ) ) {
            return `${label}：请输入一个有效的值。`;
        }
        if (rule.enum && !rule.enum.includes(numValue)) return rule.message;
        if (typeof rule.min !== 'undefined' && numValue < rule.min) return rule.message;
        if (typeof rule.max !== 'undefined' && numValue > rule.max) return rule.message;
        return null;
    }

    // --- ARISE SCORE CALCULATION LOGIC (Module 3448 & 9168 derived) ---
    const RISK_THRESHOLDS = {
        Low: 0,
        Intermediate: 85,
        High: 107
    };

    function calculateFactorPoints_ARISE(factors) {
        const { age, sex, cci, nyha, aodi, lvef, lvesdi } = factors;
        return {
            age: -11.111111 + 1.111111 * parseFloat(age),
            sex: "female" === sex ? 5.092295 : 0,
            cci: 0 + 3.49046 * parseFloat(cci),
            nyha: -3.541039 + 3.541039 * parseInt(nyha),
            aodi: -7.241847 + 0.48279 * parseFloat(aodi),
            lvef: 21.697412 - 0.271218 * parseFloat(lvef),
            lvesdi: -4.527494 + 0.452749 * parseFloat(lvesdi)
        };
    }

    function calculateRawTotalPoints_ARISE(factorPoints) {
        let sumOfFactorPoints = Object.values(factorPoints).reduce((sum, points) => sum + (points != null ? points : 0), 0);
        if (sumOfFactorPoints < 1e-6 && sumOfFactorPoints > -1e-6) {
            sumOfFactorPoints = 0;
        }
        const avsOffset = 11.042254;
        return [sumOfFactorPoints + avsOffset, sumOfFactorPoints]; // [NO AVS total_raw, YES AVS total_raw]
    }

    function calculateSurvivalProbabilities_ARISE(rawTotalPointsMatrix) {
        const [rawTotalPointsNoAVS, rawTotalPointsYesAVS] = rawTotalPointsMatrix;
        const getProbs = (totalPoints) => {
            const linearPredictor = (totalPoints - 93.903984) / 18.131663;
            const expLP = Math.exp(linearPredictor);
            return {
                oneYear: Math.pow(0.977952, expLP),
                threeYear: Math.pow(0.9343029, expLP),
                fiveYear: Math.pow(0.8886656, expLP)
            };
        };
        return {
            noAVS: getProbs(rawTotalPointsNoAVS),
            yesAVS: getProbs(rawTotalPointsYesAVS)
        };
    }

    function calculateRiskGroups_ARISE(truncatedTotalPointsMatrix) {
        const [truncatedTotalPointsNoAVS, truncatedTotalPointsYesAVS] = truncatedTotalPointsMatrix;
        const getGroup = (points) => {
            if (points < RISK_THRESHOLDS.Intermediate) return "低风险 (Low)";
            if (points < RISK_THRESHOLDS.High) return "中等风险 (Intermediate)";
            return "高风险 (High)";
        };
        return {
            noAVS: getGroup(truncatedTotalPointsNoAVS),
            yesAVS: getGroup(truncatedTotalPointsYesAVS)
        };
    }

    function getAriseScoreCalculatorResults_Main(factors) {
        const factorPoints = calculateFactorPoints_ARISE(factors);
        const rawTotalPointsMatrix = calculateRawTotalPoints_ARISE(factorPoints);
        const truncatedTotalPointsMatrix = rawTotalPointsMatrix.map(points => Math.trunc(points));
        const survivalProbabilities = calculateSurvivalProbabilities_ARISE(rawTotalPointsMatrix);
        const riskGroups = calculateRiskGroups_ARISE(truncatedTotalPointsMatrix); // Pass truncated points

        return {
            "输入参数": factors,
            "各项风险点数": {
                "年龄点数": factorPoints.age,
                "性别点数": factorPoints.sex,
                "CCI点数": factorPoints.cci,
                "NYHA分级点数": factorPoints.nyha,
                "AoDi点数": factorPoints.aodi,
                "LVEF点数": factorPoints.lvef,
                "LVESDi点数": factorPoints.lvesdi
            },
            "总风险点数": {
                "3月内未行AVS手术_原始值": rawTotalPointsMatrix[0],
                "3月内行AVS手术_原始值": rawTotalPointsMatrix[1],
                "3月内未行AVS手术_取整": truncatedTotalPointsMatrix[0],
                "3月内行AVS手术_取整": truncatedTotalPointsMatrix[1]
            },
            "生存概率": survivalProbabilities,
            "风险分组": riskGroups
        };
    }
    // --- End of ARISE SCORE CALCULATION LOGIC ---

    const NOMOGRAM_TOTAL_POINTS_MAX_SCALE = 150;

    form.addEventListener('submit', function (event) {
        event.preventDefault();
        validationErrorDiv.textContent = '';

        const rawInputs = {
            age:    document.getElementById('age').value,
            sex:    document.getElementById('sex').value,
            cci:    document.getElementById('cci').value,
            nyha:   document.getElementById('nyha').value,
            aodi:   document.getElementById('aodi').value,
            lvef:   document.getElementById('lvef').value,
            lvesdi: document.getElementById('lvesdi').value
        };

        let isValid = true;
        let errorMessages = [];
        const factorLabels = { age: "年龄", sex: "性别", cci: "CCI评分", nyha: "NYHA分级", aodi: "AoDi", lvef: "LVEF", lvesdi: "LVESDi" };

        for (const key in rawInputs) {
            const error = validateInput(key, rawInputs[key], factorLabels[key]);
            if (error) {
                isValid = false;
                errorMessages.push(error);
            }
        }

        if (!isValid) {
            validationErrorDiv.innerHTML = errorMessages.join('<br>');
            clearResultsAndNomogramPoints();
            return;
        }
        
        // Convert to numbers after validation (except for sex and nyha which are handled in calculation)
        const processedInputs = {
            age:    parseFloat(rawInputs.age),
            sex:    rawInputs.sex,
            cci:    parseFloat(rawInputs.cci),
            nyha:   rawInputs.nyha,
            aodi:   parseFloat(rawInputs.aodi),
            lvef:   parseFloat(rawInputs.lvef),
            lvesdi: parseFloat(rawInputs.lvesdi)
        };


        const results = getAriseScoreCalculatorResults_Main(processedInputs);
        
        updateNomogramPointsDisplay(results.各项风险点数, results.总风险点数);
        updateResultsTable(results.总风险点数, results.生存概率, results.风险分组);
    });
    
    function updateNomogramPointsDisplay(perVarScores, totalPts) {
        document.getElementById('nomogram_age_points').textContent = perVarScores.年龄点数.toFixed(1);
        document.getElementById('nomogram_sex_points').textContent = perVarScores.性别点数.toFixed(1);
        document.getElementById('nomogram_cci_points').textContent = perVarScores.CCI点数.toFixed(1);
        document.getElementById('nomogram_nyha_points').textContent = perVarScores.NYHA分级点数.toFixed(1);
        document.getElementById('nomogram_aodi_points').textContent = perVarScores.AoDi点数.toFixed(1);
        document.getElementById('nomogram_lvef_points').textContent = perVarScores.LVEF点数.toFixed(1);
        document.getElementById('nomogram_lvesdi_points').textContent = perVarScores.LVESDi点数.toFixed(1);
        
        const tpNoAvs  = totalPts["3月内未行AVS手术_取整"];
        const tpYesAvs = totalPts["3月内行AVS手术_取整"];
        document.getElementById('nomogram_total_points_no').textContent = tpNoAvs;
        document.getElementById('nomogram_total_points_yes').textContent = tpYesAvs;
        
        const markerNoAvs = document.getElementById('marker_no_avs');
        const markerYesAvs = document.getElementById('marker_yes_avs');
        
        let percentNoAvs = (tpNoAvs / NOMOGRAM_TOTAL_POINTS_MAX_SCALE) * 100;
        percentNoAvs = Math.min(100, Math.max(0, percentNoAvs)); 
        markerNoAvs.style.left = `calc(${percentNoAvs}% - ${markerNoAvs.offsetWidth / 2}px)`; 
        markerNoAvs.textContent = tpNoAvs;

        let percentYesAvs = (tpYesAvs / NOMOGRAM_TOTAL_POINTS_MAX_SCALE) * 100;
        percentYesAvs = Math.min(100, Math.max(0, percentYesAvs));
        markerYesAvs.style.left = `calc(${percentYesAvs}% - ${markerYesAvs.offsetWidth / 2}px)`;
        markerYesAvs.textContent = tpYesAvs;
    }

    function updateResultsTable(totalPts, survivalProbs, riskGroups) {
        document.getElementById('totalPoints_no').textContent = totalPts["3月内未行AVS手术_取整"];
        document.getElementById('totalPoints_yes').textContent = totalPts["3月内行AVS手术_取整"];

        document.getElementById('survival_1y_no').textContent = (survivalProbs.noAVS.oneYear * 100).toFixed(1) + '%';
        document.getElementById('survival_1y_yes').textContent = (survivalProbs.yesAVS.oneYear * 100).toFixed(1) + '%';
        document.getElementById('benefit_1y').textContent = ((survivalProbs.yesAVS.oneYear - survivalProbs.noAVS.oneYear) * 100).toFixed(1) + '%';
        
        document.getElementById('survival_3y_no').textContent = (survivalProbs.noAVS.threeYear * 100).toFixed(1) + '%';
        document.getElementById('survival_3y_yes').textContent = (survivalProbs.yesAVS.threeYear * 100).toFixed(1) + '%';
        document.getElementById('benefit_3y').textContent = ((survivalProbs.yesAVS.threeYear - survivalProbs.noAVS.threeYear) * 100).toFixed(1) + '%';

        document.getElementById('survival_5y_no').textContent = (survivalProbs.noAVS.fiveYear * 100).toFixed(1) + '%';
        document.getElementById('survival_5y_yes').textContent = (survivalProbs.yesAVS.fiveYear * 100).toFixed(1) + '%';
        document.getElementById('benefit_5y').textContent = ((survivalProbs.yesAVS.fiveYear - survivalProbs.noAVS.fiveYear) * 100).toFixed(1) + '%';

        document.getElementById('riskGroup_no').textContent = riskGroups.noAVS;
        document.getElementById('riskGroup_yes').textContent = riskGroups.yesAVS;
    }
    
    function clearResultsAndNomogramPoints() {
        const nomogramPointIds = [
            'nomogram_age_points', 'nomogram_sex_points', 'nomogram_cci_points', 'nomogram_nyha_points', 
            'nomogram_aodi_points', 'nomogram_lvef_points', 'nomogram_lvesdi_points',
            'nomogram_total_points_no', 'nomogram_total_points_yes'
        ];
        nomogramPointIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '0';
        });

        const tableResultIds = [
            'totalPoints_no', 'totalPoints_yes',
            'survival_1y_no', 'survival_1y_yes', 'benefit_1y',
            'survival_3y_no', 'survival_3y_yes', 'benefit_3y',
            'survival_5y_no', 'survival_5y_yes', 'benefit_5y',
            'riskGroup_no', 'riskGroup_yes'
        ];
        tableResultIds.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '--';
        });
        
        const markerNoAvs = document.getElementById('marker_no_avs');
        const markerYesAvs = document.getElementById('marker_yes_avs');
        if(markerNoAvs) { markerNoAvs.style.left = `0%`; markerNoAvs.textContent = '0';} // Adjusted for initial state
        if(markerYesAvs) { markerYesAvs.style.left = `0%`; markerYesAvs.textContent = '0';} // Adjusted for initial state
    }
    
    resetButton.addEventListener('click', function() {
        form.reset();
        setDefaultFormValues();
        validationErrorDiv.textContent = '';
        clearResultsAndNomogramPoints();
    });

    setDefaultFormValues();
    clearResultsAndNomogramPoints();
    // Optionally, trigger calculation on load with default values
    // setTimeout(() => form.dispatchEvent(new Event('submit', { cancelable: true })), 100);
});
</script>

</body>
</html>