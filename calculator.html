<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ARISE Score 计算器 - HeartValve 专家</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.min.js"></script>
  <style>
    body { 
        background-color: #f8fafc; /* Tailwind slate-50 */
        padding-top: 2rem; 
        padding-bottom: 2rem; 
    }
    .error { color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem; } /* Added margin-top for errors */
    .disclaimer { color: #6b7280; font-size: 0.875rem; margin-top: 1.5rem; } /* Increased margin-top for disclaimer */
    #survival-chart-container { /* Added a container for the chart for better responsiveness */
        position: relative;
        margin: auto;
        height: 280px; /* Default height */
        width: 100%;   /* Default width */
        max-width: 600px; /* Max width for larger screens */
        margin-top: 1.5rem;
    }
    .back-to-home {
        display: inline-block; 
        background-color: #6b7280; 
        color: white;
        font-weight: 500; 
        padding: 0.5rem 1rem; 
        border-radius: 0.375rem; 
        transition: background-color 0.3s ease;
        margin-bottom: 1.5rem; 
        text-decoration: none;
    }
    .back-to-home:hover {
        background-color: #4b5563; 
    }
  </style>
</head>
<body class="flex flex-col items-center min-h-screen"> 
  <div class="container mx-auto p-4 max-w-3xl w-full"> 
    <div class="w-full mb-6 text-left">
        <a href="index.html" class="back-to-home">&larr; 返回首页</a>
    </div>
    <div class="bg-white rounded-lg shadow-lg p-6 md:p-8">
        <h1 class="text-2xl font-bold text-center mb-6" id="calculatorTitle">ARISE Score: 心脏瓣膜预后评估</h1>
        <div class="flex justify-end mb-4">
          <select id="language" class="border rounded p-1 text-sm">
            <option value="zh">中文</option>
            <option value="en">English</option>
          </select>
        </div>
        <form id="arise-form" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4"> {/* Adjusted gap for better spacing */}
          <div>
            <label for="age" class="block text-sm font-medium text-gray-700">年龄 (Age, 年):</label>
            <input type="number" id="age" min="20" max="100" class="mt-1 block w-full border rounded p-2" required>
            <p id="age-error" class="error hidden"></p>
          </div>
          <div>
            <label for="sex" class="block text-sm font-medium text-gray-700">性别 (Sex):</label>
            <select id="sex" class="mt-1 block w-full border rounded p-2" required>
              {/* Options will be populated by JavaScript */}
            </select>
            <p id="sex-error" class="error hidden"></p>
          </div>
          <div>
            <label for="cci" class="block text-sm font-medium text-gray-700">CCI (Charlson合并症指数):</label>
            <input type="number" id="cci" min="0" max="9" class="mt-1 block w-full border rounded p-2" required>
            <p id="cci-error" class="error hidden"></p>
          </div>
          <div>
            <label for="nyha" class="block text-sm font-medium text-gray-700">NYHA 心功能分级:</label>
            <select id="nyha" class="mt-1 block w-full border rounded p-2" required>
              {/* Options will be populated by JavaScript */}
            </select>
            <p id="nyha-error" class="error hidden"></p>
          </div>
          <div>
            <label for="aodi" class="block text-sm font-medium text-gray-700">主动脉直径指数 (AoDi, mm/m²):</label>
            <input type="number" id="aodi" min="15" max="65" step="0.1" class="mt-1 block w-full border rounded p-2" required>
            <p id="aodi-error" class="error hidden"></p>
          </div>
          <div>
            <label for="lvef" class="block text-sm font-medium text-gray-700">左心室射血分数 (LVEF, %):</label>
            <input type="number" id="lvef" min="20" max="80" step="0.1" class="mt-1 block w-full border rounded p-2" required>
            <p id="lvef-error" class="error hidden"></p>
          </div>
          <div>
            <label for="lvesdi" class="block text-sm font-medium text-gray-700">左心室收缩末期内径指数 (LVESDi, mm/m²):</label>
            <input type="number" id="lvesdi" min="10" max="50" step="0.1" class="mt-1 block w-full border rounded p-2" required>
            <p id="lvesdi-error" class="error hidden"></p>
          </div>
          <div>
            <label for="avsIn3Months" class="block text-sm font-medium text-gray-700">3个月内是否进行主动脉瓣手术 (AVS):</label>
            <select id="avsIn3Months" class="mt-1 block w-full border rounded p-2" required>
                {/* Options will be populated by JavaScript */}
            </select>
            <p id="avsIn3Months-error" class="error hidden"></p> {/* Corrected ID for AVS error */}
          </div>
          <div class="col-span-1 md:col-span-2 mt-2"> {/* Added margin-top */}
            <button type="button" id="calculate" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">计算</button>
          </div>
        </form>
        <div id="results" class="mt-6 hidden">
          <h2 class="text-xl font-semibold mb-4" id="resultsTitle">计算结果</h2>
          <p><strong id="totalPointsLabel">总点数:</strong> <span id="total-points"></span></p>
          <p><strong id="riskCategoryLabel">风险类别:</strong> <span id="risk-category"></span></p>
          <p><strong id="survival1yLabel">1年生存率:</strong> <span id="survival-1y"></span></p>
          <p><strong id="survival3yLabel">3年生存率:</strong> <span id="survival-3y"></span></p>
          <p><strong id="survival5yLabel">5年生存率:</strong> <span id="survival-5y"></span></p>
          <div id="survival-chart-container">
            <canvas id="survival-chart"></canvas>
          </div>
          <p class="disclaimer" id="disclaimer">注意：ARISE Score不适用于术后30天内死亡风险评估，仅供参考，请结合临床判断。</p>
        </div>
    </div>
  </div>
  <script>
    const translations = {
      zh: {
        calculatorTitle: "ARISE Score: 心脏瓣膜预后评估",
        ageLabel: "年龄 (Age, 年):", ageAriaLabel: "年龄（20-100岁）",
        sexLabel: "性别 (Sex):", sexAriaLabel: "性别",
        sexOptions: { "": "请选择", Male: "男 (Male)", Female: "女 (Female)" },
        cciLabel: "CCI (Charlson合并症指数):", cciAriaLabel: "Charlson合并症指数（0-9）",
        nyhaLabel: "NYHA 心功能分级:", nyhaAriaLabel: "NYHA心功能分级",
        nyhaOptions: { "": "请选择", I: "I级", II: "II级", III: "III级", IV: "IV级" },
        aodiLabel: "主动脉直径指数 (AoDi, mm/m²):", aodiAriaLabel: "主动脉直径指数（15-65 mm/m²）",
        lvefLabel: "左心室射血分数 (LVEF, %):", lvefAriaLabel: "左心室射血分数（20-80%）",
        lvesdiLabel: "左心室收缩末期内径指数 (LVESDi, mm/m²):", lvesdiAriaLabel: "左心室收缩末期内径指数（10-50 mm/m²）",
        avsLabel: "3个月内是否进行主动脉瓣手术 (AVS):", avsAriaLabel: "3个月内是否进行主动脉瓣手术",
        avsOptions: { "": "请选择", Yes: "是 (Yes)", No: "否 (No)" },
        calculateButton: "计算",
        resultsTitle: "计算结果",
        totalPointsLabel: "总点数:",
        riskCategoryLabel: "风险类别:",
        survival1yLabel: "1年生存率:",
        survival3yLabel: "3年生存率:",
        survival5yLabel: "5年生存率:",
        disclaimer: "注意：ARISE Score不适用于术后30天内死亡风险评估，仅供参考，请结合临床判断。",
        chartLabel: "生存率 (%)", chartTimeLabel: "时间",
        errors: {
          age: "年龄必须在20-100之间", sex: "请选择性别", cci: "CCI必须在0-9之间",
          nyha: "请选择NYHA分级", aodi: "AoDi必须在15-65之间", lvef: "LVEF必须在20-80之间",
          lvesdi: "LVESDi必须在10-50之间", avsIn3Months: "请选择AVS状态" // Corrected key to avsIn3Months
        }
      },
      en: {
        calculatorTitle: "ARISE Score: Cardiac Valve Prognosis Assessment",
        ageLabel: "Age (years):", ageAriaLabel: "Age (20-100 years)",
        sexLabel: "Sex:", sexAriaLabel: "Sex",
        sexOptions: { "": "Please select", Male: "Male", Female: "Female" },
        cciLabel: "CCI (Charlson Comorbidity Index):", cciAriaLabel: "Charlson Comorbidity Index (0-9)",
        nyhaLabel: "NYHA Functional Class:", nyhaAriaLabel: "NYHA Functional Class",
        nyhaOptions: { "": "Please select", I: "Class I", II: "Class II", III: "Class III", IV: "Class IV" },
        aodiLabel: "Aortic Diameter Index (AoDi, mm/m²):", aodiAriaLabel: "Aortic Diameter Index (15-65 mm/m²)",
        lvefLabel: "Left Ventricular Ejection Fraction (LVEF, %):", lvefAriaLabel: "Left Ventricular Ejection Fraction (20-80%)",
        lvesdiLabel: "Left Ventricular End-Systolic Diameter Index (LVESDi, mm/m²):", lvesdiAriaLabel: "Left Ventricular End-Systolic Diameter Index (10-50 mm/m²)",
        avsLabel: "Aortic Valve Surgery within 3 Months (AVS):", avsAriaLabel: "Aortic Valve Surgery within 3 Months",
        avsOptions: { "": "Please select", Yes: "Yes", No: "No" },
        calculateButton: "Calculate",
        resultsTitle: "Results",
        totalPointsLabel: "Total Points:",
        riskCategoryLabel: "Risk Category:",
        survival1yLabel: "1-Year Survival Rate:",
        survival3yLabel: "3-Year Survival Rate:",
        survival5yLabel: "5-Year Survival Rate:",
        disclaimer: "Note: ARISE Score is not suitable for assessing mortality risk within 30 days post-surgery. For reference only, please consult clinical judgment.",
        chartLabel: "Survival Rate (%)", chartTimeLabel: "Time",
        errors: {
          age: "Age must be between 20 and 100", sex: "Please select sex", cci: "CCI must be between 0 and 9",
          nyha: "Please select NYHA class", aodi: "AoDi must be between 15 and 65", lvef: "LVEF must be between 20 and 80",
          lvesdi: "LVESDi must be between 10 and 50", avsIn3Months: "Please select AVS status" // Corrected key to avsIn3Months
        }
      }
    };

    function updateLanguage(lang) {
        const t = translations[lang];
        document.getElementById("calculatorTitle").textContent = t.calculatorTitle;
        document.title = t.calculatorTitle; 

        const elementsToUpdate = {
            "age": "ageLabel", "sex": "sexLabel", "cci": "cciLabel", "nyha": "nyhaLabel",
            "aodi": "aodiLabel", "lvef": "lvefLabel", "lvesdi": "lvesdiLabel", "avsIn3Months": "avsLabel" // Corrected ID from 'avs' to 'avsIn3Months'
        };
        Object.entries(elementsToUpdate).forEach(([id, langKey]) => {
            document.querySelector(`label[for='${id}']`).textContent = t[langKey];
            const ariaLabelKey = langKey.replace('Label', 'AriaLabel'); // e.g. ageAriaLabel
             if(t[ariaLabelKey]) document.querySelector(`label[for='${id}']`).setAttribute('aria-label', t[ariaLabelKey]);
        });
        
        document.getElementById("calculate").textContent = t.calculateButton;
        
        const resultsTitle = document.getElementById("resultsTitle");
        if(resultsTitle) resultsTitle.textContent = t.resultsTitle;

        const totalPointsLabel = document.getElementById("totalPointsLabel");
        if(totalPointsLabel) totalPointsLabel.textContent = t.totalPointsLabel;
        
        const riskCategoryLabel = document.getElementById("riskCategoryLabel");
        if(riskCategoryLabel) riskCategoryLabel.textContent = t.riskCategoryLabel;

        const survival1yLabel = document.getElementById("survival1yLabel");
        if(survival1yLabel) survival1yLabel.textContent = t.survival1yLabel;

        const survival3yLabel = document.getElementById("survival3yLabel");
        if(survival3yLabel) survival3yLabel.textContent = t.survival3yLabel;
        
        const survival5yLabel = document.getElementById("survival5yLabel");
        if(survival5yLabel) survival5yLabel.textContent = t.survival5yLabel;
        
        document.getElementById("disclaimer").textContent = t.disclaimer;

        function populateSelect(selectId, optionsObj) {
            const selectEl = document.getElementById(selectId);
            if (!selectEl) return;
            const currentVal = selectEl.value;
            selectEl.innerHTML = Object.entries(optionsObj).map(([value, text]) => 
                `<option value="${value}" ${value === "" ? "selected" : ""}>${text}</option>` // Simplified default selection
            ).join("");
            if (selectEl.querySelector(`option[value="${currentVal}"]`)) { // Check if current value is a valid option
                 selectEl.value = currentVal;
            } else {
                 selectEl.value = ""; // Default to "Please select"
            }
        }
        populateSelect("sex", t.sexOptions);
        populateSelect("nyha", t.nyhaOptions);
        populateSelect("avsIn3Months", t.avsOptions); // Corrected ID from 'avs' to 'avsIn3Months'
        
        Object.keys(t.errors).forEach(id => {
            const errorEl = document.getElementById(`${id}-error`);
            if (errorEl && !errorEl.classList.contains("hidden")) {
                errorEl.textContent = t.errors[id] || "";
            } else if (errorEl) { // Ensure all error messages are updated even if hidden
                 errorEl.textContent = t.errors[id] || ""; // Set the text for future display
            }
        });
        
        if (window.survivalChart instanceof Chart) {
            window.survivalChart.options.scales.y.title.text = t.chartLabel;
            window.survivalChart.options.scales.x.title.text = t.chartTimeLabel;
            window.survivalChart.data.datasets[0].label = t.chartLabel;
             window.survivalChart.data.labels = lang === 'zh' ? ["1年", "3年", "5年"] : ["1-Year", "3-Year", "5-Year"];
            window.survivalChart.update();
        }
    }
    
    document.addEventListener('DOMContentLoaded', () => {
        const preferredLang = localStorage.getItem('preferredLang') || 'zh';
        document.getElementById("language").value = preferredLang;
        updateLanguage(preferredLang);

        document.getElementById("language").addEventListener("change", (e) => {
            const selectedLang = e.target.value;
            updateLanguage(selectedLang);
            localStorage.setItem('preferredLang', selectedLang);
        });
    });

    document.getElementById("calculate").addEventListener("click", function() {
      const lang = document.getElementById("language").value;
      const t = translations[lang];
      const inputs = {
        age: document.getElementById("age").value,
        sex: document.getElementById("sex").value,
        cci: document.getElementById("cci").value,
        nyha: document.getElementById("nyha").value,
        aodi: document.getElementById("aodi").value,
        lvef: document.getElementById("lvef").value,
        lvesdi: document.getElementById("lvesdi").value,
        avsIn3Months: document.getElementById("avsIn3Months").value // Corrected ID
      };

      const errors = validateInputs(inputs, t);
      let hasErrors = false;
      Object.keys(inputs).forEach(id => { // Use actual input ids for error mapping
        const errorKey = id === 'avsIn3Months' ? 'avsIn3Months' : id; // Map avsIn3Months to its error key
        const errorEl = document.getElementById(`${id}-error`);
        if (errors[errorKey]) { // Use errorKey to get message from t.errors
            errorEl.textContent = errors[errorKey];
            errorEl.classList.remove("hidden");
            hasErrors = true;
        } else if(errorEl) {
            errorEl.textContent = "";
            errorEl.classList.add("hidden");
        }
      });

      if (hasErrors) {
        document.getElementById("results").classList.add("hidden");
        return;
      }
      
      const processedInputs = {
        age: parseInt(inputs.age),
        sex: inputs.sex,
        cci: parseInt(inputs.cci),
        nyha: inputs.nyha,
        aodi: parseFloat(inputs.aodi),
        lvef: parseFloat(inputs.lvef),
        lvesdi: parseFloat(inputs.lvesdi),
        avs: inputs.avsIn3Months // Use correct variable
      };

      const pointsArray = calculatePoints(processedInputs);
      const totalPoints = pointsArray.reduce((sum, p) => Math.round(sum + p), 0); // Round sum of points
      const survivalRates = calculateSurvivalRates(totalPoints);

      document.getElementById("total-points").textContent = totalPoints.toFixed(0);
      document.getElementById("risk-category").textContent = getRiskCategory(totalPoints, lang);
      document.getElementById("survival-1y").textContent = (survivalRates[1] * 100).toFixed(1) + "%";
      document.getElementById("survival-3y").textContent = (survivalRates[3] * 100).toFixed(1) + "%";
      document.getElementById("survival-5y").textContent = (survivalRates[5] * 100).toFixed(1) + "%";
      document.getElementById("results").classList.remove("hidden");
      renderSurvivalChart(survivalRates, lang);
    });

    function validateInputs({ age, sex, cci, nyha, aodi, lvef, lvesdi, avsIn3Months }, t) { // Corrected destructuring for avsIn3Months
      const errors = {};
      const ageNum = parseInt(age);
      const cciNum = parseInt(cci);
      const aodiNum = parseFloat(aodi);
      const lvefNum = parseFloat(lvef);
      const lvesdiNum = parseFloat(lvesdi);

      if (age === "" || isNaN(ageNum) || ageNum < 20 || ageNum > 100) errors.age = t.errors.age;
      if (sex === "") errors.sex = t.errors.sex; 
      if (cci === "" || isNaN(cciNum) || cciNum < 0 || cciNum > 9) errors.cci = t.errors.cci;
      if (nyha === "") errors.nyha = t.errors.nyha; 
      if (aodi === "" || isNaN(aodiNum) || aodiNum < 15 || aodiNum > 65) errors.aodi = t.errors.aodi;
      if (lvef === "" || isNaN(lvefNum) || lvefNum < 20 || lvefNum > 80) errors.lvef = t.errors.lvef;
      if (lvesdi === "" || isNaN(lvesdiNum) || lvesdiNum < 10 || lvesdiNum > 50) errors.lvesdi = t.errors.lvesdi;
      if (avsIn3Months === "") errors.avsIn3Months = t.errors.avsIn3Months; // Corrected key
      return errors;
    }

    function calculatePoints({ age, sex, cci, nyha, aodi, lvef, lvesdi, avs }) { // 'avs' here maps to avsIn3Months value
      // Using the refined point estimation from Liu et al. JAHA 2025 Figure 1 (visual approximation)
      let pointsAge = interpolate(Math.min(Math.max(age, 20), 100), [[20, 0], [100, 85]]);
      let pointsSex = (sex === 'Female') ? 7 : 0; 
      let pointsCCI = interpolate(Math.min(Math.max(cci, 0), 9), [[0, 0], [9, 63]]);
      let pointsNYHA = 0;
      switch (nyha) {
          case 'I': pointsNYHA = 0; break;
          case 'II': pointsNYHA = 19; break;
          case 'III': pointsNYHA = 32; break;
          case 'IV': pointsNYHA = 42; break;
      }
      let pointsAoDi = interpolate(Math.min(Math.max(aodi, 15), 65), [[15, 0], [65, 50]]);
      let pointsLVEF = interpolate(Math.min(Math.max(lvef, 20), 80), [[80, 0], [20, 30]], true);
      let pointsLVESDi = interpolate(Math.min(Math.max(lvesdi, 10), 50), [[10, 0], [50, 40]]);
      let pointsAVS = (avs === 'No') ? 11 : 0; // Adjusted AVS 'No' points to 11 based on official site data
      
      return [pointsAge, pointsSex, pointsCCI, pointsNYHA, pointsAoDi, pointsLVEF, pointsLVESDi, pointsAVS];
    }

    function calculateSurvivalRates(totalPoints) {
      // Adjusted Survival Maps based on official site data for Test Case 1 (points 46 & 57)
      // and trying to keep the general curve from nomogram
      const survivalMap1Year = [[0,1.0],[20,0.999],[40,0.9985],[46,0.998],[57,0.997],[60,0.996],[80,0.95],[100,0.85],[120,0.70],[140,0.55],[160,0.40],[180,0.25],[200,0.15]];
      const survivalMap3Year = [[0,1.0],[20,0.998],[40,0.996],[46,0.995],[57,0.991],[60,0.99],[80,0.90],[100,0.75],[120,0.55],[140,0.35],[160,0.20],[180,0.10],[200,0.05]];
      const survivalMap5Year = [[0,1.0],[20,0.995],[40,0.992],[46,0.991],[57,0.984],[60,0.98],[80,0.85],[100,0.65],[120,0.45],[140,0.25],[160,0.15],[180,0.08],[200,0.04]];
      
      const clampedTotalPoints = Math.min(Math.max(totalPoints, 0), 200);

      return {
        1: getSurvivalProbability(clampedTotalPoints, survivalMap1Year),
        3: getSurvivalProbability(clampedTotalPoints, survivalMap3Year),
        5: getSurvivalProbability(clampedTotalPoints, survivalMap5Year)
      };
    }

    function getRiskCategory(totalPoints, lang) {
      if (totalPoints < 85) return lang === "zh" ? "低风险" : "Low Risk";
      if (totalPoints < 107) return lang === "zh" ? "中风险" : "Moderate Risk";
      return lang === "zh" ? "高风险" : "High Risk";
    }

    function renderSurvivalChart(survivalRates, lang) {
      const ctx = document.getElementById("survival-chart").getContext("2d");
      const t = translations[lang];
      const chartLabels = { zh: ["1年", "3年", "5年"], en: ["1-Year", "3-Year", "5-Year"] };
      const chartDatasetLabel = { zh: "生存率 (%)", en: "Survival Rate (%)" };

      const yMin = Math.max(0, Math.floor(Math.min(survivalRates[1] * 100, survivalRates[3] * 100, survivalRates[5] * 100) / 10) * 10 - 5);


      if (window.survivalChart instanceof Chart) {
        window.survivalChart.destroy();
      }
      window.survivalChart = new Chart(ctx, {
        type: "line",
        data: {
          labels: chartLabels[lang],
          datasets: [{
            label: chartDatasetLabel[lang],
            data: [survivalRates[1] * 100, survivalRates[3] * 100, survivalRates[5] * 100],
            borderColor: "#4CAF50", 
            backgroundColor: "rgba(76, 175, 80, 0.1)", 
            fill: true,
            tension: 0.1 
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false, 
          scales: {
            y: { 
                beginAtZero: false, 
                min: yMin, 
                max: 100, 
                title: { display: true, text: chartDatasetLabel[lang] } 
            },
            x: { title: { display: true, text: (lang === "zh" ? "时间" : "Time") } }
          },
          plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        let label = context.dataset.label || '';
                        if (label) { label += ': '; }
                        if (context.parsed.y !== null) {
                            label += context.parsed.y.toFixed(1) + '%';
                        }
                        return label;
                    }
                }
            }
          }
        }
      });
    }
  </script>
</body>
</html>