<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">ARISE Score 预后评估 - HeartValve 专家</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .tab-button.active {
            @apply bg-white text-slate-950 border-slate-300 shadow-sm;
            @apply dark:bg-slate-700 dark:text-white dark:border-slate-500;
        }
        .tab-button {
            @apply py-2 px-4 text-sm font-semibold text-slate-600 bg-slate-50 hover:bg-slate-200 border border-transparent rounded-t-lg transition-colors;
            @apply dark:bg-slate-800 dark:text-slate-400 dark:hover:bg-slate-700;
        }
        .tab-content {
            @apply p-6 border border-t-0 border-slate-300 rounded-b-lg bg-white shadow-sm;
            @apply dark:bg-slate-800 dark:border-slate-700 dark:text-slate-300;
        }
        /* Base styles for form inputs, specific dark mode classes will be in HTML */
        input[type="number"].form-input-style, 
        select.form-input-style {
             @apply flex h-10 w-full rounded-md border px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50;
        }
        input[type="number"].slider-value-input-style { /* For number inputs linked with sliders, if different base needed */
            @apply flex h-10 w-24 text-center rounded-md border px-3 py-2 text-sm ring-offset-white focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-blue-500 focus-visible:ring-offset-2;
        }

        input[type="range"] {
            @apply w-full h-2 bg-slate-200 dark:bg-slate-700 rounded-lg appearance-none cursor-pointer;
        }
        input[type="range"]::-webkit-slider-thumb {
            @apply appearance-none w-5 h-5 bg-blue-600 rounded-full cursor-pointer hover:bg-blue-700 active:bg-blue-800 shadow;
        }
        input[type="range"]::-moz-range-thumb {
            @apply w-5 h-5 bg-blue-600 rounded-full cursor-pointer border-0 hover:bg-blue-700 active:bg-blue-800 shadow;
        }

        .results-table th, .results-table td { @apply border border-slate-300 dark:border-slate-600 px-3 py-2 text-sm; }
        .results-table th { @apply bg-slate-100 dark:bg-slate-700 font-semibold text-slate-700 dark:text-slate-200 text-center; }
        .results-table td { @apply text-slate-800 dark:text-slate-200 text-center; }
        .results-table td:first-child { @apply text-left font-medium; }

        .nav-link-active { @apply text-blue-600 dark:text-blue-400 font-semibold border-b-2 border-blue-600 dark:border-blue-400; }
        .error-message { color: #EF4444; font-size: 0.875rem; margin-top: 0.25rem; min-height: 1.25rem; }
        .input-error-border { border-color: #EF4444 !important; }

        .modal { transition: opacity 0.25s ease; z-index: 100; }
        .modal-active-body-scroll-lock { overflow: hidden; }
        .modal-content { max-height: 85vh; overflow-y: auto; }
        .chart-container { position: relative; height:350px; width:100%; margin-bottom: 1.5rem; /* Added margin for spacing from table */}
        .loader {
            border: 4px solid #E5E7EB; 
            border-top: 4px solid #3B82F6; 
            border-radius: 50%;
            width: 20px; 
            height: 20px;
            animation: spin 1s linear infinite;
            display: none; 
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-white text-gray-800 dark:bg-slate-900 dark:text-slate-200">

    <nav class="bg-white dark:bg-slate-800 shadow-sm sticky top-0 z-50 border-b border-slate-200 dark:border-slate-700">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="index.html" class="text-2xl font-bold text-blue-700 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 transition-colors">HeartValve 专家</a>
            <div class="flex items-center space-x-1 md:space-x-2">
                <a href="index.html" data-lang-key="navHome" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">首页</a>
                <a href="calculator.html" data-lang-key="navCalculator" class="nav-link-active px-3 py-2 rounded-md text-sm">ARISE Score 工具</a>
                <a href="disease-info.html" data-lang-key="navDiseaseInfo" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">疾病知识</a>
                <a href="surgical-options.html" data-lang-key="navSurgicalOptions" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">手术方案</a>
                <a href="expert-views.html" data-lang-key="navExpertViews" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">专家视角</a>
                <a href="about.html" data-lang-key="navAbout" class="text-gray-700 dark:text-slate-300 hover:text-blue-600 dark:hover:text-blue-400 px-3 py-2 rounded-md text-sm font-medium transition-colors">关于我们</a>
                 <select id="languageSelector" class="ml-2 p-2 border border-slate-300 bg-white text-slate-700 rounded-md text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-colors dark:bg-slate-700 dark:text-slate-200 dark:border-slate-600">
                    <option value="zh" data-lang-key="langChinese">中文</option>
                    <option value="en" data-lang-key="langEnglish">English</option>
                </select>
            </div>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="pb-6 xl:pb-8 2xl:pb-10 space-y-2 text-center">
            <h1 class="font-semibold text-[22px] md:text-2xl 2xl:text-3xl text-gray-800 dark:text-slate-100" data-lang-key="pageH1">ARISE Score</h1>
            <h2 class="text-slate-600 dark:text-slate-400 text-sm md:text-base 2xl:text-lg" data-lang-key="pageH2">评估慢性主动脉瓣反流患者接受或不接受手术的生存率。</h2>
        </div>

        <div class="mb-8">
            <div class="flex border-b border-slate-300 dark:border-slate-700">
                <button id="tab-who" class="tab-button active" onclick="showTab('who')" data-lang-key="tabWho">适用人群</button>
                <button id="tab-how" class="tab-button" onclick="showTab('how')" data-lang-key="tabHow">如何使用</button>
                <button id="tab-why" class="tab-button" onclick="showTab('why')" data-lang-key="tabWhy">为何使用</button>
            </div>
            <div id="content-who" class="tab-content" data-lang-key="contentWho">适用于患有 **中重度至重度慢性主动脉瓣反流 (AR)** 的患者。</div>
            <div id="content-how" class="tab-content hidden" data-lang-key="contentHow">通过该工具**估算和比较**在接受或不接受主动脉瓣修复/置换术情况下，患者1年、3年和5年的生存率。生存率根据低、中、高三个风险等级进行分层。虽然我们的列线图提供了生存率估算，但在共同决策过程中，必须综合考虑基线生存轨迹、净手术获益以及指南建议。</div>
            <div id="content-why" class="tab-content hidden" data-lang-key="contentWhy">此工具专为日常实践中的**个体化风险评估**而设计，帮助医生清晰地沟通手术的获益与风险，从而加强医患关系。</div>
        </div>
        
        <div class="lg:grid lg:grid-cols-12 lg:gap-8 xl:gap-10">
            <section class="lg:col-span-5 space-y-5">
                <div class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-950 dark:text-slate-50 shadow-lg p-6">
                    <form id="ariseForm" class="space-y-5">
                        <div>
                            <label for="age" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelAge">年龄 (Age)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeAge">(10-100 岁)</span>
                            </label>
                            <input type="number" id="age" name="age" min="10" max="100" value="" step="1" class="form-input-style mt-1.5 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder=" ">
                            <input type="range" id="age_slider" name="age_slider" min="10" max="100" value="10" step="1" class="mt-2">
                            <div class="error-message" id="ageError"></div>
                        </div>

                        <div>
                            <label for="sex" class="font-medium text-md block text-slate-700 dark:text-slate-300" data-lang-key="labelSex">性别 (Sex)</label>
                            <select id="sex" name="sex" class="form-input-style mt-1.5 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600">
                                <option value="male" data-lang-key="sexMale">男性 (Male)</option>
                                <option value="female" data-lang-key="sexFemale">女性 (Female)</option>
                            </select>
                            <div class="error-message" id="sexError"></div>
                        </div>

                        <div>
                            <label for="cci" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelCCI">CCI评分</span>
                                 <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeCCI">(0-9 分)</span>
                            </label>
                             <div class="flex items-end space-x-2 mt-1.5"> 
                                <div class="flex-grow">
                                    <input type="number" id="cci" name="cci" min="0" max="9" value="" step="1" class="form-input-style w-full bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder=" ">
                                    <input type="range" id="cci_slider" name="cci_slider" min="0" max="9" value="0" step="1" class="mt-2">
                                </div>
                                <button type="button" id="openCciModalButton" class="px-3 h-10 bg-sky-500 hover:bg-sky-600 text-white text-xs rounded-md whitespace-nowrap transition-colors self-center" data-lang-key="calculateCciButtonKey">计算CCI</button>
                            </div>
                             <div class="error-message" id="cciError"></div>
                        </div>
                        
                        <div>
                            <label for="nyha" class="font-medium text-md block text-slate-700 dark:text-slate-300" data-lang-key="labelNYHA">NYHA 心功能分级</label>
                            <select id="nyha" name="nyha" class="form-input-style mt-1.5 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600">
                                <option value="1" data-lang-key="nyhaI">NYHA I</option>
                                <option value="2" data-lang-key="nyhaII">NYHA II</option>
                                <option value="3" data-lang-key="nyhaIII">NYHA III</option>
                                <option value="4" data-lang-key="nyhaIV">NYHA IV</option>
                            </select>
                            <div class="error-message" id="nyhaError"></div>
                        </div>

                        <div>
                            <label for="aodi" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelAoDi">主动脉根部内径指数 (AoDi)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeAoDi">(15-70 mm/m²)</span>
                            </label>
                            <input type="number" id="aodi" name="aodi" min="15" max="70" value="" step="1" class="form-input-style mt-1.5 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder=" ">
                            <input type="range" id="aodi_slider" name="aodi_slider" min="15" max="70" value="15" step="1" class="mt-2">
                            <div class="error-message" id="aodiError"></div>
                        </div>

                        <div>
                            <label for="lvef" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelLVEF">左室射血分数 (LVEF)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeLVEF">(20-80 %)</span>
                            </label>
                            <input type="number" id="lvef" name="lvef" min="20" max="80" value="" step="1" class="form-input-style mt-1.5 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder=" ">
                            <input type="range" id="lvef_slider" name="lvef_slider" min="20" max="80" value="20" step="1" class="mt-2">
                             <div class="error-message" id="lvefError"></div>
                        </div>

                        <div>
                            <label for="lvesdi" class="font-medium text-md flex items-center justify-between text-slate-700 dark:text-slate-300">
                                <span data-lang-key="labelLVESDi">左室收缩末期内径指数 (LVESDi)</span>
                                <span class="text-slate-500 dark:text-slate-400 text-xs" data-lang-key="rangeLVESDi">(10-50 mm/m²)</span>
                            </label>
                            <input type="number" id="lvesdi" name="lvesdi" min="10" max="50" value="" step="1" class="form-input-style mt-1.5 bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500" placeholder=" ">
                            <input type="range" id="lvesdi_slider" name="lvesdi_slider" min="10" max="50" value="10" step="1" class="mt-2">
                            <div class="error-message" id="lvesdiError"></div>
                            
                            <button type="button" id="toggleLvesdiEstimatorButton" class="mt-2.5 text-xs text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                                <span data-lang-key="toggleLvesdiEstimatorButtonKey">可选：通过LVDd等估算LVESDi</span>
                                <i id="lvesdiEstimatorIcon" class="fas fa-chevron-down ml-1 transform transition-transform text-xs"></i>
                            </button>
                            <div id="lvesdiEstimatorSection" class="hidden mt-3 p-4 border border-slate-200 dark:border-slate-700 rounded-md bg-slate-50 dark:bg-slate-800/60 space-y-3">
                                <p class="text-xs text-slate-500 dark:text-slate-400" data-lang-key="lvesdiEstimatorInfo">输入LVDd、身高和体重估算LVESDi。LVEF将从上方主表单获取。</p>
                                <div>
                                    <label for="estimatorLvdd" class="block text-xs font-medium text-slate-600 dark:text-slate-300" data-lang-key="labelLVDD">LVDd (mm) <span class="text-slate-400 text-xs" data-lang-key="rangeEstLVDD">(20-100)</span></label>
                                    <input type="number" id="estimatorLvdd" step="1" min="20" max="100" placeholder="例如: 50" class="form-input-style mt-1 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500">
                                    <div class="error-message text-xs" id="estimatorLvddError"></div>
                                </div>
                                <div>
                                    <label for="estimatorHeight" class="block text-xs font-medium text-slate-600 dark:text-slate-300" data-lang-key="labelHeight">身高 (cm) <span class="text-slate-400 text-xs" data-lang-key="rangeEstHeight">(100-250)</span></label>
                                    <input type="number" id="estimatorHeight" step="1" min="100" max="250" placeholder="例如: 170" class="form-input-style mt-1 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500">
                                    <div class="error-message text-xs" id="estimatorHeightError"></div>
                                </div>
                                <div>
                                    <label for="estimatorWeight" class="block text-xs font-medium text-slate-600 dark:text-slate-300" data-lang-key="labelWeight">体重 (kg) <span class="text-slate-400 text-xs" data-lang-key="rangeEstWeight">(20-250)</span></label>
                                    <input type="number" id="estimatorWeight" step="0.1" min="20" max="250" placeholder="例如: 70" class="form-input-style mt-1 text-sm bg-white dark:bg-slate-700 text-slate-900 dark:text-slate-100 border-slate-300 dark:border-slate-600 placeholder-slate-400 dark:placeholder-slate-500">
                                    <div class="error-message text-xs" id="estimatorWeightError"></div>
                                </div>
                                <button type="button" id="calculateLvesdiButton" class="w-full px-3 py-1.5 bg-indigo-500 hover:bg-indigo-600 text-white text-xs rounded-md transition-colors" data-lang-key="estimateLvesdiButtonKey">估算LVESDi并填充</button>
                                <div id="lvesdiEstimationResult" class="text-xs mt-1 text-slate-600 dark:text-slate-300"></div>
                            </div>
                        </div>

                        <div class="flex justify-between gap-4 pt-5 md:col-span-2">
                            <button type="button" id="resetButton" class="flex-1 bg-slate-200 hover:bg-slate-300 dark:bg-slate-600 dark:hover:bg-slate-500 text-slate-800 dark:text-slate-200 h-10 px-4 py-2 rounded-md text-sm font-medium transition-colors" data-lang-key="resetButtonKey">重置</button>
                            <button type="submit" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white h-10 px-6 py-2 rounded-md text-base font-medium transition-colors flex items-center justify-center" data-lang-key="submitButtonKey">
                                <i class="fas fa-calculator mr-2"></i>提交
                                <div id="calculationLoader" class="loader ml-2"></div>
                            </button>
                        </div>
                        <div id="validationErrorOverall" class="text-red-500 text-sm mt-2 md:col-span-2"></div>
                    </form>
                </div>
            </section>

            <section class="lg:col-span-7 space-y-6 mt-8 lg:mt-0">
                <div class="rounded-lg border border-slate-300 dark:border-slate-700 bg-white dark:bg-slate-800 text-slate-950 dark:text-slate-50 shadow-lg p-6">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700 dark:text-slate-200" data-lang-key="survivalCurveTitle">生存率曲线 (估算)</h3>
                    <div class="chart-container">
                        <canvas id="survivalCurveChart"></canvas>
                    </div>

                    <h3 class="text-xl font-semibold mt-8 mb-3 text-gray-700 dark:text-slate-200" data-lang-key="survivalTitle">生存率估算与风险分级</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full results-table text-left">
                            <thead class="bg-slate-50 dark:bg-slate-700">
                                <tr>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderParameter">参数</th>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderNoAVS">3月内未行AVS</th>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderYesAVS">3月内已行AVS</th>
                                    <th class="whitespace-nowrap text-slate-700 dark:text-slate-200" data-lang-key="tableHeaderBenefit">AVS生存获益</th>
                                </tr>
                            </thead>
                            <tbody id="resultsBody" class="bg-white dark:bg-slate-800">
                                 <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRowTotalPoints">总点数 (取整)</td>
                                    <td id="totalPoints_no" class="dark:text-slate-300">--</td> <td id="totalPoints_yes" class="dark:text-slate-300">--</td> <td class="dark:text-slate-300"></td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRow1YrSurvival">1年生存率</td>
                                    <td id="survival_1y_no" class="dark:text-slate-300">--</td> <td id="survival_1y_yes" class="dark:text-slate-300">--</td> <td id="benefit_1y" class="dark:text-slate-300">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRow3YrSurvival">3年生存率</td>
                                    <td id="survival_3y_no" class="dark:text-slate-300">--</td> <td id="survival_3y_yes" class="dark:text-slate-300">--</td> <td id="benefit_3y" class="dark:text-slate-300">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRow5YrSurvival">5年生存率</td>
                                    <td id="survival_5y_no" class="dark:text-slate-300">--</td> <td id="survival_5y_yes" class="dark:text-slate-300">--</td> <td id="benefit_5y" class="dark:text-slate-300">--</td>
                                </tr>
                                <tr>
                                    <td class="font-medium text-slate-700 dark:text-slate-300" data-lang-key="tableRowRiskGroup">风险分组</td>
                                    <td id="riskGroup_no" class="dark:text-slate-300">--</td> <td id="riskGroup_yes" class="dark:text-slate-300">--</td> <td class="dark:text-slate-300"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                     <p class="text-xs text-center mt-4 text-slate-500 dark:text-slate-400" data-lang-key="accuracyDisclaimer">
                        * 当前计算基于原始研究中的列线图及其风险评分系统，旨在辅助理解。实际临床决策需综合更多因素。
                    </p>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-slate-800 dark:bg-black text-gray-300 dark:text-slate-400 py-8 text-center mt-12">
        <div class="container mx-auto px-6">
            <p>&copy; <span id="currentYear"></span> HeartValve 专家. <span data-lang-key="footerRights">版权所有.</span></p>
            <p class="text-sm mt-2" data-lang-key="footerDisclaimer">本网站信息仅供参考，不能替代专业医疗建议、诊断或治疗。</p>
        </div>
    </footer>
    
    <div id="cciModal" class="modal fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-xl">
            <div class="flex justify-between items-center p-5 border-b border-slate-200 dark:border-slate-700">
                <h2 class="text-lg font-semibold text-slate-800 dark:text-slate-100" data-lang-key="cciModalTitle">Charlson合并症指数 (CCI) 计算器</h2>
                <button id="closeCciModalButton" class="text-slate-400 hover:text-slate-600 dark:text-slate-500 dark:hover:text-slate-300 transition-colors">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="cciConditionsContainer" class="p-5 grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-2 text-sm max-h-[60vh] overflow-y-auto">
                </div>
            <div class="p-5 border-t border-slate-200 dark:border-slate-700">
                <p class="text-md font-semibold text-slate-700 dark:text-slate-200">
                    <span data-lang-key="cciModalTotalScore">CCI 总分 (不含年龄):</span> 
                    <span id="cciScoreDisplay" class="text-blue-600 dark:text-blue-400 font-bold text-lg">0</span>
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" data-lang-key="cciModalNote">ARISE Score已单独包含年龄因素，此处CCI不重复计算年龄加分。</p>
            </div>
            <div class="p-5 flex justify-end space-x-3 bg-slate-50 dark:bg-slate-800/50 rounded-b-lg">
                <button type="button" id="cancelCciButton" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 rounded-md text-sm transition-colors" data-lang-key="cciModalCancel">取消</button>
                <button type="button" id="applyCciButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-semibold transition-colors" data-lang-key="cciModalApply">应用此CCI分数</button>
            </div>
        </div>
    </div>

<script>
// =============================================================================
// ARISE Score Calculator - Based on User Provided HTML & Core JS Logic (Turn 24)
// Enhancements from Turn 39, with fixes from Turn 41 & 43 feedback:
// - UI layout for inputs: Number input above slider.
// - Fixed Sex validation bug.
// - Improved slider/number input sync.
// - LVESDi estimator outputs rounded integer.
// - Default Chinese language.
// - No auto-calculation or specific pre-filled values on load.
// - Dark mode input field background/text color fix (direct classes).
// - Chart relocated to replace nomogram points display.
// Date: 2025-06-03
// =============================================================================
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('ariseForm');
    const resetButton = document.getElementById('resetButton');
    const validationErrorOverallDiv = document.getElementById('validationErrorOverall'); 
    const languageSelector = document.getElementById('languageSelector');
    const calculationLoader = document.getElementById('calculationLoader');
    const currentYearSpan = document.getElementById('currentYear');
    if(currentYearSpan) currentYearSpan.textContent = new Date().getFullYear();

    const translations = { /* Same as Turn 39/43, ensure all keys are present */ 
        zh: {
            navHome: "首页", navCalculator: "ARISE Score 工具", navDiseaseInfo: "疾病知识", navSurgicalOptions: "手术方案", navExpertViews: "专家视角", navAbout: "关于我们",
            pageH1: "ARISE Score", pageH2: "评估慢性主动脉瓣反流患者接受或不接受手术的生存率。",
            tabWho: "适用人群", tabHow: "如何使用", tabWhy: "为何使用",
            contentWho: "适用于患有 **中重度至重度慢性主动脉瓣反流 (AR)** 的患者。",
            contentHow: "通过该工具**估算和比较**在接受或不接受主动脉瓣修复/置换术情况下，患者1年、3年和5年的生存率。生存率根据低、中、高三个风险等级进行分层。虽然我们的列线图提供了生存率估算，但在共同决策过程中，必须综合考虑基线生存轨迹、净手术获益以及指南建议。",
            contentWhy: "此工具专为日常实践中的**个体化风险评估**而设计，帮助医生清晰地沟通手术的获益与风险，从而加强医患关系。",
            labelAge: "年龄", rangeAge: "(10-100 岁)",
            labelSex: "性别", sexMale: "男性 (Male)", sexFemale: "女性 (Female)",
            labelCCI: "CCI评分", rangeCCI: "(0-9 分)", calculateCciButtonKey: "计算CCI",
            labelNYHA: "NYHA 心功能分级", nyhaI: "NYHA I", nyhaII: "NYHA II", nyhaIII: "NYHA III", nyhaIV: "NYHA IV",
            labelAoDi: "主动脉根部内径指数 (AoDi)", rangeAoDi: "(15-70 mm/m²)",
            labelLVEF: "左室射血分数 (LVEF)", rangeLVEF: "(20-80 %)",
            labelLVESDi: "左室收缩末期内径指数 (LVESDi)", rangeLVESDi: "(10-50 mm/m²)",
            toggleLvesdiEstimatorButtonKey: "可选：通过LVDd等估算LVESDi",
            lvesdiEstimatorInfo: "输入LVDd、身高和体重估算LVESDi。LVEF将从上方主表单获取。",
            labelLVDD: "LVDd (mm)", rangeEstLVDD: "(20-100)",
            labelHeight: "身高 (cm)", rangeEstHeight: "(100-250)",
            labelWeight: "体重 (kg)", rangeEstWeight: "(20-250)",
            estimateLvesdiButtonKey: "估算LVESDi并填充",
            lvesdiNotCalculated: "LVESDi 未计算或所需输入无效。",
            lvesdiCalculated: "估算 LVESDi: {value} mm/m² (BSA: {bsa} m²)。已填充至主表单。",
            // nomogramTitle: "预后列线图与点数", // Title changed to survivalCurveTitle
            // nomogramPlaceholder: "列线图 (Nomogram) 图形区域",
            // nomogramInfo: "(官网的动态SVG列线图需要专门文件和代码。下方为数值点数展示和简易标尺。)",
            // variablePointsTitle: "各变量点数:", 
            // pointsAge: "年龄 (Age, year):", pointsSex: "性别 (Sex):", pointsCCI: "CCI:", pointsNYHA: "NYHA 分级 (NYHA, class):",
            // pointsAoDi: "AoDi (mm/m²):", pointsLVEF: "LVEF (%):", pointsLVESDi: "LVESDi (mm/m²):",
            // pointsTotalNoAVS: "总点数 (3月内未行AVS):", pointsTotalYesAVS: "总点数 (3月内已行AVS):",
            // pointsScaleInfo: "点数标尺估算范围: 0 到 150", 
            survivalTitle: "生存率估算与风险分级", // This title is now for the table below the chart
            tableHeaderParameter: "参数", tableHeaderNoAVS: "3月内未行AVS", tableHeaderYesAVS: "3月内已行AVS", tableHeaderBenefit: "AVS生存获益",
            tableRowTotalPoints: "总点数 (取整)", tableRow1YrSurvival: "1年生存率", tableRow3YrSurvival: "3年生存率", tableRow5YrSurvival: "5年生存率", tableRowRiskGroup: "风险分组",
            accuracyDisclaimer: "* 当前计算基于原始研究中的列线图及其风险评分系统，旨在辅助理解。实际临床决策需综合更多因素。",
            survivalCurveTitle: "生存率曲线 (估算)", 
            resetButtonKey: "重置", submitButtonKey: "提交",
            errorRequired: "此字段为必填项。", errorInteger: "{label}：请输入一个有效的整数。", errorNumber: "{label}：请输入一个有效的数字。",
            errorRange: "{label}必须是 {min} 到 {max} 之间的整数。", errorSelect: "{label}是必选项。",
            errorLVEFForEstimator: "请在主表单输入有效的LVEF值 (20-80%) 以估算LVESDi。",
            footerRights: "版权所有.", footerDisclaimer: "本网站信息仅供参考，不能替代专业医疗建议、诊断或治疗。",
            langEnglish: "English", langChinese: "中文", pageTitle: "ARISE Score 预后评估 - HeartValve 专家",
            selectOption: "请选择", 
            cciModalTitle: "Charlson合并症指数 (CCI) 计算器", cciModalTotalScore: "CCI 总分 (不含年龄):",
            cciModalNote: "ARISE Score已单独包含年龄因素，此处CCI不重复计算年龄加分。",
            cciModalCancel: "取消", cciModalApply: "应用此CCI分数",
            mi: "心肌梗死", chf: "充血性心力衰竭", pvd: "外周血管疾病", cvd: "脑血管疾病", dementia: "痴呆",
            cpd: "慢性肺病", ctd: "结缔组织病", pud: "消化性溃疡病", mld: "轻度肝病", diabetes_no_ed: "糖尿病 (无终末器官损害)",
            hemiplegia: "偏瘫或截瘫", renal_mod_sev: "中度或重度肾病", diabetes_ed: "糖尿病 (伴终末器官损害)",
            tumor_no_meta: "任何肿瘤 (无转移)", leukemia: "白血病", lymphoma: "淋巴瘤", liver_mod_sev: "中度或重度肝病",
            tumor_meta: "转移性实体瘤", aids: "艾滋病 (AIDS)",
            riskLow: "低风险 (Low)", riskMedium: "中等风险 (Intermediate)", riskHigh: "高风险 (High)",
            chartSurvivalNoAVS: "生存率 (未行AVS)", chartSurvivalYesAVS: "生存率 (已行AVS)",
            chartLabelTimeYears: "时间 (年)", chartLabelSurvivalRate: "生存率 (%)", chartLabelBaseline: "基线"
        },
        en: { /* ... All English translations, mirroring the ZH keys ... */ 
            navHome: "Home", navCalculator: "ARISE Score Tool", navDiseaseInfo: "Disease Info", navSurgicalOptions: "Surgical Options", navExpertViews: "Expert Views", navAbout: "About Us",
            pageH1: "ARISE Score", pageH2: "Estimating survival in patients with chronic aortic regurgitation with or without surgery.",
            tabWho: "Who", tabHow: "How", tabWhy: "Why",
            contentWho: "Applicable to patients with **moderate-to-severe or severe chronic aortic regurgitation (AR)**.",
            contentHow: "Use this tool to **estimate and compare** 1-year, 3-year, and 5-year survival rates with or without aortic valve repair/replacement. Survival rates are stratified into low, intermediate, and high-risk groups. While our nomogram provides survival estimates, baseline survival trajectory, net surgical benefit, and guideline recommendations must be considered in shared decision-making.",
            contentWhy: "This tool is designed for **individualized risk assessment** in daily practice, helping physicians clearly communicate the benefits and risks of surgery, thereby strengthening the doctor-patient relationship.",
            labelAge: "Age", rangeAge: "(10-100 years)",
            labelSex: "Sex", sexMale: "Male", sexFemale: "Female",
            labelCCI: "CCI Score", rangeCCI: "(0-9 points)", calculateCciButtonKey: "Calculate CCI",
            labelNYHA: "NYHA Class", nyhaI: "NYHA I", nyhaII: "NYHA II", nyhaIII: "NYHA III", nyhaIV: "NYHA IV",
            labelAoDi: "AoDi", rangeAoDi: "(15-70 mm/m²)",
            labelLVEF: "LVEF", rangeLVEF: "(20-80 %)",
            labelLVESDi: "LVESDi", rangeLVESDi: "(10-50 mm/m²)",
            toggleLvesdiEstimatorButtonKey: "Optional: Estimate LVESDi via LVDd, etc.",
            lvesdiEstimatorInfo: "Enter LVDd, height, and weight to estimate LVESDi. LVEF will be taken from the main form above.",
            labelLVDD: "LVDd (mm)", rangeEstLVDD: "(20-100)",
            labelHeight: "Height (cm)", rangeEstHeight: "(100-250)",
            labelWeight: "Weight (kg)", rangeEstWeight: "(20-250)",
            estimateLvesdiButtonKey: "Estimate & Fill LVESDi",
            lvesdiNotCalculated: "LVESDi not calculated or inputs invalid.",
            lvesdiCalculated: "Est. LVESDi: {value} mm/m² (BSA: {bsa} m²). Populated to main form.",
            // nomogramTitle: "Prognostic Nomogram & Points",
            survivalCurveTitle: "Survival Curve (Estimated)", // This title is now for the chart
            survivalTitle: "Survival Estimation & Risk Group", // This is for the table
            tableHeaderParameter: "Parameter", tableHeaderNoAVS: "No AVS within 3 mo", tableHeaderYesAVS: "AVS within 3 mo", tableHeaderBenefit: "AVS Survival Benefit",
            tableRowTotalPoints: "Total Points (rounded)", tableRow1YrSurvival: "1-Year Survival", tableRow3YrSurvival: "3-Year Survival", tableRow5YrSurvival: "5-Year Survival", tableRowRiskGroup: "Risk Group",
            accuracyDisclaimer: "* Current calculation is based on the nomogram and risk scoring system from the original research and is intended for informational purposes. Clinical decisions require comprehensive assessment.",
            resetButtonKey: "Reset", submitButtonKey: "Submit",
            errorRequired: "This field is required.", errorInteger: "{label}: please enter a valid integer.", errorNumber: "{label}: please enter a valid number.",
            errorRange: "{label} must be an integer between {min} and {max}.", errorSelect: "{label} selection is invalid.", // Changed from "is required"
            errorLVEFForEstimator: "Please enter a valid LVEF (20-80%) from main form to estimate LVESDi.",
            footerRights: "All rights reserved.", footerDisclaimer: "This website information is for reference only and cannot replace professional medical advice, diagnosis, or treatment.",
            langEnglish: "English", langChinese: "中文", pageTitle: "ARISE Score Prognostic Tool - HeartValve Expert",
            selectOption: "Please select",
            cciModalTitle: "Charlson Comorbidity Index (CCI) Calculator", cciModalTotalScore: "CCI Total Score (excluding age):",
            cciModalNote: "ARISE Score already includes age as a factor; CCI here does not add points for age again.",
            cciModalCancel: "Cancel", cciModalApply: "Apply this CCI Score",
            mi: "Myocardial Infarction", chf: "Congestive Heart Failure", pvd: "Peripheral Vascular Disease", cvd: "Cerebrovascular Disease", dementia: "Dementia",
            cpd: "Chronic Pulmonary Disease", ctd: "Connective Tissue Disease", pud: "Peptic Ulcer Disease", mld: "Mild Liver Disease", diabetes_no_ed: "Diabetes (no end-organ damage)",
            hemiplegia: "Hemiplegia or Paraplegia", renal_mod_sev: "Moderate or Severe Renal Disease", diabetes_ed: "Diabetes (with end-organ damage)",
            tumor_no_meta: "Any Tumor (no metastases)", leukemia: "Leukemia", lymphoma: "Lymphoma", liver_mod_sev: "Moderate or Severe Liver Disease",
            tumor_meta: "Metastatic Solid Tumor", aids: "AIDS",
            riskLow: "Low Risk", riskMedium: "Intermediate Risk", riskHigh: "High Risk",
            chartSurvivalNoAVS: "Survival (No AVS)", chartSurvivalYesAVS: "Survival (AVS)",
            chartLabelTimeYears: "Time (Years)", chartLabelSurvivalRate: "Survival Rate (%)", chartLabelBaseline: "Baseline"
        }
    };
    let currentLanguage = 'zh'; 
    let chartInstance = null;

    const inputsConfig = [ 
        { id: 'age',    sliderId: 'age_slider',    min: 10, max: 100, defaultVal: '', step: 1 },
        { id: 'cci',    sliderId: 'cci_slider',    min: 0,  max: 9,   defaultVal: '', step: 1 },
        { id: 'aodi',   sliderId: 'aodi_slider',   min: 15, max: 70,  defaultVal: '', step: 1 },
        { id: 'lvef',   sliderId: 'lvef_slider',   min: 20, max: 80,  defaultVal: '', step: 1 },
        { id: 'lvesdi', sliderId: 'lvesdi_slider', min: 10, max: 50,  defaultVal: '', step: 1 }
    ];

    // Improved Slider and Number Input Synchronization
    inputsConfig.forEach(inputConf => {
        const numberInput = document.getElementById(inputConf.id);
        const sliderInput = document.getElementById(inputConf.sliderId);
        if (numberInput && sliderInput) {
            numberInput.value = inputConf.defaultVal; // Initialize to blank
            sliderInput.value = inputConf.defaultVal || inputConf.min; // Slider needs a numerical value

            sliderInput.addEventListener('input', () => {
                numberInput.value = sliderInput.value;
                validateSingleAriseField(inputConf.id, numberInput.value, mainFormSchema[inputConf.id]); // Validate on slider change
            });
            
            numberInput.addEventListener('change', () => { // Validate and sync on 'change'
                const rule = mainFormSchema[inputConf.id];
                if (validateSingleAriseField(inputConf.id, numberInput.value, rule)) {
                    let valueNum = parseInt(numberInput.value); // All main inputs are integers
                     // Clamp again after validation passes to ensure it's within slider bounds
                    valueNum = Math.max(rule.min, Math.min(rule.max, valueNum));
                    numberInput.value = valueNum; // Update with validated & clamped value
                    sliderInput.value = valueNum;
                } else {
                    // If validation fails on change, reset number input to slider's current value
                    // or to min if current number input is totally invalid (e.g. text)
                    let sliderNumVal = parseInt(sliderInput.value);
                    if (isNaN(sliderNumVal)) sliderNumVal = rule.min;
                    numberInput.value = sliderNumVal;
                }
            });
            numberInput.addEventListener('focus', () => { // Clear error on focus
                const errorElement = document.getElementById(inputConf.id + 'Error');
                if (errorElement) errorElement.textContent = '';
                inputElement.classList.remove('input-error-border');
            });
        }
    });
    
    window.showTab = function(tabName) { /* Same as Turn 39 */ 
        ['who', 'how', 'why'].forEach(cId => {
            const cEl=document.getElementById('content-'+cId); const tBtn=document.getElementById('tab-'+cId);
            if(cEl)cEl.classList.add('hidden');
            if(tBtn){tBtn.classList.remove('active','bg-white','text-slate-950','border-slate-300','dark:bg-slate-700','dark:text-white','shadow-sm'); tBtn.classList.add('bg-slate-50','text-slate-600','border-transparent','dark:bg-slate-800','dark:text-slate-400');}
        });
        const acEl=document.getElementById('content-'+tabName); const atBtn=document.getElementById('tab-'+tabName);
        if(acEl)acEl.classList.remove('hidden');
        if(atBtn){atBtn.classList.add('active','bg-white','text-slate-950','border-slate-300','dark:bg-slate-700','dark:text-white','shadow-sm'); atBtn.classList.remove('bg-slate-50','text-slate-600','border-transparent','dark:bg-slate-800','dark:text-slate-400');}
    }

    // --- START: User's Core ARISE Calculation Logic (UNCHANGED - from Turn 24) ---
    const RISK_THRESHOLDS = { Low: 0, Intermediate: 85, High: 107 };
    function calculateFactorPoints_ARISE(factors) { /* ... same as Turn 24/39 ... */ 
        const { age, sex, cci, nyha, aodi, lvef, lvesdi } = factors;
        return { age: -11.111111 + 1.111111*age, sex: "female"===sex?5.092295:0, cci: 0 + 3.49046*cci, nyha: -3.541039 + 3.541039*nyha, aodi: -7.241847 + 0.48279*aodi, lvef: 21.697412 - 0.271218*lvef, lvesdi: -4.527494 + 0.452749*lvesdi };
    }
    function calculateRawTotalPoints_ARISE(factorPoints) { /* ... same as Turn 24/39 ... */ 
        let sum = Object.values(factorPoints).reduce((s,p)=>s+(p||0),0); if(Math.abs(sum)<1e-6)sum=0; return [sum + 11.042254, sum];
    }
    function calculateSurvivalProbabilities_ARISE(rawTotalPointsMatrix) { /* ... same as Turn 24/39 ... */ 
        const [noAVS,yesAVS]=rawTotalPointsMatrix; const getP=(tp)=>{const lp=(tp-93.903984)/18.131663; const e=Math.exp(lp); return{oneYear:Math.pow(.977952,e),threeYear:Math.pow(.9343029,e),fiveYear:Math.pow(.8886656,e)};}; return {noAVS:getP(noAVS),yesAVS:getP(yesAVS)};
    }
    function calculateRiskGroups_ARISE(truncatedTotalPointsMatrix) { /* ... same as Turn 24/39 ... */
        const [noAVS,yesAVS]=truncatedTotalPointsMatrix; const getG=(p)=>{const lang=currentLanguage; if(p<RISK_THRESHOLDS.Intermediate)return translations[lang].riskLow; if(p<RISK_THRESHOLDS.High)return translations[lang].riskMedium; return translations[lang].riskHigh;}; return{noAVS:getG(noAVS),yesAVS:getG(yesAVS)};
    }
    function getAriseScoreCalculatorResults_Main(factors) { /* ... same as Turn 24/39 ... */
        const fp=calculateFactorPoints_ARISE(factors); const rtp=calculateRawTotalPoints_ARISE(fp); const ttp=rtp.map(p=>Math.trunc(p)); const sp=calculateSurvivalProbabilities_ARISE(rtp); const rg=calculateRiskGroups_ARISE(ttp); return{factorPoints:fp,rawTotalPoints:{noAVS:rtp[0],yesAVS:rtp[1]},totalPoints:{noAVS:ttp[0],yesAVS:ttp[1]},survivalProbabilities:sp,riskGroups:rg};
    }
    // --- END: User's Core ARISE Calculation Logic ---

    const mainFormSchema = { // Defined using user's HTML input attributes (Turn 24)
        age:    { min: 10, max: 100, labelKey: "labelAge", isInteger: true, isRequired: true },
        sex:    { enum: ["male", "female"], labelKey: "labelSex", isRequired: true },
        cci:    { min: 0,  max: 9,   labelKey: "labelCCI", isInteger: true, isRequired: true },
        nyha:   { enum: ["1", "2", "3", "4"], labelKey: "labelNYHA", isRequired: true },
        aodi:   { min: 15, max: 70,  labelKey: "labelAoDi", isInteger: true, isRequired: true },
        lvef:   { min: 20, max: 80,  labelKey: "labelLVEF", isInteger: true, isRequired: true },
        lvesdi: { min: 10, max: 50,  labelKey: "labelLVESDi", isInteger: true, isRequired: true }
    };
    
    // Refined validation for individual fields
    function validateSingleAriseField(id, valueStr, rules = mainFormSchema[id]) { // rules default to mainFormSchema
        const errorElement = document.getElementById(id + 'Error');
        const inputElement = document.getElementById(id);
        const label = translations[currentLanguage][rules.labelKey] || id;

        if (errorElement) errorElement.textContent = '';
        if (inputElement) inputElement.classList.remove('input-error-border');

        if (rules.isRequired && (valueStr === null || valueStr.trim() === '')) {
            if (errorElement) errorElement.textContent = translations[currentLanguage].errorRequired;
            if (inputElement) inputElement.classList.add('input-error-border');
            return false;
        }
        if (!rules.isRequired && (valueStr === null || valueStr.trim() === '') && !rules.enum) return true;

        if (rules.enum) { // This handles select fields like 'sex' and 'nyha'
            if (!rules.enum.includes(valueStr)) {
                if (errorElement) errorElement.textContent = (translations[currentLanguage].errorSelect || "{label} selection is invalid.").replace('{label}', label);
                if (inputElement) inputElement.classList.add('input-error-border');
                return false;
            }
            return true; // Valid enum, no further number checks needed for enums
        }

        // Number validation for non-enum fields
        const valueNum = parseFloat(valueStr);
        if (isNaN(valueNum)) {
            if (errorElement) errorElement.textContent = (translations[currentLanguage].errorNumber || "{label}: please enter a valid number.").replace('{label}', label);
            if (inputElement) inputElement.classList.add('input-error-border');
            return false;
        }
        if (rules.isInteger && (valueNum !== parseInt(valueStr) || !Number.isInteger(valueNum))) { // Stricter integer check
            if (errorElement) errorElement.textContent = (translations[currentLanguage].errorInteger || "{label} must be an integer.").replace('{label}', label);
            if (inputElement) inputElement.classList.add('input-error-border');
            return false;
        }

        const min = rules.min; const max = rules.max;
        if ((typeof min !== 'undefined' && valueNum < min) || (typeof max !== 'undefined' && valueNum > max)) {
            if (errorElement) errorElement.textContent = (translations[currentLanguage].errorRange || "{label} must be between {min} and {max}.")
                .replace('{label}', label).replace('{min}', min).replace('{max}', max);
            if (inputElement) inputElement.classList.add('input-error-border');
            return false;
        }
        return true;
    }
    
    function validateMainAriseForm() { /* ... same as Turn 39 ... */ 
        let iV = true; if(validationErrorOverallDiv)validationErrorOverallDiv.innerHTML='';
        for(const k in mainFormSchema){const el=document.getElementById(k); if(el && !validateSingleAriseField(k,el.value,mainFormSchema[k]))iV=false;} return iV;
    }
    
    if(form) form.addEventListener('submit', function (event) { /* ... same as Turn 39 ... */
        event.preventDefault(); if(calculationLoader)calculationLoader.style.display='inline-flex';
        if(!validateMainAriseForm()){if(calculationLoader)calculationLoader.style.display='none'; return;}
        const pI={age:parseInt(document.getElementById('age').value),sex:document.getElementById('sex').value,cci:parseInt(document.getElementById('cci').value),nyha:document.getElementById('nyha').value,aodi:parseInt(document.getElementById('aodi').value),lvef:parseInt(document.getElementById('lvef').value),lvesdi:parseInt(document.getElementById('lvesdi').value)};
        setTimeout(()=>{const r=getAriseScoreCalculatorResults_Main(pI); updateNomogramPointsDisplay(r.factorPoints,r.totalPoints); updateResultsTable(r.totalPoints,r.survivalProbabilities,r.riskGroups); updateChart(r.totalPoints,r.survivalProbabilities); if(calculationLoader)calculationLoader.style.display='none';},300);
    });

    function updateNomogramPointsDisplay(perVarScores, totalPts) { /* ... same as Turn 39, with checks ... */ 
        const ids = ['age','sex','cci','nyha','aodi','lvef','lvesdi']; ids.forEach(id=>{const el=document.getElementById(`nomogram_${id}_points`); if(el && perVarScores[id]!==undefined)el.textContent=perVarScores[id].toFixed(1);});
        const tpnEl=document.getElementById('nomogram_total_points_no'); if(tpnEl)tpnEl.textContent=totalPts.noAVS;
        const tpyEl=document.getElementById('nomogram_total_points_yes'); if(tpyEl)tpyEl.textContent=totalPts.yesAVS;
        const NOMOGRAM_MAX=150; ['no_avs','yes_avs'].forEach(type=>{const m=document.getElementById(`marker_${type}`);const pts=type==='no_avs'?totalPts.noAVS:totalPts.yesAVS; if(m){let pct=(pts/NOMOGRAM_MAX)*100;pct=Math.min(100,Math.max(0,pct));m.style.left=`calc(${pct}% - ${m.offsetWidth/2}px)`;m.textContent=pts;}});
    }
    function updateResultsTable(totalPts, survivalProbs, riskGroups) { /* ... same as Turn 39 ... */ 
        const f={tpn:totalPts.noAVS,tpy:totalPts.yesAVS,s1n:(survivalProbs.noAVS.oneYear*100).toFixed(1)+'%',s1y:(survivalProbs.yesAVS.oneYear*100).toFixed(1)+'%',b1:((survivalProbs.yesAVS.oneYear-survivalProbs.noAVS.oneYear)*100).toFixed(1)+'%',s3n:(survivalProbs.noAVS.threeYear*100).toFixed(1)+'%',s3y:(survivalProbs.yesAVS.threeYear*100).toFixed(1)+'%',b3:((survivalProbs.yesAVS.threeYear-survivalProbs.noAVS.threeYear)*100).toFixed(1)+'%',s5n:(survivalProbs.noAVS.fiveYear*100).toFixed(1)+'%',s5y:(survivalProbs.yesAVS.fiveYear*100).toFixed(1)+'%',b5:((survivalProbs.yesAVS.fiveYear-survivalProbs.noAVS.fiveYear)*100).toFixed(1)+'%',rgn:riskGroups.noAVS,rgy:riskGroups.yesAVS};
        const ids={totalPoints_no:'tpn',totalPoints_yes:'tpy',survival_1y_no:'s1n',survival_1y_yes:'s1y',benefit_1y:'b1',survival_3y_no:'s3n',survival_3y_yes:'s3y',benefit_3y:'b3',survival_5y_no:'s5n',survival_5y_yes:'s5y',benefit_5y:'b5',riskGroup_no:'rgn',riskGroup_yes:'rgy'};
        for(const id in ids){const el=document.getElementById(id); if(el)el.textContent=f[ids[id]];}
    }
    function clearResultsAndNomogramPoints() { /* ... same as Turn 39 ... */ 
        const nids=['age','sex','cci','nyha','aodi','lvef','lvesdi']; nids.forEach(id=>{const e=document.getElementById(`nomogram_${id}_points`);if(e)e.textContent='0';});
        ['nomogram_total_points_no','nomogram_total_points_yes'].forEach(id=>{const e=document.getElementById(id);if(e)e.textContent='0';});
        const tids=['totalPoints_no','totalPoints_yes','survival_1y_no','survival_1y_yes','benefit_1y','survival_3y_no','survival_3y_yes','benefit_3y','survival_5y_no','survival_5y_yes','benefit_5y','riskGroup_no','riskGroup_yes'];
        tids.forEach(id=>{const e=document.getElementById(id);if(e)e.textContent='--';});
        ['marker_no_avs','marker_yes_avs'].forEach(id=>{const m=document.getElementById(id);if(m){m.style.left='0%';m.textContent='0';}});
        if(chartInstance){chartInstance.data.datasets.forEach(ds=>ds.data=[100,null,null,null]); chartInstance.update('none');} else {initChart();}
    }
    
    if(resetButton) resetButton.addEventListener('click', function() { /* ... same as Turn 39, no auto-calc ... */
        if(form) form.reset(); 
        inputsConfig.forEach(conf => { 
            const numInput = document.getElementById(conf.id); const sliderInput = document.getElementById(conf.sliderId);
            const valToSet = conf.defaultVal; 
            if (numInput) numInput.value = valToSet; 
            if (sliderInput) sliderInput.value = valToSet || conf.min;
            const errorElement = document.getElementById(conf.id + 'Error'); if(errorElement) errorElement.textContent = '';
            if(numInput) numInput.classList.remove('input-error-border');
        });
        if(document.getElementById('sex')) document.getElementById('sex').value = "male"; 
        if(document.getElementById('nyha')) document.getElementById('nyha').value = "1";
        const cciErr = document.getElementById('cciError'); if(cciErr) cciErr.textContent = ''; if(document.getElementById('cci')) document.getElementById('cci').classList.remove('input-error-border');
        const sexErr = document.getElementById('sexError'); if(sexErr) sexErr.textContent = ''; if(document.getElementById('sex')) document.getElementById('sex').classList.remove('input-error-border');
        const nyhaErr = document.getElementById('nyhaError'); if(nyhaErr) nyhaErr.textContent = ''; if(document.getElementById('nyha')) document.getElementById('nyha').classList.remove('input-error-border');
        if(validationErrorOverallDiv) validationErrorOverallDiv.textContent = '';
        clearResultsAndNomogramPoints();
    });

    function updateAllText() { /* ... same as Turn 39 ... */ 
        document.documentElement.lang = currentLanguage; document.querySelectorAll('[data-lang-key]').forEach(el=>{const k=el.getAttribute('data-lang-key');const t=translations[currentLanguage]?.[k]; if(t){if(el.tagName==='INPUT'&&(el.type==='submit'||el.type==='button'))el.value=t;else if(el.tagName==='TITLE')document.title=t;else el.innerHTML=t;}});
        if(chartInstance){ const lang=currentLanguage; chartInstance.data.labels=[translations[lang].chartLabelBaseline,`1 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`,`3 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`,`5 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`]; chartInstance.data.datasets[0].label=translations[lang].chartSurvivalNoAVS; chartInstance.data.datasets[1].label=translations[lang].chartSurvivalYesAVS; chartInstance.options.scales.y.title.text=translations[lang].chartLabelSurvivalRate; chartInstance.options.scales.x.title.text=translations[lang].chartLabelTimeYears; chartInstance.update('none');}
        if(document.getElementById('cciModal')){populateCciConditions();['cciModalTitle','cciModalTotalScore','cciModalNote','cciModalCancel','cciModalApply'].forEach(k=>{const e=cciModal.querySelector(`[data-lang-key="${k}"]`);if(e&&translations[currentLanguage][k])e.textContent=translations[currentLanguage][k];});}
    }

    if(languageSelector) languageSelector.addEventListener('change', (e) => { /* ... same as Turn 39 ... */ 
        currentLanguage = e.target.value; localStorage.setItem('ariseCalculatorLanguage', currentLanguage); updateAllText();
    });

    // --- CCI Calculator (Modal) ---
    const cciModal = document.getElementById('cciModal'); /* ... rest of CCI logic same as Turn 39 ... */
    const openCciModalButton = document.getElementById('openCciModalButton'); const closeCciModalButton = document.getElementById('closeCciModalButton'); const cancelCciButton = document.getElementById('cancelCciButton'); const applyCciButton = document.getElementById('applyCciButton'); const cciConditionsContainer = document.getElementById('cciConditionsContainer'); const cciScoreDisplay = document.getElementById('cciScoreDisplay'); const mainCciInput = document.getElementById('cci'); const mainCciSlider = document.getElementById('cci_slider');
    const cciConditionPoints = {mi:1,chf:1,pvd:1,cvd:1,dementia:1,cpd:1,ctd:1,pud:1,mld:1,diabetes_no_ed:1,hemiplegia:2,renal_mod_sev:2,diabetes_ed:2,tumor_no_meta:2,leukemia:2,lymphoma:2,liver_mod_sev:3,tumor_meta:6,aids:6};
    function populateCciConditions(){if(!cciConditionsContainer)return;cciConditionsContainer.innerHTML='';Object.keys(cciConditionPoints).forEach(k=>{const n=translations[currentLanguage]?.[k]||k;const p=cciConditionPoints[k];const l=document.createElement('label');l.className='flex items-center space-x-3 p-2.5 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer';l.innerHTML=`<input type="checkbox" name="cci_cond" value="${p}" class="form-checkbox h-4 w-4 accent-blue-600"><span class="text-slate-700 dark:text-slate-300">${n} (+${p})</span>`;cciConditionsContainer.appendChild(l);});cciConditionsContainer.querySelectorAll('input[type="checkbox"]').forEach(cb=>cb.addEventListener('change',updateCciScoreInModal));}
    function updateCciScoreInModal(){if(!cciScoreDisplay||!cciConditionsContainer)return;let t=0;cciConditionsContainer.querySelectorAll('input[name="cci_cond"]:checked').forEach(cb=>t+=parseInt(cb.value));cciScoreDisplay.textContent=t;}
    if(openCciModalButton)openCciModalButton.addEventListener('click',()=>{if(cciModal){cciModal.classList.remove('hidden');document.body.classList.add('modal-active-body-scroll-lock');updateCciScoreInModal();}});
    if(closeCciModalButton)closeCciModalButton.addEventListener('click',()=>{if(cciModal){cciModal.classList.add('hidden');document.body.classList.remove('modal-active-body-scroll-lock');}});
    if(cancelCciButton)cancelCciButton.addEventListener('click',()=>{if(cciModal){cciModal.classList.add('hidden');document.body.classList.remove('modal-active-body-scroll-lock');}});
    if(applyCciButton)applyCciButton.addEventListener('click',()=>{if(mainCciInput&&cciScoreDisplay&&mainCciSlider){let nC=parseInt(cciScoreDisplay.textContent);const minC=0,maxC=9;if(nC>maxC){alert((translations[currentLanguage].errorRange||"").replace('{label}',translations[currentLanguage].labelCCI).replace('{min}',minC).replace('{max}',maxC)+` (Calculated: ${nC}). Using ${maxC}.`);nC=maxC;}else if(nC<minC)nC=minC;mainCciInput.value=nC;mainCciSlider.value=nC;}if(cciModal){cciModal.classList.add('hidden');document.body.classList.remove('modal-active-body-scroll-lock');}validateSingleAriseField('cci',mainCciInput.value,mainFormSchema.cci);});

    // --- LVESDi Estimator Logic (Outputs rounded integer for LVESDi) ---
    const toggleLvesdiEstimatorButton = document.getElementById('toggleLvesdiEstimatorButton'); /* ... rest of LVESDi estimator logic same as Turn 39, ensuring output LVESDi is ROUNDED ... */
    const lvesdiEstimatorSection=document.getElementById('lvesdiEstimatorSection');const lvesdiEstimatorIcon=document.getElementById('lvesdiEstimatorIcon');const calculateLvesdiButton=document.getElementById('calculateLvesdiButton');const lvesdiEstimationResultEl=document.getElementById('lvesdiEstimationResult');const mainLvesdiInput=document.getElementById('lvesdi');const mainLvesdiSlider=document.getElementById('lvesdi_slider');
    if(toggleLvesdiEstimatorButton)toggleLvesdiEstimatorButton.addEventListener('click',()=>{if(lvesdiEstimatorSection)lvesdiEstimatorSection.classList.toggle('hidden');if(lvesdiEstimatorIcon){lvesdiEstimatorIcon.classList.toggle('fa-chevron-down');lvesdiEstimatorIcon.classList.toggle('fa-chevron-up');}});
    const estimatorSchema={estimatorLvdd:{min:20,max:100,labelKey:"labelLVDD",isInteger:true,isRequired:true},estimatorHeight:{min:100,max:250,labelKey:"labelHeight",isInteger:true,isRequired:true},estimatorWeight:{min:20,max:250,labelKey:"labelWeight",isInteger:false,step:0.1,isRequired:true}};
    function validateEstimatorForm(){let iV=true;for(const k in estimatorSchema){const e=document.getElementById(k);if(e&&!validateSingleAriseField(k,e.value,estimatorSchema[k]))iV=false;}const mLE=document.getElementById('lvef');if(mLE&&!validateSingleAriseField('lvef',mLE.value,mainFormSchema.lvef)){iV=false;if(lvesdiEstimationResultEl){lvesdiEstimationResultEl.textContent=translations[currentLanguage].errorLVEFForEstimator;lvesdiEstimationResultEl.classList.add('text-red-500');}}return iV;}
    if(calculateLvesdiButton)calculateLvesdiButton.addEventListener('click',()=>{if(lvesdiEstimationResultEl){lvesdiEstimationResultEl.textContent='';lvesdiEstimationResultEl.classList.remove('text-red-500');}if(!validateEstimatorForm()){if(lvesdiEstimationResultEl&&!lvesdiEstimationResultEl.textContent){lvesdiEstimationResultEl.textContent=translations[currentLanguage].lvesdiNotCalculated;lvesdiEstimationResultEl.classList.add('text-red-500');}return;}const lvef=parseInt(document.getElementById('lvef').value);const lvdd_mm=parseInt(document.getElementById('estimatorLvdd').value);const height_cm=parseInt(document.getElementById('estimatorHeight').value);const weight_kg=parseFloat(document.getElementById('estimatorWeight').value);const bsa=0.007184*Math.pow(height_cm,0.725)*Math.pow(weight_kg,0.425);const lvesd3=Math.pow(lvdd_mm,3)*(1-(lvef/100));const lvesd=Math.cbrt(lvesd3);let lvesdi_est_raw=lvesd/bsa;if(!isNaN(lvesdi_est_raw)&&isFinite(lvesdi_est_raw)){const finalLVESDi=Math.round(lvesdi_est_raw);const minLVESDi=parseInt(mainLvesdiInput.min);const maxLVESDi=parseInt(mainLvesdiInput.max);let clamped=finalLVESDi;if(finalLVESDi<minLVESDi){clamped=minLVESDi;alert((translations[currentLanguage].errorRange||"").replace('{label}',translations[currentLanguage].labelLVESDi).replace('{min}',minLVESDi).replace('{max}',maxLVESDi)+` (Est: ${finalLVESDi}, Raw: ${lvesdi_est_raw.toFixed(1)}). Using ${minLVESDi}.`);}else if(finalLVESDi>maxLVESDi){clamped=maxLVESDi;alert((translations[currentLanguage].errorRange||"").replace('{label}',translations[currentLanguage].labelLVESDi).replace('{min}',minLVESDi).replace('{max}',maxLVESDi)+` (Est: ${finalLVESDi}, Raw: ${lvesdi_est_raw.toFixed(1)}). Using ${maxLVESDi}.`);}mainLvesdiInput.value=clamped;if(mainLvesdiSlider)mainLvesdiSlider.value=clamped;if(lvesdiEstimationResultEl)lvesdiEstimationResultEl.textContent=(translations[currentLanguage].lvesdiCalculated).replace('{value}',clamped).replace('{bsa}',bsa.toFixed(2));validateSingleAriseField('lvesdi',mainLvesdiInput.value,mainFormSchema.lvesdi);}else{if(lvesdiEstimationResultEl){lvesdiEstimationResultEl.textContent=translations[currentLanguage].lvesdiNotCalculated;lvesdiEstimationResultEl.classList.add('text-red-500');}}});
    
    // Chart.js Integration
    function initChart() { /* ... same as Turn 39, ensures chart is initialized ... */ 
        const ctx = document.getElementById('survivalCurveChart'); if (!ctx) return;
        const data = { labels: [], datasets: [ {data:[100,null,null,null],tension:0.2,fill:true,pointRadius:5,pointHoverRadius:7}, {data:[100,null,null,null],tension:0.2,fill:true,pointRadius:5,pointHoverRadius:7} ]};
        if (chartInstance) chartInstance.destroy();
        chartInstance = new Chart(ctx.getContext('2d'), { type: 'line', data: data, options: { 
            responsive: true, maintainAspectRatio: false,
            scales: { y: { beginAtZero: true, max: 100, title:{display:true,text:"",color: document.body.classList.contains('dark')?'#94A3B8':'#4B5563',font:{size:12}}, grid:{color:document.body.classList.contains('dark')?'rgba(255,255,255,0.1)':'rgba(0,0,0,0.05)'},ticks:{color:document.body.classList.contains('dark')?'#CBD5E1':'#6B7280',stepSize:20,callback:v=>v+'%'}},
                      x: { title:{display:true,text:"",color:document.body.classList.contains('dark')?'#94A3B8':'#4B5563',font:{size:12}}, grid:{display:false},ticks:{color:document.body.classList.contains('dark')?'#CBD5E1':'#6B7280'}}},
            plugins: { legend:{position:'bottom',labels:{color:document.body.classList.contains('dark')?'#E2E8F0':'#374151',font:{size:11},usePointStyle:true,padding:15}}, tooltip:{mode:'index',intersect:false,callbacks:{label:ctx=>`${ctx.dataset.label||''}: ${ctx.parsed.y.toFixed(1)}%`}}},
            elements: {line:{borderWidth:2.5},point:{hitRadius:10}}
        }});
         updateAllText(); // Ensure chart labels are set on init
    }
    function updateChart(totalPoints, survivalProbs) { /* ... same as Turn 39 ... */ 
        if (!chartInstance||!survivalProbs||!survivalProbs.noAVS||!survivalProbs.yesAVS) return; const lang=currentLanguage;
        chartInstance.data.labels=[translations[lang].chartLabelBaseline,`1 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`,`3 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`,`5 ${translations[lang].chartLabelTimeYears.split(' ')[0]}`];
        chartInstance.data.datasets[0].label=translations[lang].chartSurvivalNoAVS; chartInstance.data.datasets[0].data=[100,survivalProbs.noAVS.oneYear*100,survivalProbs.noAVS.threeYear*100,survivalProbs.noAVS.fiveYear*100]; chartInstance.data.datasets[0].borderColor='rgb(239,68,68)';chartInstance.data.datasets[0].backgroundColor=document.body.classList.contains('dark')?'rgba(239,68,68,0.2)':'rgba(239,68,68,0.1)';chartInstance.data.datasets[0].pointBackgroundColor='rgb(239,68,68)';
        chartInstance.data.datasets[1].label=translations[lang].chartSurvivalYesAVS; chartInstance.data.datasets[1].data=[100,survivalProbs.yesAVS.oneYear*100,survivalProbs.yesAVS.threeYear*100,survivalProbs.yesAVS.fiveYear*100]; chartInstance.data.datasets[1].borderColor='rgb(59,130,246)';chartInstance.data.datasets[1].backgroundColor=document.body.classList.contains('dark')?'rgba(59,130,246,0.2)':'rgba(59,130,246,0.1)';chartInstance.data.datasets[1].pointBackgroundColor='rgb(59,130,246)';
        chartInstance.options.scales.y.title.text=translations[lang].chartLabelSurvivalRate; chartInstance.options.scales.x.title.text=translations[lang].chartLabelTimeYears;
        chartInstance.update();
    }
    
    function initializeApp() { /* No auto-calc, default Chinese */
        const cs=document.getElementById('currentYear'); if(cs)cs.textContent=new Date().getFullYear();
        const sl=localStorage.getItem('ariseCalculatorLanguage'); if(sl&&translations[sl])currentLanguage=sl; else currentLanguage='zh';
        if(languageSelector)languageSelector.value=currentLanguage;
        populateCciConditions(); showTab('who'); updateAllText(); 
        inputsConfig.forEach(cf=>{const ni=document.getElementById(cf.id); const si=document.getElementById(cf.sliderId); if(ni)ni.value=cf.defaultVal; if(si)si.value=cf.defaultVal||cf.min;});
        if(document.getElementById('sex'))document.getElementById('sex').value="male"; if(document.getElementById('nyha'))document.getElementById('nyha').value="1";
        const cciNI=document.getElementById('cci'); const cciSI=document.getElementById('cci_slider'); const cciConf=inputsConfig.find(c=>c.id==='cci');
        if(cciNI&&cciConf)cciNI.value=cciConf.defaultVal; if(cciSI&&cciConf)cciSI.value=cciConf.defaultVal||cciConf.min;
        clearResultsAndNomogramPoints();
    }

    initializeApp();
});
</script>
</body>
</html>