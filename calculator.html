<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-lang-key="pageTitle">ARISE Score 预后评估 - HeartValve.pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
        }
        .input-error-border { /* Renamed to avoid conflict if Tailwind introduces input-error */
            border-color: #EF4444; /* Tailwind red-500 */
        }
        .error-message {
            color: #EF4444; /* Tailwind red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem; /* mt-1 */
        }
        .loader {
            border: 4px solid #f3f3f3; /* Light grey */
            border-top: 4px solid #3B82F6; /* Tailwind blue-500 */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none; /* Hidden by default */
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Modal styles */
        .modal {
            transition: opacity 0.25s ease;
            z-index: 100; /* Ensure modal is on top */
        }
        .modal-active {
            overflow-x: hidden;
            overflow-y: auto;
        }
        .modal-content {
            max-height: 90vh;
            overflow-y: auto;
        }
        .debug-info { /* For debugging, can be removed later */
            font-size: 0.75rem;
            color: #6B7280; /* Tailwind gray-500 */
            margin-top: 0.5rem;
        }
    </style>
</head>
<body class="bg-slate-100 dark:bg-slate-900 text-slate-800 dark:text-slate-200 transition-colors duration-300">

    <nav class="bg-white dark:bg-slate-800 shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="index.html" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 dark:hover:text-blue-300 transition-colors text-lg font-semibold flex items-center">
                    <i class="fas fa-arrow-left mr-2"></i><span data-lang-key="backToHome">返回首页</span>
                </a>
                <div class="flex items-center">
                    <span class="text-sm mr-2 text-slate-600 dark:text-slate-400" data-lang-key="languageLabel">语言:</span>
                    <select id="languageSelector" class="bg-slate-200 dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md p-1.5 text-sm focus:ring-blue-500 focus:border-blue-500">
                        <option value="zh" data-lang-key="langChinese">中文</option>
                        <option value="en" data-lang-key="langEnglish">English</option>
                    </select>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-8 max-w-5xl">
        <header class="text-center mb-8 md:mb-12">
            <h1 class="text-3xl md:text-4xl font-bold text-blue-700 dark:text-blue-400" data-lang-key="calculatorTitle">ARISE Score 心脏瓣膜预后评估</h1>
            <p class="text-md text-slate-600 dark:text-slate-400 mt-3" data-lang-key="calculatorSubtitle">
                根据已发表列线图 (JACC Asia 2023 Figure S2) 估算1年、3年和5年全因死亡率。
                结果仅供研究参考，不构成医疗建议。请参考 <a href="https://arise-score.vercel.app/" target="_blank" rel="noopener noreferrer" class="text-blue-500 hover:underline">官方在线工具</a>。
            </p>
        </header>

        <main class="bg-white dark:bg-slate-800 shadow-2xl rounded-xl p-6 md:p-10">
            <form id="ariseForm" class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div>
                    <label for="age" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelAge">年龄 (岁)</label>
                    <input type="number" id="age" name="age" placeholder="例如: 65" required
                           class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <div class="error-message" id="ageError"></div>
                </div>
                <div>
                    <label for="sex" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelSex">性别</label>
                    <select id="sex" name="sex" required
                            class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="" data-lang-key="selectOption">请选择</option>
                        <option value="male" data-lang-key="sexMale">男 (Male)</option>
                        <option value="female" data-lang-key="sexFemale">女 (Female)</option>
                    </select>
                    <div class="error-message" id="sexError"></div>
                </div>

                <div>
                    <label for="cci" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelCCI">Charlson合并症指数 (CCI)</label>
                    <div class="flex items-center space-x-2">
                        <input type="number" id="cci" name="cci" placeholder="0-9+" min="0" required
                               class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <button type="button" id="openCciModalButton" class="mt-1 px-3 py-2 bg-sky-500 hover:bg-sky-600 text-white text-sm rounded-md whitespace-nowrap" data-lang-key="calculateCciButtonKey">计算CCI</button>
                    </div>
                    <div class="error-message" id="cciError"></div>
                </div>

                <div>
                    <label for="nyha" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelNYHA">NYHA 心功能分级</label>
                    <select id="nyha" name="nyha" required
                            class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="" data-lang-key="selectOption">请选择</option>
                        <option value="I" data-lang-key="nyhaI">I级</option>
                        <option value="II" data-lang-key="nyhaII">II级</option>
                        <option value="III" data-lang-key="nyhaIII">III级</option>
                        <option value="IV" data-lang-key="nyhaIV">IV级</option>
                    </select>
                     <div class="error-message" id="nyhaError"></div>
                </div>
                <div>
                    <label for="aodi" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelAoDi">主动脉直径指数 (AoDi, mm/m²)</label>
                    <input type="number" id="aodi" name="aodi" step="0.1" placeholder="例如: 25.6" required
                           class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                     <div class="error-message" id="aodiError"></div>
                </div>
                <div>
                    <label for="lvef" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelLVEF">左心室射血分数 (LVEF, %)</label>
                    <input type="number" id="lvef" name="lvef" placeholder="例如: 55" min="1" max="100" step="0.1" required
                           class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <div class="error-message" id="lvefError"></div>
                </div>

                <div class="md:col-span-2">
                    <label for="lvesdi" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelLVESDi">左心室收缩末期内径指数 (LVESDi, mm/m²)</label>
                    <input type="number" id="lvesdi" name="lvesdi" step="0.1" placeholder="例如: 24.6" required
                           class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    <div class="error-message" id="lvesdiError"></div>
                    <button type="button" id="toggleLvesdiEstimatorButton" class="mt-2 text-sm text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-300 flex items-center">
                        <span data-lang-key="toggleLvesdiEstimatorButtonKey">可选：通过LVDd等估算LVESDi</span>
                        <i id="lvesdiEstimatorIcon" class="fas fa-chevron-down ml-1 transform transition-transform text-xs"></i>
                    </button>

                    <div id="lvesdiEstimatorSection" class="hidden mt-3 p-4 border border-slate-200 dark:border-slate-600 rounded-md bg-slate-50 dark:bg-slate-700/30 space-y-4">
                        <p class="text-xs text-slate-600 dark:text-slate-400" data-lang-key="lvesdiEstimatorInfo">输入LVDd、身高和体重估算LVESDi。LVEF将从上方主表单获取。</p>
                        <div>
                            <label for="estimatorLvdd" class="block text-xs font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelLVDD">LVDd (左心室舒张末期内径, mm)</label>
                            <input type="number" id="estimatorLvdd" step="0.1" placeholder="例如: 50" class="mt-1 block w-full px-2 py-1.5 text-sm bg-white dark:bg-slate-600 border-slate-300 dark:border-slate-500 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="error-message text-xs" id="estimatorLvddError"></div>
                        </div>
                        <div>
                            <label for="estimatorHeight" class="block text-xs font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelHeight">身高 (cm)</label>
                            <input type="number" id="estimatorHeight" placeholder="例如: 170" class="mt-1 block w-full px-2 py-1.5 text-sm bg-white dark:bg-slate-600 border-slate-300 dark:border-slate-500 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="error-message text-xs" id="estimatorHeightError"></div>
                        </div>
                        <div>
                            <label for="estimatorWeight" class="block text-xs font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelWeight">体重 (kg)</label>
                            <input type="number" id="estimatorWeight" step="0.1" placeholder="例如: 70" class="mt-1 block w-full px-2 py-1.5 text-sm bg-white dark:bg-slate-600 border-slate-300 dark:border-slate-500 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500">
                            <div class="error-message text-xs" id="estimatorWeightError"></div>
                        </div>
                        <button type="button" id="calculateLvesdiButton" class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white text-sm rounded-md" data-lang-key="estimateLvesdiButtonKey">估算LVESDi并填充</button>
                        <div id="lvesdiEstimationResult" class="text-sm mt-2 text-slate-700 dark:text-slate-300"></div>
                    </div>
                </div>


                <div>
                    <label for="avsIn6Months" class="block text-sm font-medium text-slate-700 dark:text-slate-300" data-lang-key="labelAVS">6个月内是否进行主动脉瓣手术 (AVS)</label>
                    <select id="avsIn6Months" name="avsIn6Months" required
                            class="mt-1 block w-full px-3 py-2 bg-white dark:bg-slate-700 border border-slate-300 dark:border-slate-600 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="" data-lang-key="selectOption">请选择</option>
                        <option value="yes" data-lang-key="avsYes">是 (Yes)</option>
                        <option value="no" data-lang-key="avsNo">否 (No)</option>
                    </select>
                    <div class="error-message" id="avsIn6MonthsError"></div>
                </div>

                <div class="md:col-span-2 flex flex-col items-center mt-6">
                    <button type="button" id="calculateAriseButton"
                            class="w-full md:w-auto bg-gradient-to-r from-blue-600 to-indigo-700 hover:from-blue-700 hover:to-indigo-800 text-white font-semibold py-3 px-8 rounded-lg shadow-md hover:shadow-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-75 transition-all duration-150 ease-in-out transform hover:scale-105 flex items-center justify-center">
                        <i class="fas fa-calculator mr-2"></i>
                        <span data-lang-key="calculateButton">计算ARISE风险</span>
                        <div id="calculationLoader" class="loader ml-3"></div>
                    </button>
                </div>
            </form>

            <div id="resultArea" class="mt-10 md:mt-12 bg-slate-50 dark:bg-slate-700/50 p-6 rounded-lg shadow-inner">
                <h3 class="text-xl md:text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-6 text-center" data-lang-key="resultsTitle">计算结果</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-center">
                    <div class="p-4 bg-blue-100 dark:bg-blue-900/60 rounded-lg shadow">
                        <p class="text-sm font-medium text-blue-700 dark:text-blue-300 uppercase tracking-wider" data-lang-key="totalPointsLabel">总点数</p>
                        <p id="totalPoints" class="text-3xl font-bold text-blue-800 dark:text-blue-200 mt-1">--</p>
                    </div>
                    <div class="p-4 bg-green-100 dark:bg-green-900/60 rounded-lg shadow">
                        <p class="text-sm font-medium text-green-700 dark:text-green-300 uppercase tracking-wider" data-lang-key="riskCategoryLabel">风险类别</p>
                        <p id="riskCategory" class="text-2xl font-semibold text-green-800 dark:text-green-200 mt-1">--</p>
                    </div>
                    <div class="p-4 bg-sky-100 dark:bg-sky-900/60 rounded-lg shadow">
                        <p class="text-sm font-medium text-sky-700 dark:text-sky-300 uppercase tracking-wider" data-lang-key="survival1yrLabel">1年生存率</p>
                        <p id="survival1yr" class="text-2xl font-bold text-sky-800 dark:text-sky-200 mt-1">--%</p>
                    </div>
                    <div class="p-4 bg-indigo-100 dark:bg-indigo-900/60 rounded-lg shadow sm:col-start-1 lg:col-start-auto">
                        <p class="text-sm font-medium text-indigo-700 dark:text-indigo-300 uppercase tracking-wider" data-lang-key="survival3yrLabel">3年生存率</p>
                        <p id="survival3yr" class="text-2xl font-bold text-indigo-800 dark:text-indigo-200 mt-1">--%</p>
                    </div>
                     <div class="p-4 bg-purple-100 dark:bg-purple-900/60 rounded-lg shadow sm:col-start-auto lg:col-span-1">
                        <p class="text-sm font-medium text-purple-700 dark:text-purple-300 uppercase tracking-wider" data-lang-key="survival5yrLabel">5年生存率</p>
                        <p id="survival5yr" class="text-2xl font-bold text-purple-800 dark:text-purple-200 mt-1">--%</p>
                    </div>
                </div>
                 <p class="text-xs text-center mt-6 text-slate-500 dark:text-slate-400" data-lang-key="accuracyDisclaimer">
                    * 当前计算基于列线图 (JACC Asia 2023 Fig S2) 的估算，可能与官方在线工具的精确计算存在差异。请谨慎参考。
                </p>
            </div>

            <div class="mt-10 md:mt-12">
                <h3 class="text-xl md:text-2xl font-semibold text-slate-700 dark:text-slate-200 mb-4 text-center" data-lang-key="survivalCurveTitle">生存率曲线 (估算)</h3>
                <div class="bg-white dark:bg-slate-800 p-2 md:p-4 rounded-lg shadow-lg h-80 md:h-96">
                    <canvas id="survivalCurveChart"></canvas>
                </div>
            </div>
        </main>

        <footer class="text-center mt-12 py-8 border-t border-slate-200 dark:border-slate-700">
            <p class="text-sm text-slate-600 dark:text-slate-400">
                &copy; <span id="currentYear"></span> HeartValve.pro. <span data-lang-key="footerRights">保留所有权利.</span>
                 <span data-lang-key="footerDisclaimer">本工具仅供研究参考，不作为临床决策依据。</span>
            </p>        
        </footer>
    </div>

    <div id="cciModal" class="modal fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 hidden">
        <div class="modal-content bg-white dark:bg-slate-800 rounded-lg shadow-xl w-full max-w-2xl p-6 md:p-8">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-semibold text-slate-800 dark:text-slate-100" data-lang-key="cciModalTitle">Charlson合并症指数 (CCI) 计算器</h2>
                <button id="closeCciModalButton" class="text-slate-500 hover:text-slate-700 dark:text-slate-400 dark:hover:text-slate-200">
                    <i class="fas fa-times fa-lg"></i>
                </button>
            </div>
            <div id="cciConditionsContainer" class="space-y-3 text-sm max-h-80 overflow-y-auto pr-2">
                </div>
            <div class="mt-6">
                <p class="text-lg font-semibold text-slate-700 dark:text-slate-200">
                    <span data-lang-key="cciModalTotalScore">CCI 总分 (不含年龄):</span> 
                    <span id="cciScoreDisplay" class="text-blue-600 dark:text-blue-400 font-bold text-xl">0</span>
                </p>
                <p class="text-xs text-slate-500 dark:text-slate-400 mt-1" data-lang-key="cciModalNote">ARISE Score已单独包含年龄因素，此处CCI不重复计算年龄加分。</p>
            </div>
            <div class="mt-8 flex justify-end space-x-3">
                <button type="button" id="cancelCciButton" class="px-4 py-2 bg-slate-200 dark:bg-slate-600 hover:bg-slate-300 dark:hover:bg-slate-500 text-slate-700 dark:text-slate-200 rounded-md text-sm" data-lang-key="cciModalCancel">取消</button>
                <button type="button" id="applyCciButton" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md text-sm font-semibold" data-lang-key="cciModalApply">应用此CCI分数</button>
            </div>
        </div>
    </div>


    <script>
        const translations = {
            // ... (Translations object will be large, providing it at the end of the script block)
            zh: {
                pageTitle: "ARISE Score 预后评估 - HeartValve.pro",
                backToHome: "返回首页",
                languageLabel: "语言:",
                langChinese: "中文",
                langEnglish: "English",
                calculatorTitle: "ARISE Score 心脏瓣膜预后评估",
                calculatorSubtitle: "根据已发表列线图 (JACC Asia 2023 Figure S2) 估算1年、3年和5年全因死亡率。结果仅供研究参考，不构成医疗建议。请参考官方在线工具。",
                labelAge: "年龄 (岁)",
                labelSex: "性别",
                selectOption: "请选择",
                sexMale: "男 (Male)",
                sexFemale: "女 (Female)",
                labelCCI: "Charlson合并症指数 (CCI)",
                calculateCciButtonKey: "计算CCI",
                labelNYHA: "NYHA 心功能分级",
                nyhaI: "I级",
                nyhaII: "II级",
                nyhaIII: "III级",
                nyhaIV: "IV级",
                labelAoDi: "主动脉直径指数 (AoDi, mm/m²)",
                labelLVEF: "左心室射血分数 (LVEF, %)",
                labelLVESDi: "左心室收缩末期内径指数 (LVESDi, mm/m²)",
                toggleLvesdiEstimatorButtonKey: "可选：通过LVDd等估算LVESDi",
                lvesdiEstimatorInfo: "输入LVDd、身高和体重估算LVESDi。LVEF将从上方主表单获取。",
                labelLVDD: "LVDd (左心室舒张末期内径, mm)",
                labelHeight: "身高 (cm)",
                labelWeight: "体重 (kg)",
                estimateLvesdiButtonKey: "估算LVESDi并填充",
                lvesdiNotCalculated: "LVESDi 未计算或输入无效。",
                lvesdiCalculated: "估算 LVESDi: {value} mm/m² (BSA: {bsa} m²)",
                labelAVS: "6个月内是否进行主动脉瓣手术 (AVS)",
                avsYes: "是 (Yes)",
                avsNo: "否 (No)",
                calculateButton: "计算ARISE风险",
                resultsTitle: "计算结果",
                totalPointsLabel: "总点数",
                riskCategoryLabel: "风险类别",
                riskLow: "低危",
                riskMedium: "中危",
                riskHigh: "高危",
                survival1yrLabel: "1年生存率",
                survival3yrLabel: "3年生存率",
                survival5yrLabel: "5年生存率",
                accuracyDisclaimer: "* 当前计算基于列线图 (JACC Asia 2023 Fig S2) 的估算，可能与官方在线工具的精确计算存在差异。请谨慎参考。",
                survivalCurveTitle: "生存率曲线 (估算)",
                chartLabelSurvival: "生存率",
                chartLabelTimeYears: "时间 (年)",
                chartLabelBaseline: "基线",
                chartTitleSurvivalPoints: "生存率 (总点数: {points})",
                errorRequired: "此字段为必填项。",
                errorNumber: "请输入有效的数字。",
                errorMin: "必须大于或等于 {min}。",
                errorMax: "必须小于或等于 {max}。",
                errorRange: "必须介于 {min} 和 {max} 之间。",
                errorLVEFForEstimator: "请输入有效的LVEF值以估算LVESDi。",
                footerRights: "保留所有权利.",
                footerDisclaimer: "本工具仅供研究参考，不作为临床决策依据。",
                cciModalTitle: "Charlson合并症指数 (CCI) 计算器",
                cciModalTotalScore: "CCI 总分 (不含年龄):",
                cciModalNote: "ARISE Score已单独包含年龄因素，此处CCI不重复计算年龄加分。",
                cciModalCancel: "取消",
                cciModalApply: "应用此CCI分数",
                // CCI Conditions (Chinese) - Standard Charlson, points are fixed in logic
                mi: "心肌梗死",
                chf: "充血性心力衰竭",
                pvd: "外周血管疾病",
                cvd: "脑血管疾病",
                dementia: "痴呆",
                cpd: "慢性肺病",
                ctd: "结缔组织病",
                pud: "消化性溃疡病",
                mld: "轻度肝病",
                diabetes_no_ed: "糖尿病 (无终末器官损害)",
                hemiplegia: "偏瘫或截瘫",
                renal_mod_sev: "中度或重度肾病",
                diabetes_ed: "糖尿病 (伴终末器官损害)",
                tumor_no_meta: "任何肿瘤 (无转移)",
                leukemia: "白血病",
                lymphoma: "淋巴瘤",
                liver_mod_sev: "中度或重度肝病",
                tumor_meta: "转移性实体瘤",
                aids: "艾滋病 (AIDS)"
            },
            en: {
                pageTitle: "ARISE Score Prognostic Assessment - HeartValve.pro",
                backToHome: "Back to Home",
                languageLabel: "Language:",
                langChinese: "中文",
                langEnglish: "English",
                calculatorTitle: "ARISE Score Cardiac Valve Prognostic Assessment",
                calculatorSubtitle: "Estimates 1-year, 3-year, and 5-year all-cause mortality based on the published nomogram (JACC Asia 2023 Figure S2). Results are for research reference only and do not constitute medical advice. Please refer to the official online tool.",
                labelAge: "Age (years)",
                labelSex: "Sex",
                selectOption: "Please select",
                sexMale: "Male",
                sexFemale: "Female",
                labelCCI: "Charlson Comorbidity Index (CCI)",
                calculateCciButtonKey: "Calculate CCI",
                labelNYHA: "NYHA Functional Class",
                nyhaI: "Class I",
                nyhaII: "Class II",
                nyhaIII: "Class III",
                nyhaIV: "Class IV",
                labelAoDi: "Aortic Diameter Index (AoDi, mm/m²)",
                labelLVEF: "Left Ventricular Ejection Fraction (LVEF, %)",
                labelLVESDi: "Left Ventricular End-Systolic Diameter Index (LVESDi, mm/m²)",
                toggleLvesdiEstimatorButtonKey: "Optional: Estimate LVESDi via LVDd, etc.",
                lvesdiEstimatorInfo: "Enter LVDd, height, and weight to estimate LVESDi. LVEF will be taken from the main form above.",
                labelLVDD: "LVDd (Left Ventricular End-Diastolic Diameter, mm)",
                labelHeight: "Height (cm)",
                labelWeight: "Weight (kg)",
                estimateLvesdiButtonKey: "Estimate & Fill LVESDi",
                lvesdiNotCalculated: "LVESDi not calculated or inputs invalid.",
                lvesdiCalculated: "Estimated LVESDi: {value} mm/m² (BSA: {bsa} m²)",
                labelAVS: "Aortic Valve Surgery (AVS) within 6 months",
                avsYes: "Yes",
                avsNo: "No",
                calculateButton: "Calculate ARISE Risk",
                resultsTitle: "Calculation Results",
                totalPointsLabel: "Total Points",
                riskCategoryLabel: "Risk Category",
                riskLow: "Low Risk",
                riskMedium: "Medium Risk",
                riskHigh: "High Risk",
                survival1yrLabel: "1-Year Survival",
                survival3yrLabel: "3-Year Survival",
                survival5yrLabel: "5-Year Survival",
                accuracyDisclaimer: "* Current calculation is an estimation based on the nomogram (JACC Asia 2023 Fig S2) and may differ from the precise calculations of the official online tool. Please use with caution.",
                survivalCurveTitle: "Survival Curve (Estimated)",
                chartLabelSurvival: "Survival Rate",
                chartLabelTimeYears: "Time (Years)",
                chartLabelBaseline: "Baseline",
                chartTitleSurvivalPoints: "Survival Rate (Total Points: {points})",
                errorRequired: "This field is required.",
                errorNumber: "Please enter a valid number.",
                errorMin: "Must be greater than or equal to {min}.",
                errorMax: "Must be less than or equal to {max}.",
                errorRange: "Must be between {min} and {max}.",
                errorLVEFForEstimator: "Please enter a valid LVEF to estimate LVESDi.",
                footerRights: "All rights reserved.",
                footerDisclaimer: "This tool is for research reference only and not a basis for clinical decisions.",
                cciModalTitle: "Charlson Comorbidity Index (CCI) Calculator",
                cciModalTotalScore: "CCI Total Score (excluding age):",
                cciModalNote: "ARISE Score already includes age as a factor; CCI here does not add points for age again.",
                cciModalCancel: "Cancel",
                cciModalApply: "Apply this CCI Score",
                // CCI Conditions (English)
                mi: "Myocardial Infarction",
                chf: "Congestive Heart Failure",
                pvd: "Peripheral Vascular Disease",
                cvd: "Cerebrovascular Disease",
                dementia: "Dementia",
                cpd: "Chronic Pulmonary Disease",
                ctd: "Connective Tissue Disease",
                pud: "Peptic Ulcer Disease",
                mld: "Mild Liver Disease",
                diabetes_no_ed: "Diabetes (without end-organ damage)",
                hemiplegia: "Hemiplegia or Paraplegia",
                renal_mod_sev: "Moderate or Severe Renal Disease",
                diabetes_ed: "Diabetes (with end-organ damage)",
                tumor_no_meta: "Any Tumor (without metastases)",
                leukemia: "Leukemia",
                lymphoma: "Lymphoma",
                liver_mod_sev: "Moderate or Severe Liver Disease",
                tumor_meta: "Metastatic Solid Tumor",
                aids: "AIDS"
            }
        };

        let currentLanguage = 'zh';
        let survivalCurveChart = null;

        // --- ARISE Score Nomogram Scales (DO NOT CHANGE - Preserving "perfect" calculation) ---
        const nomogramScales = {
            age: { range: [20, 90], points: [0, 100] },
            sex: { female: 0, male: 8 },
            cci: { range: [0, 9], points: [0, 65] },
            nyha: { 'I': 0, 'II': 12, 'III': 45, 'IV': 72 },
            aodi: { range: [20, 45], points: [0, 58] },
            lvef: { range: [80, 20], points: [0, 30], inverse: true },
            lvesdi: { range: [15, 35], points: [0, 30] },
            avsIn6Months: { no: 0, yes: -38 }
        };

        const survivalRatesMap = {
            '1yr': [
                { points: 0, rate: 99 }, { points: 50, rate: 97 }, { points: 100, rate: 92 },
                { points: 150, rate: 85 }, { points: 200, rate: 75 }, { points: 250, rate: 60 },
                { points: 280, rate: 50 }, { points: 300, rate: 40 }, { points: 320, rate: 30 }
            ],
            '3yr': [
                { points: 0, rate: 98 }, { points: 50, rate: 92 }, { points: 100, rate: 80 },
                { points: 150, rate: 65 }, { points: 200, rate: 50 }, { points: 250, rate: 35 },
                { points: 280, rate: 25 }, { points: 300, rate: 18 }, { points: 320, rate: 10 }
            ],
            '5yr': [
                { points: 0, rate: 95 }, { points: 50, rate: 85 }, { points: 100, rate: 70 },
                { points: 150, rate: 50 }, { points: 200, rate: 35 }, { points: 250, rate: 20 },
                { points: 280, rate: 12 }, { points: 300, rate: 8 }, { points: 320, rate: 5 }
            ]
        };

        // --- Charlson Comorbidities and their standard points (Age component is NOT added here) ---
        const cciConditionPoints = {
            mi: 1, chf: 1, pvd: 1, cvd: 1, dementia: 1, cpd: 1, ctd: 1, pud: 1, mld: 1, diabetes_no_ed: 1,
            hemiplegia: 2, renal_mod_sev: 2, diabetes_ed: 2, tumor_no_meta: 2, leukemia: 2, lymphoma: 2,
            liver_mod_sev: 3,
            tumor_meta: 6, aids: 6
        };


        // --- Helper: Interpolation (Core ARISE logic - DO NOT CHANGE) ---
        function interpolate(value, scalePoints, scaleValues, isInverse = false) {
            const valMin = Math.min(scaleValues[0], scaleValues[1]);
            const valMax = Math.max(scaleValues[0], scaleValues[1]);
            value = Math.max(valMin, Math.min(valMax, parseFloat(value))); // Ensure value is float and clamped

            let v1, v2, p1, p2;
            if (isInverse) {
                v1 = scaleValues[0]; p1 = scalePoints[0];
                v2 = scaleValues[1]; p2 = scalePoints[1];
            } else {
                v1 = scaleValues[0]; p1 = scalePoints[0];
                v2 = scaleValues[1]; p2 = scalePoints[1];
            }
            if (v1 === v2) return p1;
            return p1 + ((value - v1) / (v2 - v1)) * (p2 - p1);
        }

        // --- Helper: Get Points for Value (Core ARISE logic - DO NOT CHANGE) ---
        function getPointsForValue(variableName, value) {
            const scale = nomogramScales[variableName];
            if (!scale) return 0;
            if (scale.points && scale.range) {
                return interpolate(value, scale.points, scale.range, !!scale.inverse);
            } else if (typeof scale === 'object' && value in scale) {
                return scale[value];
            }
            return 0;
        }

        // --- Helper: Get Survival Rate (Core ARISE logic - DO NOT CHANGE) ---
        function getSurvivalRateFromPoints(totalPoints, yearMap) {
            let lowerBound = { points: -Infinity, rate: 100 };
            let upperBound = { points: Infinity, rate: 0 };
            for (const item of yearMap) {
                if (item.points <= totalPoints && item.points > lowerBound.points) lowerBound = item;
                if (item.points >= totalPoints && item.points < upperBound.points) upperBound = item;
            }
            if (lowerBound.points === totalPoints) return lowerBound.rate;
            if (upperBound.points === totalPoints) return upperBound.rate;
            if (totalPoints < yearMap[0].points) return yearMap[0].rate;
            if (totalPoints > yearMap[yearMap.length - 1].points) return yearMap[yearMap.length - 1].rate;
            if (upperBound.points === lowerBound.points) return lowerBound.rate;
            const rate = lowerBound.rate + ((totalPoints - lowerBound.points) / (upperBound.points - lowerBound.points)) * (upperBound.rate - lowerBound.rate);
            return Math.max(0, Math.min(100, rate));
        }

        // --- Input Validation for Main ARISE Form ---
        function validateAriseForm() {
            let isValid = true;
            const fields = [
                { id: 'age', min: 18, max: 100, required: true, langKey: 'labelAge' },
                { id: 'sex', required: true, langKey: 'labelSex' },
                { id: 'cci', min: 0, max: 30, required: true, langKey: 'labelCCI' }, // Max CCI is an estimate
                { id: 'nyha', required: true, langKey: 'labelNYHA' },
                { id: 'aodi', min: 10, max: 70, step: 0.1, required: true, langKey: 'labelAoDi'}, // Example range
                { id: 'lvef', min: 5, max: 95, step:0.1, required: true, langKey: 'labelLVEF' }, // Example range
                { id: 'lvesdi', min: 5, max: 60, step: 0.1, required: true, langKey: 'labelLVESDi' }, // Example range
                { id: 'avsIn6Months', required: true, langKey: 'labelAVS' }
            ];

            fields.forEach(field => {
                const inputElement = document.getElementById(field.id);
                const errorElement = document.getElementById(field.id + 'Error');
                if (!inputElement || !errorElement) return;

                errorElement.textContent = '';
                inputElement.classList.remove('input-error-border');
                let value = inputElement.value;

                if (field.required && !value) {
                    errorElement.textContent = translations[currentLanguage].errorRequired;
                    inputElement.classList.add('input-error-border');
                    isValid = false;
                    return;
                }

                if (value && inputElement.type === 'number') {
                    value = parseFloat(value);
                    if (isNaN(value)) {
                        errorElement.textContent = translations[currentLanguage].errorNumber;
                        inputElement.classList.add('input-error-border');
                        isValid = false;
                        return;
                    }
                    if (field.min !== undefined && value < field.min) {
                        errorElement.textContent = (translations[currentLanguage].errorMin || "Must be >= {min}.").replace('{min}', field.min);
                        inputElement.classList.add('input-error-border');
                        isValid = false;
                    }
                    if (field.max !== undefined && value > field.max) {
                        errorElement.textContent = (translations[currentLanguage].errorMax || "Must be <= {max}.").replace('{max}', field.max);
                        inputElement.classList.add('input-error-border');
                        isValid = false;
                    }
                }
            });
            return isValid;
        }

        // --- Main ARISE Score Calculation and Display ---
        function calculateAriseScoreAndSurvival() {
            if (!validateAriseForm()) return;

            const loader = document.getElementById('calculationLoader');
            loader.style.display = 'inline-block';

            setTimeout(() => { // Simulate processing
                const age = parseFloat(document.getElementById('age').value);
                const sex = document.getElementById('sex').value;
                const cci = parseFloat(document.getElementById('cci').value);
                const nyha = document.getElementById('nyha').value;
                const aodi = parseFloat(document.getElementById('aodi').value);
                const lvef = parseFloat(document.getElementById('lvef').value);
                const lvesdi = parseFloat(document.getElementById('lvesdi').value);
                const avsIn6Months = document.getElementById('avsIn6Months').value;

                let totalPoints = 0;
                totalPoints += getPointsForValue('age', age);
                totalPoints += getPointsForValue('sex', sex);
                totalPoints += getPointsForValue('cci', cci);
                totalPoints += getPointsForValue('nyha', nyha);
                totalPoints += getPointsForValue('aodi', aodi);
                totalPoints += getPointsForValue('lvef', lvef);
                totalPoints += getPointsForValue('lvesdi', lvesdi);
                totalPoints += getPointsForValue('avsIn6Months', avsIn6Months);
                totalPoints = Math.round(totalPoints);

                document.getElementById('totalPoints').textContent = totalPoints;

                let riskCategoryKey = '';
                if (totalPoints <= 100) riskCategoryKey = 'riskLow';
                else if (totalPoints <= 200) riskCategoryKey = 'riskMedium';
                else riskCategoryKey = 'riskHigh';
                document.getElementById('riskCategory').textContent = translations[currentLanguage][riskCategoryKey];

                const survival1yr = getSurvivalRateFromPoints(totalPoints, survivalRatesMap['1yr']);
                const survival3yr = getSurvivalRateFromPoints(totalPoints, survivalRatesMap['3yr']);
                const survival5yr = getSurvivalRateFromPoints(totalPoints, survivalRatesMap['5yr']);

                document.getElementById('survival1yr').textContent = survival1yr.toFixed(1) + '%';
                document.getElementById('survival3yr').textContent = survival3yr.toFixed(1) + '%';
                document.getElementById('survival5yr').textContent = survival5yr.toFixed(1) + '%';

                updateSurvivalCurveChart(totalPoints, survival1yr, survival3yr, survival5yr);
                loader.style.display = 'none';
            }, 300);
        }

        // --- Chart Update ---
        function updateSurvivalCurveChart(totalPoints, s1, s3, s5) {
            const ctx = document.getElementById('survivalCurveChart').getContext('2d');
            const chartData = {
                labels: [
                    translations[currentLanguage].chartLabelBaseline,
                    `1 ${translations[currentLanguage].chartLabelTimeYears || 'Year'}`, // Simplified for consistency
                    `3 ${translations[currentLanguage].chartLabelTimeYears || 'Years'}`,
                    `5 ${translations[currentLanguage].chartLabelTimeYears || 'Years'}`
                ],
                datasets: [{
                    label: (translations[currentLanguage].chartTitleSurvivalPoints || "Survival Rate (Total Points: {points})").replace('{points}', totalPoints),
                    data: [100, s1, s3, s5], // Baseline is 100%
                    borderColor: '#3B82F6', // Tailwind blue-500
                    backgroundColor: 'rgba(59, 130, 246, 0.2)', // Tailwind blue-500 with opacity
                    tension: 0.1,
                    fill: true,
                    pointRadius: 5,
                    pointHoverRadius: 7,
                    pointBackgroundColor: '#3B82F6',
                }]
            };

            if (survivalCurveChart) {
                survivalCurveChart.destroy();
            }
            survivalCurveChart = new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            title: { display: true, text: translations[currentLanguage].chartLabelSurvival + ' (%)' },
                            grid: { color: currentLanguage === 'dark' ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)' },
                            ticks: { color: document.body.classList.contains('dark') ? '#E2E8F0' : '#4B5563' }
                        },
                        x: {
                            title: { display: true, text: translations[currentLanguage].chartLabelTimeYears || 'Time (Years)' },
                            grid: { display: false },
                            ticks: { color: document.body.classList.contains('dark') ? '#E2E8F0' : '#4B5563' }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { color: document.body.classList.contains('dark') ? '#E2E8F0' : '#374151' }
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // --- Language Switching ---
        function updateLanguage() {
            document.documentElement.lang = currentLanguage;
            const elements = document.querySelectorAll('[data-lang-key]');
            elements.forEach(el => {
                const key = el.getAttribute('data-lang-key');
                if (translations[currentLanguage] && translations[currentLanguage][key]) {
                    if (el.tagName === 'INPUT' && el.placeholder) {
                        el.placeholder = translations[currentLanguage][key];
                    } else if (el.tagName === 'TITLE') {
                         document.title = translations[currentLanguage][key];
                    } else {
                        el.innerHTML = translations[currentLanguage][key]; // Use innerHTML for FontAwesome icons if any
                    }
                }
            });
            // Re-render chart with new language labels if it exists and has data
            if (survivalCurveChart && document.getElementById('totalPoints').textContent !== '--') {
                 const totalPoints = parseInt(document.getElementById('totalPoints').textContent);
                 if (!isNaN(totalPoints)) {
                    const s1 = parseFloat(document.getElementById('survival1yr').textContent);
                    const s3 = parseFloat(document.getElementById('survival3yr').textContent);
                    const s5 = parseFloat(document.getElementById('survival5yr').textContent);
                    if(!isNaN(s1) && !isNaN(s3) && !isNaN(s5)){
                        updateSurvivalCurveChart(totalPoints, s1, s3, s5);
                    }
                 }
            } else {
                updateSurvivalCurveChart(0, 100, 100, 100); // Default empty chart
            }
            // Update CCI modal conditions language
            populateCciConditions();
            updateCciScoreDisplay(); // To update "CCI Total Score" text
        }


        // --- CCI Calculator Logic ---
        const cciModal = document.getElementById('cciModal');
        const openCciModalButton = document.getElementById('openCciModalButton');
        const closeCciModalButton = document.getElementById('closeCciModalButton');
        const cancelCciButton = document.getElementById('cancelCciButton');
        const applyCciButton = document.getElementById('applyCciButton');
        const cciConditionsContainer = document.getElementById('cciConditionsContainer');
        const cciScoreDisplay = document.getElementById('cciScoreDisplay');
        const cciInput = document.getElementById('cci');

        function populateCciConditions() {
            cciConditionsContainer.innerHTML = ''; // Clear previous
            Object.keys(cciConditionPoints).forEach(key => {
                const conditionName = translations[currentLanguage][key] || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                const points = cciConditionPoints[key];
                const label = document.createElement('label');
                label.className = 'flex items-center space-x-2 p-2 rounded-md hover:bg-slate-100 dark:hover:bg-slate-700 cursor-pointer';
                label.innerHTML = `
                    <input type="checkbox" data-condition="${key}" data-points="${points}" class="form-checkbox h-4 w-4 text-blue-600 border-slate-300 dark:border-slate-600 rounded bg-white dark:bg-slate-700 focus:ring-blue-500">
                    <span>${conditionName} (+${points})</span>
                `;
                cciConditionsContainer.appendChild(label);
            });
            // Add event listeners after populating
            cciConditionsContainer.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', updateCciScoreDisplay);
            });
        }

        function updateCciScoreDisplay() {
            let totalCciPoints = 0;
            cciConditionsContainer.querySelectorAll('input[type="checkbox"]:checked').forEach(checkbox => {
                totalCciPoints += parseInt(checkbox.dataset.points);
            });
            cciScoreDisplay.textContent = totalCciPoints;
             // Also update the modal title score part if it's separate
            const modalScoreTitleEl = document.querySelector('[data-lang-key="cciModalTotalScore"]');
            if(modalScoreTitleEl) { // Ensure it exists
                modalScoreTitleEl.textContent = (translations[currentLanguage].cciModalTotalScore || "CCI Total Score (excluding age):");
            }
        }

        openCciModalButton.addEventListener('click', () => cciModal.classList.remove('hidden'));
        closeCciModalButton.addEventListener('click', () => cciModal.classList.add('hidden'));
        cancelCciButton.addEventListener('click', () => cciModal.classList.add('hidden'));
        applyCciButton.addEventListener('click', () => {
            cciInput.value = cciScoreDisplay.textContent;
            cciModal.classList.add('hidden');
            validateAriseForm(); // Re-validate main form as CCI changed
        });


        // --- LVESDi Estimator Logic ---
        const toggleLvesdiEstimatorButton = document.getElementById('toggleLvesdiEstimatorButton');
        const lvesdiEstimatorSection = document.getElementById('lvesdiEstimatorSection');
        const lvesdiEstimatorIcon = document.getElementById('lvesdiEstimatorIcon');
        const calculateLvesdiButton = document.getElementById('calculateLvesdiButton');
        const lvesdiEstimationResult = document.getElementById('lvesdiEstimationResult');

        toggleLvesdiEstimatorButton.addEventListener('click', () => {
            lvesdiEstimatorSection.classList.toggle('hidden');
            lvesdiEstimatorIcon.classList.toggle('fa-chevron-down');
            lvesdiEstimatorIcon.classList.toggle('fa-chevron-up');
        });

        function validateLvesdiEstimatorForm() {
            let isValid = true;
            const fields = [
                { id: 'estimatorLvdd', min: 20, max: 100, required: true, langKey: 'labelLVDD'}, // Example ranges
                { id: 'estimatorHeight', min: 100, max: 250, required: true, langKey: 'labelHeight' },
                { id: 'estimatorWeight', min: 20, max: 250, step:0.1, required: true, langKey: 'labelWeight' }
            ];
            const mainLvef = parseFloat(document.getElementById('lvef').value);
            const lvefErrorEl = document.getElementById('estimatorLvddError'); // Use one error el for general estimator errors for now

            if(isNaN(mainLvef) || mainLvef < 5 || mainLvef > 95){
                 if(lvefErrorEl) lvefErrorEl.textContent = translations[currentLanguage].errorLVEFForEstimator || "Valid LVEF needed for estimation.";
                 isValid = false;
            } else {
                 if(lvefErrorEl) lvefErrorEl.textContent = '';
            }


            fields.forEach(field => {
                const inputElement = document.getElementById(field.id);
                const errorElement = document.getElementById(field.id + 'Error');
                if (!inputElement || !errorElement) return;

                errorElement.textContent = '';
                inputElement.classList.remove('input-error-border');
                let value = inputElement.value;

                if (field.required && !value) {
                    errorElement.textContent = translations[currentLanguage].errorRequired;
                    inputElement.classList.add('input-error-border');
                    isValid = false;
                    return;
                }
                if (value) {
                    value = parseFloat(value);
                    if (isNaN(value)) {
                        errorElement.textContent = translations[currentLanguage].errorNumber;
                        inputElement.classList.add('input-error-border');
                        isValid = false;
                        return;
                    }
                    if ((field.min !== undefined && value < field.min) || (field.max !== undefined && value > field.max)) {
                         errorElement.textContent = (translations[currentLanguage].errorRange || "Value must be between {min} and {max}.").replace('{min}',field.min).replace('{max}',field.max);
                         inputElement.classList.add('input-error-border');
                         isValid = false;
                    }
                }
            });
            return isValid;
        }

        calculateLvesdiButton.addEventListener('click', () => {
            if (!validateLvesdiEstimatorForm()) {
                lvesdiEstimationResult.textContent = translations[currentLanguage].lvesdiNotCalculated || "LVESDi not calculated or inputs invalid.";
                lvesdiEstimationResult.classList.add('text-red-500');
                return;
            }
            lvesdiEstimationResult.classList.remove('text-red-500');


            const lvef = parseFloat(document.getElementById('lvef').value); // From main form
            const lvdd_mm = parseFloat(document.getElementById('estimatorLvdd').value);
            const height_cm = parseFloat(document.getElementById('estimatorHeight').value);
            const weight_kg = parseFloat(document.getElementById('estimatorWeight').value);

            if (isNaN(lvef) || isNaN(lvdd_mm) || isNaN(height_cm) || isNaN(weight_kg)) {
                lvesdiEstimationResult.textContent = translations[currentLanguage].lvesdiNotCalculated;
                 lvesdiEstimationResult.classList.add('text-red-500');
                return;
            }

            // 1. Calculate BSA (Du Bois formula)
            // BSA (m²) = 0.007184 × Height(cm)^0.725 × Weight(kg)^0.425
            const bsa_m2 = 0.007184 * Math.pow(height_cm, 0.725) * Math.pow(weight_kg, 0.425);

            // 2. Estimate LVESD (mm)
            // LVESD³ = LVDd³ * (1 - LVEF/100)  => LVESD = (LVDd³ * (1 - LVEF/100))^(1/3)
            const lvesd_mm_cubed = Math.pow(lvdd_mm, 3) * (1 - (lvef / 100));
            const lvesd_mm = Math.cbrt(lvesd_mm_cubed);

            // 3. Calculate LVESDi (mm/m²)
            const lvesdi_estimated = lvesd_mm / bsa_m2;

            if (!isNaN(lvesdi_estimated) && isFinite(lvesdi_estimated)) {
                const finalLvesdi = parseFloat(lvesdi_estimated.toFixed(1));
                document.getElementById('lvesdi').value = finalLvesdi; // Populate main form
                lvesdiEstimationResult.textContent = (translations[currentLanguage].lvesdiCalculated || "Estimated LVESDi: {value} mm/m² (BSA: {bsa} m²)")
                    .replace('{value}', finalLvesdi)
                    .replace('{bsa}', bsa_m2.toFixed(2));
                lvesdiEstimationResult.classList.remove('text-red-500');
                validateAriseForm(); // Re-validate main form as LVESDi changed
            } else {
                lvesdiEstimationResult.textContent = translations[currentLanguage].lvesdiNotCalculated;
                lvesdiEstimationResult.classList.add('text-red-500');
            }
        });


        // --- DOMContentLoaded Initializer ---
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            const langSelector = document.getElementById('languageSelector');

            const savedLang = localStorage.getItem('preferredLanguage');
            if (savedLang && translations[savedLang]) {
                currentLanguage = savedLang;
                langSelector.value = savedLang;
            } else {
                 currentLanguage = navigator.language.toLowerCase().startsWith('zh') ? 'zh' : 'en';
                 langSelector.value = currentLanguage;
            }
            
            populateCciConditions(); // Populate CCI before first language update
            updateLanguage(); // Apply language on load

            langSelector.addEventListener('change', (event) => {
                currentLanguage = event.target.value;
                localStorage.setItem('preferredLanguage', currentLanguage);
                updateLanguage();
                // Re-validate forms with new language error messages if they were touched
                validateAriseForm();
                // No need to explicitly revalidate estimator form unless it's open and filled
            });

            document.getElementById('calculateAriseButton').addEventListener('click', calculateAriseScoreAndSurvival);
            updateSurvivalCurveChart(0, 100, 100, 100); // Initial empty chart
        });

    </script>
</body>
</html>